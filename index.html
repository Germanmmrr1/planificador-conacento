<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>An√°lisis Financiero - Restaurante ConAcento</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow-x: hidden;
            overflow-y: auto;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section.full-width {
            grid-column: 1 / -1;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .section h3 {
            color: #764ba2;
            margin: 20px 0 15px 0;
            font-size: 1.3em;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .input-group input[type="number"],
        .input-group input[type="range"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-group input[type="number"]:focus {
            border-color: #667eea;
            outline: none;
        }

        .input-group input[type="range"] {
            padding: 0;
            height: 8px;
            background: #ddd;
            border: none;
            cursor: pointer;
        }

        .input-group input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: #667eea;
            border-radius: 50%;
            cursor: pointer;
        }

        .range-value {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 10px;
        }

        .tabs-container {
            display: flex;
            gap: 10px;
            padding: 0 30px;
            margin-top: -10px;
            background: white;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-button {
            padding: 15px 30px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab-button:hover {
            color: #667eea;
            background: #f8f9fa;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-button-special {
            color: #ff6b35 !important;
        }

        .tab-button-special:hover {
            color: #ff8c61 !important;
            background: #fff5f2 !important;
        }

        .tab-button-special.active {
            color: #ff6b35 !important;
            border-bottom-color: #ff6b35 !important;
        }

        .tab-content {
            display: none !important;
        }

        .tab-content.active {
            display: block !important;
        }

        .tab-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .variables-grid {
            grid-template-columns: repeat(3, 1fr);
        }

        .result-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .result-card h4 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .result-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .result-card.positive .value {
            color: #28a745;
        }

        .result-card.negative .value {
            color: #dc3545;
        }

        .financial-flow {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .flow-item {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 20px;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            background: #f8f9fa;
            align-items: center;
            border-left: 5px solid #667eea;
        }

        .flow-item.revenue {
            border-left-color: #28a745;
            background: #e8f5e9;
        }

        .flow-item.expense {
            border-left-color: #dc3545;
            background: #ffebee;
        }

        .flow-item.margin {
            border-left-color: #17a2b8;
            background: #e0f7fa;
        }

        .flow-item.result {
            border-left-color: #667eea;
            background: #e8eaf6;
            font-size: 1.1em;
            font-weight: bold;
            border-width: 8px;
        }

        .flow-item.result.positive {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .flow-item.result.negative {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .flow-label {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
        }

        .flow-operator {
            font-size: 1.5em;
            font-weight: bold;
            color: #666;
        }

        .flow-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
            text-align: right;
        }

        .flow-item.result .flow-value {
            font-size: 1.8em;
        }

        .employee-list {
            display: grid;
            gap: 15px;
        }

        .employee-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 40px;
            gap: 15px;
            align-items: center;
        }

        .expand-btn {
            background: #667eea;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            transition: all 0.3s;
        }

        .expand-btn:hover {
            background: #5568d3;
            transform: scale(1.1);
        }

        .employee-detail {
            display: none;
            grid-column: 1 / -1;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .employee-detail.show {
            display: block;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .detail-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .detail-item label {
            display: block;
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .detail-item .value {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }

        .employee-item input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 0.95em;
            text-align: center;
        }

        .employee-item input:focus {
            border-color: #667eea;
            outline: none;
        }

        .employee-item .name {
            font-weight: bold;
            color: #333;
        }

        .employee-item .cost-display {
            text-align: center;
            font-weight: 600;
            color: #dc3545;
            font-size: 1.05em;
        }

        .employee-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .mobile-label {
            display: none;
            font-size: 0.8em;
            color: #667eea;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }

        /* Responsive Design - Tablets y m√≥viles grandes */
        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .employee-item {
                grid-template-columns: 1fr;
            }

            .tab-grid {
                grid-template-columns: 1fr;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            .monthly-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .bulk-controls {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Responsive Design - M√≥viles (iPhone y similares) */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .container {
                border-radius: 10px;
            }

            header {
                padding: 20px 15px;
            }

            header h1 {
                font-size: 1.5em;
                margin-bottom: 5px;
            }

            header p {
                font-size: 0.85em;
            }

            .tabs-container {
                padding: 0 10px;
                gap: 5px;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none; /* Firefox */
                -ms-overflow-style: none; /* IE/Edge */
            }

            .tabs-container::-webkit-scrollbar {
                display: none; /* Chrome/Safari */
            }

            .tab-button {
                padding: 10px 12px;
                font-size: 0.8em;
                flex-shrink: 0;
            }

            .tab-grid,
            .main-content {
                padding: 10px;
                gap: 10px;
            }

            #tab-planificacion > div,
            #tab-salarios > div,
            #tab-gastos > div,
            #tab-resultados > div {
                padding: 10px !important;
            }

            .section {
                padding: 12px;
            }

            .section h2 {
                font-size: 1.2em;
                margin-bottom: 12px;
                padding-bottom: 8px;
            }

            .section.full-width {
                margin-top: 15px !important;
            }

            .month-section {
                margin-bottom: 12px;
            }

            .month-header {
                padding: 12px;
            }

            .month-header-top {
                margin-bottom: 10px;
            }

            .month-header h3 {
                font-size: 1.1em;
                margin: 0;
            }

            .month-content {
                padding: 12px;
                overflow-x: auto;
            }

            /* Month summary - 3 columnas en m√≥vil */
            .month-summary {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
                font-size: 0.75em;
            }

            .month-summary-item {
                text-align: center;
                padding: 6px 4px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 4px;
            }

            .month-summary-item label {
                font-size: 0.8em;
                white-space: nowrap;
                display: block;
                margin-bottom: 3px;
            }

            .month-summary-item .value {
                font-size: 1.1em;
                font-weight: bold;
                display: block;
            }

            /* Calendar grid - 7 columnas con scroll horizontal */
            .calendar-grid {
                gap: 3px;
                font-size: 0.75em;
                grid-template-columns: repeat(7, 1fr);
                min-width: 500px;
                overflow: visible;
            }

            .calendar-header {
                padding: 5px 2px;
                font-size: 0.65em;
            }

            .day-cell {
                padding: 4px;
                min-height: auto;
            }

            .day-date {
                font-size: 0.8em;
                margin-bottom: 3px;
                flex-direction: column;
                gap: 1px;
            }

            .day-date span:first-child {
                font-size: 1.1em;
            }

            .day-name {
                font-size: 0.6em;
            }

            .day-controls {
                margin-top: 4px;
            }

            .day-controls label {
                font-size: 0.65em;
                margin-bottom: 2px;
            }

            .day-controls input[type="number"] {
                padding: 4px;
                font-size: 0.75em;
                min-height: 32px;
            }

            .day-controls input[type="range"] {
                height: 32px;
            }

            .occupancy-display {
                font-size: 0.7em;
                margin-top: 2px;
            }

            .day-info {
                margin-top: 4px;
                padding-top: 4px;
                font-size: 0.65em;
            }

            .day-info span:first-child {
                font-size: 0.75em !important;
            }

            .day-info span:last-child {
                font-size: 0.65em !important;
            }

            .toggle-switch {
                flex-direction: row;
                align-items: center;
                justify-content: center;
                gap: 4px;
                margin-bottom: 5px;
            }

            .toggle-switch span {
                font-size: 0.65em;
            }

            .switch {
                width: 36px;
                height: 18px;
            }

            .slider:before {
                height: 14px;
                width: 14px;
                left: 2px;
                bottom: 2px;
            }

            input:checked + .slider:before {
                transform: translateX(18px);
            }

            /* Bulk controls - 1 columna en m√≥vil */
            .bulk-controls {
                grid-template-columns: 1fr;
                gap: 8px;
                padding: 10px;
            }

            .bulk-btn {
                padding: 10px;
                font-size: 0.85em;
            }

            /* Monthly stats - 1 columna en m√≥vil */
            .monthly-stats {
                grid-template-columns: 1fr;
                gap: 8px;
                padding: 12px;
                margin-top: 12px;
            }

            .stat-box {
                padding: 10px;
            }

            .stat-box label {
                font-size: 0.75em;
                margin-bottom: 5px;
            }

            .stat-box .value {
                font-size: 1.1em;
            }

            /* Employee list */
            .employee-item {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 12px;
            }

            .employee-header {
                display: none !important;
            }

            .employee-item .name {
                font-size: 1.05em;
                margin-bottom: 5px;
            }

            .employee-item input {
                width: 100%;
            }

            .mobile-label {
                display: block;
            }

            .employee-field {
                width: 100%;
            }

            .expand-btn {
                width: 100%;
                height: auto;
                padding: 10px;
                border-radius: 6px;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }

            /* Results grid */
            .results-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .variables-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .input-group {
                margin-bottom: 15px;
            }

            .input-group label {
                font-size: 0.9em;
            }

            .range-value {
                font-size: 0.9em;
                padding: 4px 12px;
            }

            .tooltip-icon {
                width: 18px;
                height: 18px;
                line-height: 18px;
                font-size: 12px;
            }

            /* Financial flow */
            .flow-item {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 15px;
            }

            .flow-operator {
                text-align: center;
                font-size: 1.2em;
            }

            .flow-value {
                text-align: left;
                font-size: 1.2em;
            }

            .flow-item.result .flow-value {
                font-size: 1.4em;
            }

            /* Chart container */
            .chart-container {
                height: 300px;
            }

            /* Tooltips - ajustar para m√≥vil */
            .tooltip-icon:hover::after {
                min-width: 250px;
                font-size: 12px;
                left: auto;
                right: 0;
                transform: none;
            }

            .tooltip-icon:hover::before {
                left: auto;
                right: 10px;
                transform: none;
            }

            /* Table responsive */
            #monthly-results-table {
                font-size: 0.8em;
            }

            #monthly-results-table th,
            #monthly-results-table td {
                padding: 8px 4px;
            }

            /* Info boxes */
            .info-box,
            .info-box-inline {
                padding: 12px;
                font-size: 0.9em;
            }

            /* Inputs m√°s grandes para touch */
            input[type="number"],
            input[type="range"],
            button {
                min-height: 44px; /* Apple HIG recomendaci√≥n */
            }

            input[type="range"] {
                height: 44px; /* √Årea t√°ctil m√°s grande */
            }
        }

        /* M√≥viles peque√±os (iPhone SE, etc) */
        @media (max-width: 375px) {
            body {
                padding: 3px;
            }

            header {
                padding: 15px 10px;
            }

            header h1 {
                font-size: 1.3em;
            }

            header p {
                font-size: 0.75em;
            }

            .tab-button {
                padding: 8px 10px;
                font-size: 0.75em;
            }

            .section {
                padding: 10px;
            }

            .section h2 {
                font-size: 1.1em;
                margin-bottom: 10px;
            }

            .month-summary {
                grid-template-columns: repeat(3, 1fr);
                gap: 4px;
                font-size: 0.7em;
            }

            .month-summary-item {
                padding: 4px 2px;
            }

            .month-summary-item label {
                font-size: 0.75em;
            }

            .month-summary-item .value {
                font-size: 1em;
            }

            .month-header {
                padding: 10px;
            }

            .month-header-top {
                margin-bottom: 8px;
            }

            .month-header h3 {
                font-size: 1em;
            }

            .calendar-grid {
                gap: 2px;
                grid-template-columns: repeat(7, 1fr);
                min-width: 450px;
            }

            .calendar-header {
                padding: 4px 1px;
                font-size: 0.55em;
            }

            .day-cell {
                padding: 3px;
                font-size: 0.7em;
            }

            .day-date {
                font-size: 0.75em;
                margin-bottom: 2px;
            }

            .day-date span:first-child {
                font-size: 1em;
            }

            .day-controls label {
                font-size: 0.6em;
            }

            .day-controls input[type="number"] {
                padding: 3px;
                font-size: 0.7em;
                min-height: 28px;
            }

            .day-controls input[type="range"] {
                height: 28px;
            }

            .occupancy-display {
                font-size: 0.65em;
            }

            .day-info {
                font-size: 0.6em;
                margin-top: 3px;
                padding-top: 3px;
            }

            .day-info span:first-child {
                font-size: 0.7em !important;
            }

            .day-info span:last-child {
                font-size: 0.6em !important;
            }

            .switch {
                width: 32px;
                height: 16px;
            }

            .slider:before {
                height: 12px;
                width: 12px;
            }

            input:checked + .slider:before {
                transform: translateX(16px);
            }

            .flow-label {
                font-size: 0.9em;
            }

            .flow-value {
                font-size: 1em;
            }

            .flow-item.result .flow-value {
                font-size: 1.2em;
            }

            .stat-box label {
                font-size: 0.7em;
            }

            .stat-box .value {
                font-size: 1em;
            }
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .info-box strong {
            color: #667eea;
        }

        .tooltip-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: help;
            margin-left: 8px;
            position: relative;
        }

        .tooltip-icon:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 18px;
            border-radius: 8px;
            white-space: pre-line;
            font-size: 13px;
            font-weight: normal;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            min-width: 320px;
            text-align: left;
            line-height: 1.8;
        }

        .tooltip-icon:hover::before {
            content: '';
            position: absolute;
            bottom: 22px;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: #333;
            z-index: 1000;
        }

        .info-box-inline {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-size: 0.95em;
        }

        .info-box-inline strong {
            color: #856404;
        }

        /* Planificaci√≥n Detallada Styles */
        .month-section {
            background: white;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: visible;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .month-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .month-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .month-header:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a91 100%);
        }

        .month-header h3 {
            margin: 0;
            color: white;
            font-size: 1.4em;
        }

        .month-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            font-size: 0.95em;
        }

        .month-summary-item {
            text-align: center;
        }

        .month-summary-item label {
            display: block;
            font-size: 0.85em;
            opacity: 0.9;
            margin-bottom: 3px;
        }

        .month-summary-item .value {
            font-weight: bold;
            font-size: 1.1em;
        }

        .month-content {
            display: none;
            padding: 25px;
            background: #f8f9fa;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .month-content.expanded {
            display: block;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .calendar-header {
            font-weight: bold;
            text-align: center;
            padding: 10px;
            background: #667eea;
            color: white;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .day-cell {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .day-cell:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .day-cell.closed {
            background: #f0f0f0;
            opacity: 0.6;
        }

        .day-cell.open {
            background: #e8f5e9;
        }

        .day-date {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 8px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .day-name {
            font-size: 0.75em;
            color: #666;
            text-transform: uppercase;
        }

        .day-controls {
            margin-top: 10px;
        }

        .day-controls label {
            display: block;
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }

        .day-controls input[type="range"] {
            width: 100%;
            height: 6px;
        }

        .day-controls input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .day-controls input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            text-align: center;
            font-size: 0.9em;
            font-weight: bold;
        }

        .day-controls input[type="number"]:focus {
            border-color: #667eea;
            outline: none;
        }

        .occupancy-display {
            font-weight: bold;
            color: #667eea;
            font-size: 0.9em;
            text-align: center;
            margin-top: 5px;
        }

        .shifts-display {
            font-weight: bold;
            color: #28a745;
            font-size: 0.85em;
            text-align: center;
            margin-top: 5px;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #28a745;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .bulk-controls {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .bulk-btn {
            padding: 10px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .bulk-btn:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .monthly-stats {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }

        .stat-box {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .stat-box label {
            display: block;
            font-size: 0.85em;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .stat-box .value {
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
        }

        .stat-box.revenue {
            border-left-color: #28a745;
        }

        .stat-box.revenue .value {
            color: #28a745;
        }

        .stat-box.expense {
            border-left-color: #dc3545;
        }

        .stat-box.expense .value {
            color: #dc3545;
        }

        .stat-box.result {
            border-left-color: #667eea;
        }

        .expand-icon {
            transition: transform 0.3s;
        }

        .expand-icon.rotated {
            transform: rotate(180deg);
        }

        .day-info {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(102, 126, 234, 0.2);
            text-align: center;
        }

        /* Mobile-friendly Modal */
        .mobile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }

        .mobile-modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            font-size: 1.4em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-input-group {
            margin-bottom: 20px;
        }

        .modal-input-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .modal-input-group input,
        .modal-input-group select {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px; /* Prevents zoom on iOS */
            transition: border-color 0.3s;
        }

        .modal-input-group input:focus,
        .modal-input-group select:focus {
            border-color: #667eea;
            outline: none;
        }

        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-btn {
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 48px;
        }

        .modal-btn-primary {
            background: #667eea;
            color: white;
        }

        .modal-btn-primary:active {
            background: #5568d3;
            transform: scale(0.98);
        }

        .modal-btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .modal-btn-secondary:active {
            background: #d0d0d0;
            transform: scale(0.98);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Touch-friendly tooltips */
        .tooltip-trigger {
            position: relative;
            display: inline-block;
        }

        .tooltip-content {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.6;
            z-index: 9999;
            max-width: 90vw;
            width: 320px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            animation: slideUp 0.2s ease;
        }

        .tooltip-content.active {
            display: block;
        }

        .tooltip-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 9998;
        }

        .tooltip-overlay.active {
            display: block;
        }

        /* Sticky header on mobile */
        @media (max-width: 768px) {
            header {
                position: sticky;
                top: 0;
                z-index: 100;
            }

            .tabs-container {
                position: sticky;
                top: 85px; /* Height of header on mobile */
                z-index: 99;
                background: white;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            /* Better touch targets */
            button, .btn, .bulk-btn, .modal-btn, .expand-btn {
                min-height: 48px;
                min-width: 48px;
            }

            /* Improve calendar for mobile - make it full width */
            .calendar-grid {
                min-width: 100% !important;
                overflow: visible;
            }

            .day-cell {
                min-height: 140px;
            }
            
            /* Tabla de empleados responsive */
            .employee-header {
                display: none !important;
            }
            
            .employee-item {
                display: flex !important;
                flex-direction: column !important;
                gap: 10px !important;
                padding: 15px !important;
            }
            
            .employee-item > div {
                display: flex;
                flex-direction: column;
                gap: 5px;
            }
            
            .employee-item > div[data-label]::before {
                content: attr(data-label) ": ";
                font-weight: 600;
                color: #667eea;
                font-size: 0.85em;
                margin-bottom: 5px;
                display: block;
            }
            
            .employee-item > div[data-label] {
                width: 100%;
            }
            
            /* Tabla de empleados responsive */
            .employee-header {
                display: none !important;
            }
            
            .employee-item {
                display: block !important;
                padding: 15px !important;
                margin-bottom: 15px;
                border: 1px solid #ddd;
                border-radius: 8px;
            }
            
            .employee-item > div {
                margin-bottom: 10px;
            }
            
            .employee-item > div[data-label]::before {
                content: attr(data-label) ": ";
                display: block;
                font-weight: 600;
                color: #667eea;
                margin-bottom: 5px;
                font-size: 0.9em;
            }
            
            .employee-item > div[data-label] {
                width: 100%;
            }

            /* Swipe indicator */
            .swipe-indicator {
                text-align: center;
                padding: 8px;
                color: #999;
                font-size: 0.85em;
                background: rgba(102, 126, 234, 0.05);
                border-radius: 8px;
                margin-bottom: 12px;
            }
        }

        /* Active state for better touch feedback */
        .day-cell:active {
            transform: scale(0.98);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .bulk-btn:active,
        .tab-button:active {
            transform: scale(0.97);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>An√°lisis Financiero - Restaurante ConAcento</h1>
            <p>Herramienta interactiva para proyecci√≥n de ingresos y gastos</p>
        </header>

        <!-- Tabs Navigation -->
        <div class="tabs-container">
            <button class="tab-button active" onclick="switchTab('planificacion', this)">Planificaci√≥n y Variables</button>
            <button class="tab-button" onclick="switchTab('salarios', this)">Personal y Salarios</button>
            <button class="tab-button" onclick="switchTab('gastos', this)">Gastos Operativos</button>
            <button class="tab-button" onclick="switchTab('resultados', this)">Resultados</button>
            <button class="tab-button tab-button-special" onclick="switchTab('escenarios', this)">Escenarios Men√∫</button>
            <button class="tab-button" onclick="switchTab('menu-admin', this)">Administrar Men√∫</button>
        </div>

        <!-- Tab: Planificaci√≥n y Variables (Merged) -->
        <div id="tab-planificacion" class="tab-content active" style="display: block !important;">
            <div style="padding: 30px;">
                <!-- Variables Section -->
                <div class="section full-width">
                    <h2>Variables de Venta</h2>
                    <div class="results-grid variables-grid">
                        <div class="input-group">
                            <label>
                                Capacidad Total (comensales): <span class="range-value" id="capacidad-value">75</span>
                                <span class="tooltip-icon" data-tooltip="40 plazas en terraza + 50 plazas aprox. en interior" onclick="showTooltip(this.getAttribute('data-tooltip'), this)">i</span>
                            </label>
                            <input type="range" id="capacidad" min="40" max="120" value="75" step="5" oninput="updateAllCalculations()">
                        </div>

                        <div class="input-group">
                            <label>Ticket Medio (‚Ç¨): <span class="range-value" id="ticket-value">35</span></label>
                            <input type="range" id="ticket" min="20" max="60" value="35" step="1" oninput="updateAllCalculations()">
                        </div>

                        <div class="input-group">
                            <label>
                                Aprovisionamiento (% sobre ventas): <span class="range-value" id="aprovisionamiento-value">40</span>
                                <span class="tooltip-icon" data-tooltip="35% es el hist√≥rico de Leo y est√° en l√≠nea con el sector" onclick="showTooltip(this.getAttribute('data-tooltip'), this)">i</span>
                            </label>
                            <input type="range" id="aprovisionamiento" min="25" max="45" value="40" step="1" oninput="updateAllCalculations()">
                        </div>
                    </div>
                </div>

                <!-- Planning Section -->
                <div class="section full-width" style="margin-top: 30px;">
                    <h2>Planificaci√≥n Detallada por D√≠a</h2>
                    <div class="info-box">
                        <strong>Instrucciones:</strong> Expande cada mes para ver el calendario completo. Marca los d√≠as abiertos/cerrados y ajusta la ocupaci√≥n prevista para cada d√≠a. Los c√°lculos se actualizar√°n autom√°ticamente.
                    </div>

                    <div id="planning-months-container">
                        <!-- Los meses se generar√°n din√°micamente aqu√≠ -->
                    </div>

                    <!-- Resumen de Tesorer√≠a -->
                    <div style="margin-top: 30px;">
                        <h2>Flujo de Tesorer√≠a Acumulado</h2>
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="treasuryChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Escenarios Men√∫ -->
        <div id="tab-escenarios" class="tab-content">
            <div style="padding: 30px;">
                <!-- Menu Simulator Section -->
                <div class="section full-width">
                    <h2>Simulador de Escenarios de Men√∫</h2>
                    <div class="info-box">
                        <strong>Instrucciones:</strong> Introduce el n√∫mero de clientes y selecciona el tipo de persona para generar un men√∫ basado en patrones de consumo. Puedes a√±adir o quitar platos y ver el ticket medio, coste y margen.
                    </div>

                    <!-- Mode Selector -->
                    <div style="display: flex; gap: 10px; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <button id="mode-single" class="mode-button active" onclick="switchMode('single')" style="flex: 1; padding: 12px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            Crear Escenario
                        </button>
                        <button id="mode-compare" class="mode-button" onclick="switchMode('saved')" style="flex: 1; padding: 12px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            Escenarios Guardados
                        </button>
                    </div>

                    <!-- Single Mode -->
                    <div id="single-mode-container">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <div>
                            <label style="font-weight: bold; margin-bottom: 10px; display: block;">N√∫mero de Clientes:</label>
                            <input type="number" id="client-count" min="1" max="20" value="2" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px;" onchange="updateScenarioInputs()">
                        </div>
                        <div>
                            <label style="font-weight: bold; margin-bottom: 10px; display: block;">Tipo de Persona:</label>
                            <select id="persona-type" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px;" onchange="updateScenarioInputs()">
                                <option value="">-- Selecciona tipo de persona --</option>
                                <option value="tapeadores">üçΩÔ∏è Los Tapeadores (Comparten raciones)</option>
                                <option value="steaklovers">ü•© Los Steak Lovers (Premium, carnes)</option>
                                <option value="valuehunters">üí∏ Los Value Hunters (Precio contenido)</option>
                                <option value="foodies">üç∑ Los Foodies Experienciales</option>
                                <option value="familias">üë®‚Äçüë©‚Äçüëß Las Familias Tradicionales</option>
                                <option value="grupos">ü•Ç Los Grupos Sociales</option>
                                <option value="festivos">üéâ Los Festivos / Ocasi√≥n Especial</option>
                            </select>
                        </div>
                    </div>

                    <div style="margin-top: 15px;">
                        <button onclick="generateRandomMenu()" style="padding: 12px 24px; background: #ff6b35; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s;">
                            üé≤ Generar Men√∫ Aleatorio
                        </button>
                        <span style="font-size: 14px; color: #666; margin-left: 10px;">Crea una combinaci√≥n aleatoria de platos para el grupo seleccionado</span>
                    </div>

                    <div id="menu-selection" style="margin-top: 30px; display: none;">
                        <h3>Pedido del Grupo</h3>
                        <div id="selected-items" style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <!-- Items will be added here -->
                        </div>

                        <div style="margin-top: 20px;">
                            <h4>A√±adir m√°s platos:</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label>Categor√≠a:</label>
                                    <select id="add-category" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;" onchange="updateItemSelect()">
                                        <option value="">-- Selecciona categor√≠a --</option>
                                        <optgroup label="Comida">
                                            <option value="aperitivos">Aperitivos</option>
                                            <option value="entrantes">Entrantes</option>
                                            <option value="ensaladas">Ensaladas</option>
                                            <option value="carnes">Carnes</option>
                                            <option value="guarniciones">Guarniciones</option>
                                            <option value="postres">Postres</option>
                                        </optgroup>
                                        <optgroup label="Vinos">
                                            <option value="vinosblancos">Vinos Blancos</option>
                                            <option value="vinosrosados">Vinos Rosados</option>
                                            <option value="vinostintos">Vinos Tintos</option>
                                            <option value="espumosos">Espumosos & Champagne</option>
                                        </optgroup>
                                        <optgroup label="Otras Bebidas">
                                            <option value="aperitivos_bebidas">Aperitivos (Finos, Vermut...)</option>
                                            <option value="cervezas">Cervezas</option>
                                            <option value="refrescos">Refrescos</option>
                                            <option value="zumos">Zumos</option>
                                            <option value="aguas">Aguas</option>
                                            <option value="cafes">Caf√©s</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div>
                                    <label>Plato:</label>
                                    <select id="add-item" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                                        <option value="">-- Selecciona plato --</option>
                                    </select>
                                </div>
                            </div>
                            <button onclick="addItem()" style="margin-top: 10px; padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                                A√±adir Plato
                            </button>
                        </div>

                        <div style="margin-top: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white;">
                            <h3 style="margin-top: 0; color: white;">Resumen del Escenario</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 14px; opacity: 0.9;">Personas</div>
                                    <div style="font-size: 24px; font-weight: bold;" id="summary-people">0</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 14px; opacity: 0.9;">Ticket Total</div>
                                    <div style="font-size: 24px; font-weight: bold;" id="summary-total">0‚Ç¨</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 14px; opacity: 0.9;">Ticket Medio/Persona</div>
                                    <div style="font-size: 24px; font-weight: bold;" id="summary-avg">0‚Ç¨</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 14px; opacity: 0.9;">Coste Total</div>
                                    <div style="font-size: 24px; font-weight: bold;" id="summary-cost">0‚Ç¨</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 14px; opacity: 0.9;">Margen Bruto</div>
                                    <div style="font-size: 24px; font-weight: bold;" id="summary-margin">0‚Ç¨</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 14px; opacity: 0.9;">% Margen</div>
                                    <div style="font-size: 24px; font-weight: bold;" id="summary-margin-pct">0%</div>
                                </div>
                            </div>
                        </div>

                        <!-- Save Scenario Section -->
                        <div id="save-scenario-section" style="display: none; margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white;">
                            <h3 style="margin: 0 0 15px 0; font-size: 18px;">Guardar Este Escenario</h3>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="scenario-name" placeholder="Nombre del escenario (ej: Cena rom√°ntica, Comida familiar...)" style="flex: 1; padding: 12px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; border-radius: 6px; font-size: 14px;" />
                                <button onclick="saveCurrentScenario()" style="padding: 12px 24px; background: white; color: #667eea; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.3s;">
                                    Guardar
                                </button>
                            </div>
                            <div style="margin-top: 10px; font-size: 13px; opacity: 0.9;">
                                Guarda este escenario para compararlo m√°s tarde con otros
                            </div>
                        </div>
                    </div>
                    </div> <!-- End single-mode-container -->

                    <!-- Saved Scenarios Mode -->
                    <div id="compare-mode-container" style="display: none; margin-top: 20px;">
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 15px 0;">Mis Escenarios Guardados</h3>
                            <div id="saved-scenarios-list">
                                <!-- Saved scenarios will be rendered here -->
                            </div>
                        </div>

                        <div id="comparison-results" style="margin-top: 30px;">
                            <!-- Comparison table will be added here -->
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Tab: Administrar Men√∫ -->
        <div id="tab-menu-admin" class="tab-content">
            <div style="padding: 30px;">
                <div class="section full-width">
                    <h2>Administrar Men√∫</h2>

                    <!-- Sub-tabs for Menu Admin -->
                    <div style="display: flex; gap: 10px; margin: 20px 0; border-bottom: 2px solid #ddd;">
                        <button id="menu-tab-products" class="menu-sub-tab active" onclick="switchMenuTab('products')" style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid #667eea; color: #667eea; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            Productos
                        </button>
                        <button id="menu-tab-rules" class="menu-sub-tab" onclick="switchMenuTab('rules')" style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid transparent; color: #666; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            Reglas de Simulaci√≥n
                        </button>
                        <button id="menu-tab-history" class="menu-sub-tab" onclick="switchMenuTab('history')" style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid transparent; color: #666; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            Historial
                        </button>
                    </div>

                    <!-- Products Tab Content -->
                    <div id="menu-content-products" class="menu-tab-content">
                        <div class="info-box">
                            Aqu√≠ puedes editar los productos del men√∫, filtrar por categor√≠as y buscar por nombre. Haz clic en cualquier campo para editarlo directamente.
                        </div>

                        <!-- Controls -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto auto; gap: 15px; margin: 20px 0; align-items: end;">
                        <div>
                            <label style="font-weight: bold; margin-bottom: 5px; display: block;">Buscar por nombre:</label>
                            <input type="text" id="menu-search" placeholder="Buscar producto..." style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #ddd; border-radius: 8px;" oninput="filterMenuItems()">
                        </div>
                        <div>
                            <label style="font-weight: bold; margin-bottom: 5px; display: block;">Filtrar por categor√≠a:</label>
                            <select id="menu-category-filter" style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #ddd; border-radius: 8px;" onchange="filterMenuItems()">
                                <option value="">Todas las categor√≠as</option>
                                <optgroup label="Comida">
                                    <option value="aperitivos">Aperitivos</option>
                                    <option value="entrantes">Entrantes</option>
                                    <option value="ensaladas">Ensaladas</option>
                                    <option value="carnes">Carnes</option>
                                    <option value="guarniciones">Guarniciones</option>
                                    <option value="postres">Postres</option>
                                </optgroup>
                                <optgroup label="Vinos">
                                    <option value="vinosblancos">Vinos Blancos</option>
                                    <option value="vinosrosados">Vinos Rosados</option>
                                    <option value="vinostintos">Vinos Tintos</option>
                                    <option value="espumosos">Espumosos</option>
                                </optgroup>
                                <optgroup label="Otras Bebidas">
                                    <option value="aperitivos_bebidas">Aperitivos (Bebidas)</option>
                                    <option value="cervezas">Cervezas</option>
                                    <option value="refrescos">Refrescos</option>
                                    <option value="zumos">Zumos</option>
                                    <option value="aguas">Aguas</option>
                                    <option value="cafes">Caf√©s</option>
                                </optgroup>
                            </select>
                        </div>
                        <div>
                            <button onclick="openAddProductModal()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; white-space: nowrap;">
                                ‚ûï A√±adir Producto
                            </button>
                        </div>
                        <div>
                            <button onclick="downloadMenuCSV()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; white-space: nowrap;">
                                üì• Descargar CSV
                            </button>
                        </div>
                    </div>

                    <!-- Bulk Edit Panel -->
                    <div id="bulk-edit-panel" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">Edici√≥n Masiva - <span id="selected-count">0</span> productos seleccionados</h3>
                            <button onclick="clearSelection()" style="padding: 8px 16px; background: white; color: #667eea; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                Limpiar Selecci√≥n
                            </button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 6px;">
                                <label style="font-weight: bold; display: block; margin-bottom: 8px;">Ajustar Precio:</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="number" id="price-adjustment" placeholder="%" step="1" style="flex: 1; padding: 8px; border: none; border-radius: 4px; font-size: 14px;">
                                    <button onclick="applyBulkPriceAdjustment()" style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                                        Aplicar %
                                    </button>
                                </div>
                                <small style="opacity: 0.9; display: block; margin-top: 4px;">Ej: 10 = +10%, -5 = -5%</small>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 6px;">
                                <label style="font-weight: bold; display: block; margin-bottom: 8px;">Ajustar Coste:</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="number" id="cost-adjustment" placeholder="%" step="1" style="flex: 1; padding: 8px; border: none; border-radius: 4px; font-size: 14px;">
                                    <button onclick="applyBulkCostAdjustment()" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                                        Aplicar %
                                    </button>
                                </div>
                                <small style="opacity: 0.9; display: block; margin-top: 4px;">Ej: 10 = +10%, -5 = -5%</small>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 6px;">
                                <label style="font-weight: bold; display: block; margin-bottom: 8px;">Margen Target:</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="number" id="margin-target" placeholder="%" min="0" max="100" step="1" style="flex: 1; padding: 8px; border: none; border-radius: 4px; font-size: 14px;">
                                    <button onclick="applyBulkMarginTarget()" style="padding: 8px 12px; background: #ffc107; color: #333; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                                        Calcular
                                    </button>
                                </div>
                                <small style="opacity: 0.9; display: block; margin-top: 4px;">Ajusta precio seg√∫n margen</small>
                            </div>
                        </div>
                    </div>

                    <!-- Menu Items Table -->
                    <div id="menu-items-container" style="margin-top: 20px;">
                        <!-- Will be filled dynamically -->
                    </div>
                    </div> <!-- End Products Tab Content -->

                    <!-- Rules Tab Content -->
                    <div id="menu-content-rules" class="menu-tab-content" style="display: none;">
                        <div class="info-box">
                            Define reglas estrictas que se aplicar√°n al crear escenarios. Los usuarios no podr√°n a√±adir productos que violen estas reglas.
                        </div>

                        <!-- Add Rule Button -->
                        <div style="margin: 20px 0;">
                            <button onclick="openAddRuleModal()" style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                ‚ûï A√±adir Nueva Regla
                            </button>
                        </div>

                        <!-- Rules Table -->
                        <div id="rules-container" style="margin-top: 20px;">
                            <!-- Will be filled dynamically -->
                        </div>
                    </div> <!-- End Rules Tab Content -->

                    <!-- History Tab Content -->
                    <div id="menu-content-history" class="menu-tab-content" style="display: none;">
                        <div class="info-box">
                            Historial completo de cambios en productos del men√∫: ediciones, a√±adidos y eliminaciones.
                        </div>

                        <!-- History Filters -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 20px 0;">
                            <div>
                                <label style="font-weight: bold; display: block; margin-bottom: 5px;">Filtrar por acci√≥n:</label>
                                <select id="history-action-filter" onchange="filterHistory()" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                                    <option value="">Todas las acciones</option>
                                    <option value="edit">Ediciones</option>
                                    <option value="add">A√±adidos</option>
                                    <option value="delete">Eliminados</option>
                                    <option value="bulk_edit">Edici√≥n Masiva</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-weight: bold; display: block; margin-bottom: 5px;">Filtrar por categor√≠a:</label>
                                <select id="history-category-filter" onchange="filterHistory()" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                                    <option value="">Todas las categor√≠as</option>
                                    <optgroup label="Comida">
                                        <option value="aperitivos">Aperitivos</option>
                                        <option value="entrantes">Entrantes</option>
                                        <option value="ensaladas">Ensaladas</option>
                                        <option value="carnes">Carnes</option>
                                        <option value="guarniciones">Guarniciones</option>
                                        <option value="postres">Postres</option>
                                    </optgroup>
                                    <optgroup label="Vinos">
                                        <option value="vinosblancos">Vinos Blancos</option>
                                        <option value="vinosrosados">Vinos Rosados</option>
                                        <option value="vinostintos">Vinos Tintos</option>
                                        <option value="espumosos">Espumosos</option>
                                    </optgroup>
                                    <optgroup label="Otras Bebidas">
                                        <option value="aperitivos_bebidas">Aperitivos (Bebidas)</option>
                                        <option value="cervezas">Cervezas</option>
                                        <option value="refrescos">Refrescos</option>
                                        <option value="zumos">Zumos</option>
                                        <option value="aguas">Aguas</option>
                                        <option value="cafes">Caf√©s</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div>
                                <label style="font-weight: bold; display: block; margin-bottom: 5px;">Buscar producto:</label>
                                <input type="text" id="history-search" placeholder="Nombre del producto..." oninput="filterHistory()" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                            </div>
                        </div>

                        <!-- History Table -->
                        <div id="history-container" style="margin-top: 20px;">
                            <!-- Will be filled dynamically -->
                        </div>
                    </div> <!-- End History Tab Content -->

                </div>
            </div>
        </div>

        <!-- Tab: Personal y Salarios -->
        <div id="tab-salarios" class="tab-content">
            <div style="padding: 30px;">
                <div class="section full-width">
                    <h2>Personal y Salarios</h2>

                    <div class="employee-header" style="display: grid; grid-template-columns: 1.5fr 2fr 0.8fr 0.8fr 0.8fr 1fr 1fr 60px; gap: 10px; padding: 12px 15px; font-weight: 600; color: #667eea; border-bottom: 2px solid #667eea; margin-bottom: 15px; background: #f8f9fa; border-radius: 8px 8px 0 0;">
                        <div>Nombre</div>
                        <div>Puesto</div>
                        <div style="text-align: center;">Horas/sem</div>
                        <div style="text-align: center;">IRPF (%)</div>
                        <div style="text-align: center;">Pluses (‚Ç¨)</div>
                        <div style="text-align: center;">Neto (‚Ç¨/mes)</div>
                        <div style="text-align: center;">Coste Anual (‚Ç¨)</div>
                        <div style="text-align: center;">Acciones</div>
                    </div>

                    <div class="employee-list" id="employee-list">
                        <!-- Se llenar√° din√°micamente -->
                    </div>

                    <button onclick="addNewEmployee()" style="width: 100%; padding: 15px; margin-top: 20px; background: #667eea; color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                        + A√±adir Nuevo Empleado
                    </button>

                    <div class="info-box" style="margin-top: 30px; margin-bottom: 20px;">
                        <strong>C√≥mo funciona el c√°lculo:</strong> Selecciona el puesto, horas semanales e IRPF. El sistema calcula autom√°ticamente:
                        <ul style="margin: 10px 0 0 20px;">
                            <li><strong>Salario Base:</strong> Seg√∫n tabla salarial del convenio, proporcional a horas semanales</li>
                            <li><strong>Prorrata Pagas Extra:</strong> 3 pagas extra distribuidas en 12 meses</li>
                            <li><strong>Pluses:</strong> Manutenci√≥n (39.64‚Ç¨) y Transporte (96.65‚Ç¨) fijos</li>
                            <li><strong>Total Devengado:</strong> Base + Prorrata + Pluses + Otros pluses</li>
                            <li><strong>SS Trabajador (6.48%):</strong> Sobre base de cotizaci√≥n</li>
                            <li><strong>IRPF:</strong> Porcentaje personalizado sobre base de cotizaci√≥n</li>
                            <li><strong>SS Empresa (32.1%):</strong> Sobre base de cotizaci√≥n</li>
                            <li><strong>Coste Total = Total Devengado + SS Empresa</strong></li>
                        </ul>
                        <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                            üí° Haz clic en el bot√≥n <strong>+</strong> para ver el desglose completo de cada empleado
                        </div>
                    </div>

                    <div class="info-box" style="margin-top: 20px;">
                        <h3 style="margin-top: 0; color: #667eea; margin-bottom: 15px;">Totales Anuales</h3>
                        <div style="margin-bottom: 10px;">
                            <strong>Total Coste Personal Anual:</strong> <span id="total-personal" style="font-size: 1.3em; margin-left: 10px;">182,831‚Ç¨</span>
                        </div>
                        
                        <h3 style="margin-top: 20px; color: #667eea; margin-bottom: 15px;">Totales Mensuales</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
                            <div style="padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                                <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Salario Neto Mensual</div>
                                <div style="font-size: 1.2em; font-weight: 600; color: #333;" id="total-net-monthly">0‚Ç¨</div>
                            </div>
                            <div style="padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #ffc107;">
                                <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">SS Empleado Mensual</div>
                                <div style="font-size: 1.2em; font-weight: 600; color: #333;" id="total-ss-employee-monthly">0‚Ç¨</div>
                            </div>
                            <div style="padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #ff9800;">
                                <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">IRPF Empleado Mensual</div>
                                <div style="font-size: 1.2em; font-weight: 600; color: #333;" id="total-irpf-monthly">0‚Ç¨</div>
                            </div>
                            <div style="padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #dc3545;">
                                <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">SS Empresa Mensual</div>
                                <div style="font-size: 1.2em; font-weight: 600; color: #333;" id="total-ss-company-monthly">0‚Ç¨</div>
                            </div>
                            <div style="padding: 10px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #28a745;">
                                <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Coste Total Mensual</div>
                                <div style="font-size: 1.2em; font-weight: 600; color: #28a745;" id="total-cost-monthly">0‚Ç¨</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Gastos Operativos -->
        <div id="tab-gastos" class="tab-content">
            <div style="padding: 30px;">
                <!-- Gastos Operativos -->
            <div class="section full-width">
                <h2>Gastos Operativos Mensuales/Anuales</h2>

                <div class="results-grid">
                    <div class="input-group">
                        <label>Alquiler Local (‚Ç¨/mes)</label>
                        <input type="number" id="alquiler" value="1836" oninput="updateAllCalculations()">
                    </div>
                    <div class="input-group">
                        <label>Luz (‚Ç¨/mes)</label>
                        <input type="number" id="luz" value="600" oninput="updateAllCalculations()">
                    </div>
                    <div class="input-group">
                        <label>Agua (‚Ç¨/mes)</label>
                        <input type="number" id="agua" value="250" oninput="updateAllCalculations()">
                    </div>
                    <div class="input-group">
                        <label>Gas (‚Ç¨/mes)</label>
                        <input type="number" id="gas" value="300" oninput="updateAllCalculations()">
                    </div>
                    <div class="input-group">
                        <label>Carb√≥n (‚Ç¨/mes)</label>
                        <input type="number" id="carbon" value="500" oninput="updateAllCalculations()">
                    </div>
                    <div class="input-group">
                        <label>Internet (‚Ç¨/mes)</label>
                        <input type="number" id="internet" value="10" oninput="updateAllCalculations()">
                    </div>
                    <div class="input-group">
                        <label>Alarma (‚Ç¨/mes)</label>
                        <input type="number" id="alarma" value="150" oninput="updateAllCalculations()">
                    </div>
                    <div class="input-group">
                        <label>Redes Sociales (‚Ç¨/mes)</label>
                        <input type="number" id="redes" value="0" oninput="updateAllCalculations()">
                    </div>
                    <div class="input-group">
                        <label>Mantenimiento (‚Ç¨/mes)</label>
                        <input type="number" id="mantenimiento" value="150" oninput="updateAllCalculations()">
                    </div>
                    <div class="input-group">
                        <label>Veladores (‚Ç¨/a√±o)</label>
                        <input type="number" id="veladores" value="1415" oninput="updateAllCalculations()">
                    </div>
                    <div class="input-group">
                        <label>Qamarero (‚Ç¨/a√±o)</label>
                        <input type="number" id="qamarero" value="1000" oninput="updateAllCalculations()">
                    </div>
                    <div class="input-group">
                        <label>Asesor√≠a (‚Ç¨/mes)</label>
                        <input type="number" id="asesoria" value="350" oninput="updateAllCalculations()">
                    </div>
                    <div class="input-group">
                        <label>Seguro (‚Ç¨/a√±o)</label>
                        <input type="number" id="seguro" value="850" oninput="updateAllCalculations()">
                    </div>

                    <div id="custom-expenses-list">
                        <!-- Gastos personalizados se a√±adir√°n aqu√≠ -->
                    </div>
                </div>

                <button onclick="addNewExpense()" style="width: 100%; padding: 15px; margin-top: 20px; background: #667eea; color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                    + A√±adir Nuevo Gasto
                </button>

                <div class="info-box" style="margin-top: 20px;">
                    <div style="margin-bottom: 15px;">
                        <strong>Total Gastos Operativos Mensuales:</strong> <span id="total-operativos-mensual" style="font-size: 1.3em; margin-left: 10px;">0‚Ç¨</span>
                    </div>
                    <div>
                        <strong>Total Gastos Operativos Anuales:</strong> <span id="total-operativos" style="font-size: 1.3em; margin-left: 10px;">46,545‚Ç¨</span>
                    </div>
                </div>
            </div>

            </div>
        </div>

        <!-- Tab: Resultados -->
        <div id="tab-resultados" class="tab-content">
            <div style="padding: 30px;">
                <!-- Resultados 2025 -->
                <div class="section full-width">
                    <h2>Resultado de Explotaci√≥n - 2025 (Nov-Dic)</h2>
                    <div class="financial-flow" id="results-2025">
                        <!-- Se generar√° din√°micamente -->
                    </div>
                </div>

                <!-- Resultados 2026 -->
                <div class="section full-width" style="margin-top: 30px;">
                    <h2>Resultado de Explotaci√≥n - 2026</h2>
                    <div class="financial-flow" id="results-2026">
                        <!-- Se generar√° din√°micamente -->
                    </div>
                </div>

                <!-- Resultados Mensuales -->
                <div class="section full-width" style="margin-top: 30px;">
                    <h2>Resultado de Explotaci√≥n - Desglose Mensual</h2>
                    <div style="overflow-x: auto;">
                        <table id="monthly-results-table" style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                            <thead>
                                <tr style="background: #667eea; color: white;">
                                    <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Mes</th>
                                    <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Turnos</th>
                                    <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Facturaci√≥n</th>
                                    <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Aprovisionamiento</th>
                                    <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Margen Bruto</th>
                                    <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Gastos Personal</th>
                                    <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Gastos Operativos</th>
                                    <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Resultado</th>
                                </tr>
                            </thead>
                            <tbody id="monthly-results-body">
                                <!-- Se generar√° din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Gr√°fico -->
                <div class="section full-width" style="margin-top: 30px;">
                    <h2>Visualizaci√≥n de Resultados</h2>
                    <div class="chart-container" style="height: 500px;">
                        <canvas id="waterfallChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile-friendly Modal -->
    <div id="mobile-modal" class="mobile-modal">
        <div class="modal-content">
            <div class="modal-header" id="modal-title">Modal Title</div>
            <div id="modal-body">
                <!-- Dynamic content -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="modal-btn modal-btn-primary" id="modal-confirm-btn" onclick="confirmModal()">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Touch-friendly Tooltip -->
    <div id="tooltip-overlay" class="tooltip-overlay" onclick="hideTooltip()"></div>
    <div id="tooltip-content" class="tooltip-content"></div>

    <script>
        // Wrap in IIFE to avoid conflicts with global supabase from CDN
        (function() {
        'use strict';
        
        // ==================== TAB NAVIGATION - Define FIRST so it's available immediately ====================
        // Cambiar entre tabs - Simple and robust version
        function switchTab(tabName, eventTarget) {
            try {
                // Hide all tab contents
                var tabs = document.querySelectorAll('.tab-content');
                for (var i = 0; i < tabs.length; i++) {
                    tabs[i].classList.remove('active');
                    tabs[i].style.display = 'none';
                }

                // Deactivate all buttons
                var buttons = document.querySelectorAll('.tab-button');
                for (var i = 0; i < buttons.length; i++) {
                    buttons[i].classList.remove('active');
                }

                // Activate selected tab
                var targetTab = document.getElementById('tab-' + tabName);
                if (targetTab) {
                    targetTab.classList.add('active');
                    targetTab.style.display = 'block';
                }
                
                // Activate button
                if (eventTarget) {
                    eventTarget.classList.add('active');
                }
            } catch (error) {
                console.error('Error in switchTab:', error);
            }
        }
        
        // Helper to expose functions globally
        function exposeGlobal(name, fn) {
            window[name] = fn;
        }
        
        // Make functions globally available immediately
        exposeGlobal('switchTab', switchTab);
        exposeGlobal('getSupabase', getSupabase);

        // ==================== SUPABASE SETUP ====================
        const SUPABASE_URL = 'https://drmareaqvenjqdhidzeb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRybWFyZWFxdmVuanFkaGlkemViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2OTQ4MzksImV4cCI6MjA3ODI3MDgzOX0.ovZuNqB5kD1RUIX03LJKmQucnsMxxCZfXkNDjwlTYvo';
        
        // Initialize Supabase client - will be set in DOMContentLoaded
        // Supabase v2 from CDN exposes 'supabase' as a global variable with createClient method
        // Store the client instance in window to avoid variable name conflicts
        window.supabaseClient = null;
        
        // Helper function to get supabase client
        function getSupabase() {
            return window.supabaseClient || window.supabase;
        }

        // ==================== CONSTANTES DEL SISTEMA ====================
        const CONSTANTES = {
            horas_convenio: 40,
            pagas_anuales: 15,
            pagas_extra: 3,
            plus_manutencion: 39.64,
            plus_transporte: 96.65,
            ss_trabajador: 0.0648,
            ss_empresa: 0.321
        };

        // ==================== TABLA SALARIAL ====================
        const TABLA_SALARIAL = {
            "Jefe de Sala": 1376.64,
            "Primer encargado de Mostrador": 1376.64,
            "Segundo Jefe Comedor": 1349.99,
            "Segundo Jefe de Sala": 1349.99,
            "Mayordomo de Pisos": 1349.99,
            "Segundo Encargado de Mostrador": 1349.99,
            "Jefe de Sala de Catering": 1270.33,
            "Dependiente": 1270.33,
            "Barman": 1270.33,
            "Camarero/a Bar": 1259.65,
            "Camarero/a Sala de Fiesta": 1259.65,
            "Sumiller": 1259.65,
            "Supervisor de catering": 1259.65,
            "Supervisor de Colectividades": 1259.65,
            "Conductor Equipo de Catering": 1259.65,
            "Preparador Montador catering": 1249.11,
            "Ayudante Cafetero": 1249.11,
            "Ayudante Camarero": 1249.11,
            "Ayudante Dependiente": 1249.11,
            "Ayudante Equipo de Catering": 1249.11,
            "Monitor Cuidador Colectividades": 1249.11,
            "Repartidor de Comida y Bebida": 1249.11,
            "Jefe Cocina": 1376.64,
            "Jefe Economato": 1376.64,
            "Jefe de Catering": 1376.64,
            "Segundo Jefe de Cocina": 1349.99,
            "Jefe Repostero": 1349.99,
            "Segundo Encargado de Economato": 1349.99,
            "Jefe de Partida": 1270.34,
            "Jefe de Sector": 1270.34,
            "Oficial Repostero": 1270.34,
            "Cocinero/a": 1259.65,
            "Panadero": 1259.65,
            "Bodeguero": 1259.65,
            "Cafetero": 1259.65,
            "Ayudante de Cocina": 1249.11,
            "Ayudante de Reposteria": 1249.11,
            "Ayudante de Economato": 1249.11,
            "Ayudante Bodeguero": 1249.11,
            "Pinche": 1249.11,
            "Fregador/a": 1249.11,
            "Marmiton": 1249.11,
            "Auxiliar de Cocina": 1249.11,
            "Jefe Recepcion": 1376.64,
            "Jefe Personal": 1376.64,
            "Primer Conserje": 1376.64,
            "Contable General": 1376.64,
            "Jefe de Administracion": 1376.64,
            "Segundo Jefe Administrativo": 1349.99,
            "Segundo Jefe de Recepcion": 1349.99,
            "Segundo Conserje de Noche": 1349.99,
            "Segundo Conserje": 1349.99,
            "Recepcionista": 1270.34,
            "Cajero": 1270.34,
            "Contable": 1270.34,
            "Manocorrientes": 1270.34,
            "Oficial Administrativo": 1270.34,
            "Chofer": 1259.65,
            "Telefonista": 1259.65,
            "Comercial": 1259.65,
            "Relaciones Publicas": 1259.65,
            "Ayudante Recepcion": 1249.11,
            "Ayudante de Conserje": 1249.11,
            "Ayudante Administracion": 1249.11,
            "Taquillero": 1249.11,
            "Guardarropa": 1249.11,
            "Auxiliar de Caja": 1249.11,
            "Auxiliar de Factoria": 1249.11,
            "Portero Noche": 1249.11,
            "Ascensorista": 1249.11,
            "Vigilante": 1249.11,
            "Portero de Servicios": 1249.11,
            "Mozo de Equipaje": 1249.11,
            "Ordenanza de Salon": 1249.11,
            "Botones": 1249.11,
            "Recibidor Sala de Fiesta": 1249.11
        };

        // ==================== FUNCI√ìN DE C√ÅLCULO DE SALARIOS ====================
        function calculateSalary(puesto, horas_semanales, irpf, otros_pluses = 0) {
            // Obtener salario base completo de la tabla
            const salario_base_completo = TABLA_SALARIAL[puesto] || 0;
            
            // Calcular coeficiente de jornada
            const coef_jornada = horas_semanales / CONSTANTES.horas_convenio;
            
            // Salario base real (proporcional a horas)
            const salario_base_real = salario_base_completo * coef_jornada;
            
            // Prorrata de pagas extra
            const prorrata_pagas = (salario_base_completo * CONSTANTES.pagas_extra / 12) * coef_jornada;
            
            // Pluses fijos
            const manutencion_real = CONSTANTES.plus_manutencion;
            const transporte_real = CONSTANTES.plus_transporte;
            
            // Total devengado
            const total_devengado = salario_base_real + prorrata_pagas + manutencion_real + transporte_real + (otros_pluses || 0);
            
            // Base de cotizaci√≥n (igual al total devengado)
            const base_cotizacion = total_devengado;
            
            // Seguridad Social trabajador
            const ss_trabajador = base_cotizacion * CONSTANTES.ss_trabajador;
            
            // Retenci√≥n IRPF (irpf es un porcentaje, ej: 0.15 para 15%)
            const retencion_irpf = base_cotizacion * (irpf / 100);
            
            // Total deducciones
            const total_deducciones = ss_trabajador + retencion_irpf;
            
            // Neto mensual
            const neto = total_devengado - total_deducciones;
            
            // Seguridad Social empresa
            const ss_empresa = base_cotizacion * CONSTANTES.ss_empresa;
            
            // Coste total para la empresa
            const coste_empresa = total_devengado + ss_empresa;
            
            return {
                puesto: puesto,
                horas_semanales: horas_semanales,
                salario_base_completo: salario_base_completo,
                salario_base_real: salario_base_real,
                prorrata_pagas: prorrata_pagas,
                plus_manutencion: manutencion_real,
                plus_transporte: transporte_real,
                otros_pluses: otros_pluses || 0,
                total_devengado: total_devengado,
                base_cotizacion: base_cotizacion,
                ss_trabajador: ss_trabajador,
                irpf: retencion_irpf,
                total_deducciones: total_deducciones,
                neto: neto,
                ss_empresa: ss_empresa,
                coste_empresa: coste_empresa,
                // Valores anuales para compatibilidad
                netAnnual: neto * 12,
                grossAnnual: total_devengado * 12,
                companySS: ss_empresa * 12,
                totalCost: coste_empresa * 12
            };
        }

        // Datos de empleados (nueva estructura: puesto, horas_semanales, irpf, otros_pluses)
        // Valores por defecto
        const defaultEmployees = [
            { name: 'Vito', puesto: 'Jefe de Sala', horas_semanales: 40, irpf: 0, otros_pluses: 0 },
            { name: 'Francisco', puesto: 'Ayudante de Cocina', horas_semanales: 40, irpf: 0, otros_pluses: 0 },
            { name: 'Elena', puesto: 'Ayudante de Cocina', horas_semanales: 40, irpf: 0, otros_pluses: 0 },
            { name: 'Elena U', puesto: 'Camarero/a Bar', horas_semanales: 40, irpf: 0, otros_pluses: 0 },
            { name: 'Extra cocina', puesto: 'Ayudante de Cocina', horas_semanales: 10, irpf: 0, otros_pluses: 0 },
            { name: 'Extra sala', puesto: 'Camarero/a Bar', horas_semanales: 10, irpf: 0, otros_pluses: 0 },
            { name: 'Extra office', puesto: 'Ayudante Administracion', horas_semanales: 40, irpf: 0, otros_pluses: 0 }
        ];
        
        // Cargar empleados desde localStorage o usar valores por defecto
        let employees = [];
        function loadEmployeesFromStorage() {
            try {
                const saved = localStorage.getItem('employees');
                if (saved) {
                    employees = JSON.parse(saved);
                    console.log('Empleados cargados desde localStorage:', employees.length);
                } else {
                    employees = JSON.parse(JSON.stringify(defaultEmployees)); // Deep copy
                    saveEmployeesToStorage();
                }
            } catch (e) {
                console.error('Error loading employees:', e);
                employees = JSON.parse(JSON.stringify(defaultEmployees));
            }
        }
        
        function saveEmployeesToStorage() {
            try {
                localStorage.setItem('employees', JSON.stringify(employees));
                console.log('Empleados guardados en localStorage');
            } catch (e) {
                console.error('Error saving employees:', e);
            }
        }
        
        // Cargar empleados personalizados desde localStorage
        function loadCustomEmployeesFromStorage() {
            try {
                const saved = localStorage.getItem('customEmployees');
                if (saved) {
                    customEmployees = JSON.parse(saved);
                    console.log('Empleados personalizados cargados desde localStorage:', customEmployees.length);
                }
            } catch (e) {
                console.error('Error loading custom employees:', e);
                customEmployees = [];
            }
        }
        
        function saveCustomEmployeesToStorage() {
            try {
                localStorage.setItem('customEmployees', JSON.stringify(customEmployees));
                console.log('Empleados personalizados guardados en localStorage');
            } catch (e) {
                console.error('Error saving custom employees:', e);
            }
        }

        // ==================== MENU SIMULATOR ====================

        // Menu database with prices and costs
        const menuItems = {
            aperitivos: [
                { name: 'Aceitunas', desc: 'Aceituna en panko con mayonesa de piparra', price: 5, cost: 0.72 },
                { name: 'Gilda coronada', desc: 'Aceituna gordal, piparra, anchoa y alcachofa a la brasa', price: 4.20, cost: 1.1 },
                { name: 'Tosta Matrimonio', desc: 'Anchoa y boquer√≥n marinados, sobre cremosa mantequilla de oveja', price: 4.80, cost: 1.02 },
                { name: 'Plato de jam√≥n', desc: 'Selecci√≥n de jam√≥n cebo ib√©rico montesierra', price: 22, cost: 1.95 },
                { name: 'Plato de queso', desc: 'Queso a√±ejo de 1972 LOS VAZQUEZ', price: 15, cost: 2.73 },
                { name: 'Pan de ajo', desc: 'Pan de masa madre crujiente con ajo y perejil', price: 2, cost: 0.55 }
            ],
            entrantes: [
                { name: 'Tosta de at√∫n', desc: 'At√∫n rojo sobre pan tostado crujiente', price: 8, cost: 3.03 },
                { name: 'Empanada Criolla', desc: 'Empanadas argentinas caseras de carne. 2 UDs', price: 9, cost: 2 },
                { name: 'Carpaccio de ternera', desc: 'Finas l√°minas de ternera con helado salado de boletus', price: 19, cost: 5.17 },
                { name: 'Tartar Ib√©rico', desc: 'Salchich√≥n ib√©rico picado fino, sobre helado salado de mostaza', price: 17, cost: 3.93 },
                { name: 'Bikini Tartar', desc: 'Steak tartar con queso fundido en pan brioche. 4 UDs', price: 23, cost: 9.10 },
                { name: 'Nigiri Ib√©rico', desc: 'Niguiris de presa ib√©rica jugosa a la brasa. 6 UDs', price: 13, cost: 3.73 },
                { name: 'Provoleta', desc: 'Queso provolone argentino fundido y dorado a la brasa', price: 13, cost: 3.95 },
                { name: 'Patatas bravas', desc: 'Patatas fritas crujientes con salsa brava picante', price: 12, cost: 1.87 },
                { name: 'Croquetas', desc: 'Croquetas cremosas con bechamel de jam√≥n ib√©rico. 4 UDs', price: 7, cost: 2.00 },
                { name: 'Flamenqu√≠n', desc: 'Flamenqu√≠n cordob√©s de jam√≥n y lomo', price: 14, cost: 4.00 },
                { name: 'Formentere√±a', desc: 'Carabinero rojo a la brasa con huevos rotos', price: 26, cost: 9.43 },
                { name: 'Parrillada de verduras', desc: 'Verduras frescas de temporada asadas', price: 12, cost: 1.98 },
                { name: 'Tortilla de Jam√≥n', desc: 'Tortilla jugosa semil√≠quida con jam√≥n ib√©rico', price: 12, cost: 2.20 }
            ],
            ensaladas: [
                { name: 'Ensalada de temporada', desc: 'Hojas verdes frescas con vinagreta artesanal', price: 13, cost: 1.87 },
                { name: 'Ensalada de Burrata', desc: 'Burrata fresca con alcachofas asadas y jam√≥n', price: 16, cost: 3.74 },
                { name: 'Ensalada C√©sar', desc: 'Lechuga romana, pollo a la brasa, parmesano', price: 12, cost: 2.75 }
            ],
            carnes: [
                { name: 'Solomillo', desc: 'Solomillo de ternera nacional tierno', price: 25, cost: 9.52 },
                { name: 'Solomillo al Foie', desc: 'Solomillo con medall√≥n de foie mi-cuit', price: 28, cost: 11.06 },
                { name: 'Entrecot', desc: 'Entrecot premium jugoso madurado', price: 28, cost: 8.73 },
                { name: 'Entra√±a', desc: 'Entra√±a argentina de vacuno jugosa', price: 21, cost: 7.31 },
                { name: 'Abanico Ib√©rico', desc: 'Abanico ib√©rico de bellota jugoso', price: 22, cost: 6.79 },
                { name: 'Presa Ib√©rica', desc: 'Presa ib√©rica de bellota a la brasa', price: 24, cost: 8.24 },
                { name: 'Chulet√≥n Premium', desc: 'Chulet√≥n madurado (aprox. 800g)', price: 96, cost: 36.29 },
                { name: 'Lomo Bajo Premium', desc: 'Lomo bajo madurado (aprox. 400g)', price: 48, cost: 18.15 },
                { name: 'Hamburguesa', desc: 'Hamburguesa gourmet de ternera madurada', price: 16, cost: 6.23 }
            ],
            guarniciones: [
                { name: 'Patatas con acento', desc: 'Patatas fritas con ali√±o especial', price: 5, cost: 1.1 },
                { name: 'Pimientos del Padr√≥n', desc: 'Asados a la parrilla con aceite de oliva', price: 5, cost: 1.1 },
                { name: 'Piparras Fritas', desc: 'Piparras frescas rebozadas, seg√∫n temporada', price: 5, cost: 1.65 }
            ],
            postres: [
                { name: 'Torrija', desc: 'Torrija de pan brioche con helado de caramelo salado', price: 7, cost: 2.42 },
                { name: 'Tiramis√∫', desc: 'Cl√°sico italiano con mascarpone y cacao', price: 7, cost: 1.76 },
                { name: 'Tarta de Queso', desc: 'Estilo New York, cremosa y suave', price: 7, cost: 2.2 },
                { name: 'Brownie', desc: 'Brownie casero de chocolate con nueces', price: 7, cost: 2.09 },
                { name: 'Helados Artesanales', desc: 'Helados de elaboraci√≥n artesanal', price: 6, cost: 1.5 }
            ],
            vinosblancos: [
                { name: 'La Levantadas', desc: 'Vino blanco - Botella', price: 22, cost: 6.6 },
                { name: 'Solag√ºen', desc: 'Vino blanco - Botella', price: 21, cost: 6.3 },
                { name: 'Solag√ºen Copa', desc: 'Vino blanco - Copa', price: 4, cost: 1.2 },
                { name: 'Neve Carbonica', desc: 'Vino blanco - Botella', price: 30, cost: 9 },
                { name: 'Vi√±a Zorzal', desc: 'Vino blanco - Botella', price: 21, cost: 6.3 },
                { name: 'Vi√±a Zorzal Copa', desc: 'Vino blanco - Copa', price: 4, cost: 1.2 },
                { name: 'Juan Gil Moscatel', desc: 'Vino blanco - Botella', price: 20, cost: 6 },
                { name: 'Juan Gil Moscatel Copa', desc: 'Vino blanco - Copa', price: 4, cost: 1.2 },
                { name: 'Pazo San Mauro', desc: 'Vino blanco - Botella', price: 35, cost: 10.5 },
                { name: 'Finca Las Yeguas', desc: 'Vino blanco - Botella', price: 33, cost: 9.9 },
                { name: 'Javier Sanz Fermentado', desc: 'Vino blanco - Botella', price: 35, cost: 10.5 },
                { name: 'Casal de Arman', desc: 'Vino blanco - Botella', price: 33, cost: 9.9 },
                { name: 'Finca Monteperdoso', desc: 'Vino blanco - Botella', price: 21, cost: 6.3 },
                { name: 'Finca Monteperdoso Copa', desc: 'Vino blanco - Copa', price: 4, cost: 1.2 },
                { name: 'Nivarius', desc: 'Vino blanco - Botella', price: 21, cost: 6.3 },
                { name: 'Nivarius Copa', desc: 'Vino blanco - Copa', price: 4, cost: 1.2 }
            ],
            vinosrosados: [
                { name: 'Sierra Cantabria Rosado', desc: 'Vino rosado - Botella', price: 27, cost: 8.1 }
            ],
            espumosos: [
                { name: 'Alma Atlantica', desc: 'Espumoso - Botella', price: 20, cost: 6 },
                { name: 'Alma Atlantica Copa', desc: 'Espumoso - Copa', price: 4, cost: 1.2 },
                { name: 'Cross Twist', desc: 'Espumoso - Botella', price: 21, cost: 6.3 },
                { name: 'Umbretum', desc: 'Espumoso - Botella', price: 38, cost: 11.4 },
                { name: 'Umbretum Copa', desc: 'Espumoso - Copa', price: 7, cost: 2.1 },
                { name: 'Andre Clouet Champagne', desc: 'Champagne - Botella', price: 90, cost: 27 }
            ],
            vinostintos: [
                { name: 'Tandem', desc: 'Vino tinto - Botella', price: 37, cost: 11.1 },
                { name: 'Primitivo', desc: 'Vino tinto - Botella', price: 35, cost: 10.5 },
                { name: 'Victorino', desc: 'Vino tinto - Botella', price: 88, cost: 26.4 },
                { name: 'Camins del Priorat', desc: 'Vino tinto - Botella', price: 48, cost: 14.4 },
                { name: 'Petalos del Bierzo', desc: 'Vino tinto - Botella', price: 40, cost: 12 },
                { name: 'Antidoto', desc: 'Vino tinto - Botella', price: 36, cost: 10.8 },
                { name: 'La Nieta', desc: 'Vino tinto - Botella', price: 207, cost: 62.1 },
                { name: 'Flor de Pingus', desc: 'Vino tinto - Botella', price: 213, cost: 63.9 },
                { name: 'Sierra Cantabria Col. Privada', desc: 'Vino tinto - Botella', price: 77, cost: 23.1 },
                { name: 'Venta La Vacas', desc: 'Vino tinto - Botella', price: 42, cost: 12.6 },
                { name: 'Pago de Capellanes', desc: 'Vino tinto - Botella', price: 39, cost: 11.7 },
                { name: 'Viuda Negra', desc: 'Vino tinto - Botella', price: 28, cost: 8.4 },
                { name: 'Las Tetas De La Sacristana', desc: 'Vino tinto - Botella', price: 29, cost: 8.7 },
                { name: 'Mataromera', desc: 'Vino tinto - Botella', price: 52, cost: 15.6 },
                { name: 'Juan Gil ET. Plata', desc: 'Vino tinto - Botella', price: 29, cost: 8.7 },
                { name: 'Disfrutando 0,0', desc: 'Vino tinto sin alcohol - Botella', price: 22, cost: 6.6 },
                { name: 'Disfrutando 0,0 Copa', desc: 'Vino tinto sin alcohol - Copa', price: 4, cost: 1.2 },
                { name: 'Palomo Cazador', desc: 'Vino tinto - Botella', price: 22, cost: 6.6 },
                { name: 'Palomo Cazador Copa', desc: 'Vino tinto - Copa', price: 4, cost: 1.2 },
                { name: 'Malleolus Cosecha', desc: 'Vino tinto - Botella', price: 56, cost: 16.8 },
                { name: 'Malabrigo', desc: 'Vino tinto - Botella', price: 54, cost: 16.2 },
                { name: 'Bosque De Matasnos Blanca', desc: 'Vino tinto - Botella', price: 55, cost: 16.5 },
                { name: 'Pago De Carraovejas', desc: 'Vino tinto - Botella', price: 58, cost: 17.4 },
                { name: 'Habla 29', desc: 'Vino tinto - Botella', price: 48, cost: 14.4 },
                { name: 'San Roman', desc: 'Vino tinto - Botella', price: 56, cost: 16.8 },
                { name: 'Finca Antigua Unico', desc: 'Vino tinto - Botella', price: 24, cost: 7.2 },
                { name: 'Finca Antigua Unico Copa', desc: 'Vino tinto - Copa', price: 4, cost: 1.2 }
            ],
            aperitivos_bebidas: [
                { name: 'Fino El√©ctrico', desc: 'Fino', price: 2.5, cost: 1.25 },
                { name: 'Fino Gran Baquero', desc: 'Fino', price: 3.5, cost: 1.75 },
                { name: 'Amontillado Gran Baquero', desc: 'Amontillado', price: 4.5, cost: 2.25 },
                { name: 'Oloroso Gran Baquero', desc: 'Oloroso', price: 4.5, cost: 2.25 },
                { name: 'Palo Cortado Gran Baquero', desc: 'Palo Cortado', price: 6, cost: 3 },
                { name: 'Pedro Xim√©nez Gran Baquero', desc: 'Pedro Xim√©nez', price: 4.5, cost: 2.25 },
                { name: 'Vermouth Baquero', desc: 'Vermut', price: 3.5, cost: 1.75 },
                { name: 'Martini Rosso', desc: 'Aperitivo', price: 3.5, cost: 1.75 },
                { name: 'Campari', desc: 'Aperitivo', price: 3.5, cost: 1.75 },
                { name: 'Campari Soda', desc: 'Combinado', price: 5, cost: 2.5 },
                { name: 'Campari Orange', desc: 'Combinado', price: 5, cost: 2.5 },
                { name: 'Aperol Spritz', desc: 'Combinado', price: 7.5, cost: 3.75 }
            ],
            cervezas: [
                { name: 'Ca√±a Estrella Galicia Bodega', desc: 'Cerveza ca√±a', price: 2.9, cost: 1.45 },
                { name: 'Copa Estrella Galicia Bodega', desc: 'Cerveza copa', price: 3.6, cost: 1.8 },
                { name: 'Jarra Estrella Galicia Bodega', desc: 'Cerveza jarra', price: 5.5, cost: 2.75 },
                { name: 'Milnueve Estrella Galicia', desc: 'Cerveza especial', price: 4.5, cost: 2.25 },
                { name: 'Black Coupage Estrella Galicia', desc: 'Cerveza negra', price: 4.5, cost: 2.25 },
                { name: 'Estrella Galicia 0,0', desc: 'Cerveza sin alcohol', price: 3.5, cost: 1.75 },
                { name: 'Estrella Galicia 0,0 Tostada', desc: 'Cerveza sin alcohol', price: 3.5, cost: 1.75 },
                { name: 'Estrella Galicia Sin Gluten', desc: 'Cerveza sin gluten', price: 3.5, cost: 1.75 },
                { name: 'Radler Estrella Galicia', desc: 'Cerveza con lim√≥n', price: 3.5, cost: 1.75 }
            ],
            refrescos: [
                { name: 'Coca Cola', desc: 'Refresco cola', price: 2.6, cost: 1.3 },
                { name: 'Coca Cola 0', desc: 'Refresco sin az√∫car', price: 2.6, cost: 1.3 },
                { name: 'Coca Cola 0,0', desc: 'Refresco sin az√∫car', price: 2.6, cost: 1.3 },
                { name: 'Fanta de Naranja', desc: 'Refresco naranja', price: 2.6, cost: 1.3 },
                { name: 'Fanta de Lim√≥n', desc: 'Refresco lim√≥n', price: 2.6, cost: 1.3 },
                { name: 'Sprite', desc: 'Refresco lima-lim√≥n', price: 2.6, cost: 1.3 },
                { name: 'Aquarius de Naranja', desc: 'Bebida isot√≥nica', price: 2.6, cost: 1.3 },
                { name: 'Aquarius de Lim√≥n', desc: 'Bebida isot√≥nica', price: 2.6, cost: 1.3 },
                { name: 'Fuze Lim√≥n', desc: 'T√© fr√≠o', price: 2.6, cost: 1.3 },
                { name: 'Fuze Maracuy√°', desc: 'T√© fr√≠o', price: 2.6, cost: 1.3 },
                { name: 'Bliss T√≥nica', desc: 'T√≥nica', price: 2.6, cost: 1.3 },
                { name: 'Bliss Lim√≥n', desc: 'Refresco lim√≥n', price: 2.6, cost: 1.3 },
                { name: 'Bliss Ginger Ale', desc: 'Ginger Ale', price: 2.6, cost: 1.3 },
                { name: 'Bliss Soda', desc: 'Soda', price: 2.6, cost: 1.3 },
                { name: 'Monster Energy', desc: 'Bebida energ√©tica', price: 2.6, cost: 1.3 }
            ],
            zumos: [
                { name: 'Minute Maid Naranja', desc: 'Zumo naranja', price: 3, cost: 1.5 },
                { name: 'Minute Maid Pi√±a', desc: 'Zumo pi√±a', price: 3, cost: 1.5 },
                { name: 'Minute Maid Tomate', desc: 'Zumo tomate', price: 3, cost: 1.5 }
            ],
            aguas: [
                { name: 'Vilas 1 Litro', desc: 'Agua mineral 1L', price: 2.5, cost: 1.25 },
                { name: 'Vilas 33 Cl', desc: 'Agua mineral 33cl', price: 2, cost: 1 },
                { name: 'San Pellegrino 50 Cl', desc: 'Agua con gas 50cl', price: 2.5, cost: 1.25 }
            ],
            cafes: [
                { name: 'Espresso Lavazza', desc: 'Caf√© espresso', price: 1.8, cost: 0.9 },
                { name: 'Americano Lavazza', desc: 'Caf√© americano', price: 2.2, cost: 1.1 },
                { name: 'Cappuccino Lavazza', desc: 'Caf√© cappuccino', price: 2.5, cost: 1.25 },
                { name: 'Caf√© con Leche Lavazza', desc: 'Caf√© con leche', price: 2.5, cost: 1.25 }
            ]
        };

        // Bebidas (precio promedio y coste)
        const drinks = {
            wine: { name: 'Copa de vino', price: 4, cost: 1.2 },
            beer: { name: 'Cerveza', price: 3.5, cost: 1.0 },
            soft: { name: 'Refresco', price: 2.5, cost: 0.5 },
            water: { name: 'Agua', price: 2, cost: 0.3 }
        };

        // Current scenario state
        let currentScenario = {
            groupType: '',
            people: 0,
            items: []
        };

        // Persona consumption patterns (units per person per visit)
        const personaPatterns = {
            tapeadores: {
                name: 'Los Tapeadores',
                description: 'Locals o grupos casuales que vienen a compartir raciones',
                aperitivos: 0.8,
                entrantes: 0.8,
                carnes: 0.3,
                guarniciones: 0.3,
                postres: 0.3,
                bebidas: 2.0
            },
            steaklovers: {
                name: 'Los Steak Lovers',
                description: 'Buscan calidad, vienen por las brasas y el producto premium',
                aperitivos: 0.2,
                entrantes: 0.2,
                carnes: 1.0,
                guarniciones: 0.4,
                postres: 0.5,
                bebidas: 2.0
            },
            valuehunters: {
                name: 'Los Value Hunters',
                description: 'Clientes de men√∫ o gasto contenido, familias y parejas j√≥venes',
                aperitivos: 0.3,
                entrantes: 0.3,
                carnes: 1.0,
                guarniciones: 0.3,
                postres: 0.2,
                bebidas: 1.5
            },
            foodies: {
                name: 'Los Foodies Experienciales',
                description: 'Les gusta probar cosas distintas (tartar, nigiri, carpaccio)',
                aperitivos: 0.6,
                entrantes: 0.8,
                carnes: 0.5,
                guarniciones: 0.3,
                postres: 0.4,
                bebidas: 2.0
            },
            familias: {
                name: 'Las Familias Tradicionales',
                description: 'Grupos familiares de fin de semana, priorizan cantidad',
                aperitivos: 0.4,
                entrantes: 0.4,
                carnes: 1.0,
                guarniciones: 0.4,
                postres: 0.6,
                bebidas: 1.8
            },
            grupos: {
                name: 'Los Grupos Sociales',
                description: 'Amigos o colegas, celebraci√≥n o cena informal',
                aperitivos: 0.8,
                entrantes: 0.8,
                carnes: 0.6,
                guarniciones: 0.4,
                postres: 0.5,
                bebidas: 2.0
            },
            festivos: {
                name: 'Los Festivos / Ocasi√≥n Especial',
                description: 'Clientes de celebraci√≥n (cumplea√±os, aniversario, visita)',
                aperitivos: 0.4,
                entrantes: 0.6,
                carnes: 1.0,
                guarniciones: 0.4,
                postres: 0.8,
                bebidas: 2.2
            }
        };

        // Predefined scenarios
        const scenarios = {
            pareja: {
                people: 2,
                items: [
                    { category: 'aperitivos', item: 'Pan de ajo', qty: 1 },
                    { category: 'entrantes', item: 'Croquetas', qty: 1 },
                    { category: 'entrantes', item: 'Provoleta', qty: 1 },
                    { category: 'carnes', item: 'Solomillo', qty: 1 },
                    { category: 'carnes', item: 'Presa Ib√©rica', qty: 1 },
                    { category: 'guarniciones', item: 'Patatas con acento', qty: 1 },
                    { category: 'postres', item: 'Tarta de Queso', qty: 1 },
                    { category: 'postres', item: 'Tiramis√∫', qty: 1 }
                ]
            },
            familia4: {
                people: 4,
                items: [
                    { category: 'aperitivos', item: 'Pan de ajo', qty: 2 },
                    { category: 'entrantes', item: 'Croquetas', qty: 2 },
                    { category: 'entrantes', item: 'Patatas bravas', qty: 1 },
                    { category: 'carnes', item: 'Hamburguesa', qty: 2 },
                    { category: 'carnes', item: 'Entra√±a', qty: 1 },
                    { category: 'carnes', item: 'Presa Ib√©rica', qty: 1 },
                    { category: 'guarniciones', item: 'Patatas con acento', qty: 2 },
                    { category: 'postres', item: 'Helados Artesanales', qty: 3 },
                    { category: 'postres', item: 'Brownie', qty: 1 }
                ]
            },
            familia6: {
                people: 6,
                items: [
                    { category: 'aperitivos', item: 'Pan de ajo', qty: 3 },
                    { category: 'aperitivos', item: 'Aceitunas', qty: 2 },
                    { category: 'entrantes', item: 'Croquetas', qty: 3 },
                    { category: 'entrantes', item: 'Patatas bravas', qty: 2 },
                    { category: 'ensaladas', item: 'Ensalada C√©sar', qty: 1 },
                    { category: 'carnes', item: 'Hamburguesa', qty: 2 },
                    { category: 'carnes', item: 'Entra√±a', qty: 2 },
                    { category: 'carnes', item: 'Presa Ib√©rica', qty: 2 },
                    { category: 'guarniciones', item: 'Patatas con acento', qty: 2 },
                    { category: 'guarniciones', item: 'Pimientos del Padr√≥n', qty: 1 },
                    { category: 'postres', item: 'Helados Artesanales', qty: 4 },
                    { category: 'postres', item: 'Tarta de Queso', qty: 2 }
                ]
            },
            'dos-parejas': {
                people: 4,
                items: [
                    { category: 'aperitivos', item: 'Plato de jam√≥n', qty: 1 },
                    { category: 'aperitivos', item: 'Gilda coronada', qty: 4 },
                    { category: 'entrantes', item: 'Tartar Ib√©rico', qty: 1 },
                    { category: 'entrantes', item: 'Provoleta', qty: 1 },
                    { category: 'carnes', item: 'Solomillo al Foie', qty: 2 },
                    { category: 'carnes', item: 'Entrecot', qty: 2 },
                    { category: 'guarniciones', item: 'Patatas con acento', qty: 1 },
                    { category: 'guarniciones', item: 'Pimientos del Padr√≥n', qty: 1 },
                    { category: 'postres', item: 'Torrija', qty: 2 },
                    { category: 'postres', item: 'Tiramis√∫', qty: 2 }
                ]
            },
            amigos4: {
                people: 4,
                items: [
                    { category: 'aperitivos', item: 'Aceitunas', qty: 1 },
                    { category: 'aperitivos', item: 'Pan de ajo', qty: 2 },
                    { category: 'entrantes', item: 'Patatas bravas', qty: 2 },
                    { category: 'entrantes', item: 'Croquetas', qty: 2 },
                    { category: 'entrantes', item: 'Nigiri Ib√©rico', qty: 1 },
                    { category: 'carnes', item: 'Entra√±a', qty: 2 },
                    { category: 'carnes', item: 'Abanico Ib√©rico', qty: 2 },
                    { category: 'guarniciones', item: 'Patatas con acento', qty: 2 },
                    { category: 'postres', item: 'Brownie', qty: 2 },
                    { category: 'postres', item: 'Tiramis√∫', qty: 2 }
                ]
            },
            amigos6: {
                people: 6,
                items: [
                    { category: 'aperitivos', item: 'Plato de jam√≥n', qty: 1 },
                    { category: 'aperitivos', item: 'Plato de queso', qty: 1 },
                    { category: 'entrantes', item: 'Patatas bravas', qty: 2 },
                    { category: 'entrantes', item: 'Croquetas', qty: 2 },
                    { category: 'entrantes', item: 'Provoleta', qty: 2 },
                    { category: 'entrantes', item: 'Bikini Tartar', qty: 1 },
                    { category: 'carnes', item: 'Chulet√≥n Premium', qty: 1 },
                    { category: 'carnes', item: 'Presa Ib√©rica', qty: 2 },
                    { category: 'carnes', item: 'Entra√±a', qty: 2 },
                    { category: 'guarniciones', item: 'Patatas con acento', qty: 2 },
                    { category: 'guarniciones', item: 'Pimientos del Padr√≥n', qty: 2 },
                    { category: 'postres', item: 'Tarta de Queso', qty: 3 },
                    { category: 'postres', item: 'Torrija', qty: 3 }
                ]
            },
            amigos8: {
                people: 8,
                items: [
                    { category: 'aperitivos', item: 'Plato de jam√≥n', qty: 2 },
                    { category: 'aperitivos', item: 'Plato de queso', qty: 1 },
                    { category: 'aperitivos', item: 'Aceitunas', qty: 2 },
                    { category: 'entrantes', item: 'Patatas bravas', qty: 3 },
                    { category: 'entrantes', item: 'Croquetas', qty: 3 },
                    { category: 'entrantes', item: 'Provoleta', qty: 2 },
                    { category: 'entrantes', item: 'Formentere√±a', qty: 1 },
                    { category: 'entrantes', item: 'Bikini Tartar', qty: 2 },
                    { category: 'carnes', item: 'Chulet√≥n Premium', qty: 2 },
                    { category: 'carnes', item: 'Presa Ib√©rica', qty: 3 },
                    { category: 'carnes', item: 'Entra√±a', qty: 2 },
                    { category: 'guarniciones', item: 'Patatas con acento', qty: 3 },
                    { category: 'guarniciones', item: 'Pimientos del Padr√≥n', qty: 2 },
                    { category: 'postres', item: 'Tarta de Queso', qty: 4 },
                    { category: 'postres', item: 'Tiramis√∫', qty: 4 }
                ]
            },
            amigos10: {
                people: 10,
                items: [
                    { category: 'aperitivos', item: 'Plato de jam√≥n', qty: 2 },
                    { category: 'aperitivos', item: 'Plato de queso', qty: 2 },
                    { category: 'aperitivos', item: 'Aceitunas', qty: 2 },
                    { category: 'aperitivos', item: 'Gilda coronada', qty: 10 },
                    { category: 'entrantes', item: 'Patatas bravas', qty: 3 },
                    { category: 'entrantes', item: 'Croquetas', qty: 4 },
                    { category: 'entrantes', item: 'Provoleta', qty: 3 },
                    { category: 'entrantes', item: 'Formentere√±a', qty: 2 },
                    { category: 'entrantes', item: 'Bikini Tartar', qty: 2 },
                    { category: 'entrantes', item: 'Carpaccio de ternera', qty: 1 },
                    { category: 'carnes', item: 'Chulet√≥n Premium', qty: 2 },
                    { category: 'carnes', item: 'Lomo Bajo Premium', qty: 1 },
                    { category: 'carnes', item: 'Presa Ib√©rica', qty: 3 },
                    { category: 'carnes', item: 'Abanico Ib√©rico', qty: 3 },
                    { category: 'guarniciones', item: 'Patatas con acento', qty: 4 },
                    { category: 'guarniciones', item: 'Pimientos del Padr√≥n', qty: 3 },
                    { category: 'guarniciones', item: 'Parrillada de verduras', qty: 1 },
                    { category: 'postres', item: 'Tarta de Queso', qty: 5 },
                    { category: 'postres', item: 'Tiramis√∫', qty: 5 }
                ]
            }
        };

        // Update scenario inputs (replaces loadScenario)
        function updateScenarioInputs() {
            const clientCount = parseInt(document.getElementById('client-count').value);
            const personaType = document.getElementById('persona-type').value;

            if (!clientCount || !personaType) {
                document.getElementById('menu-selection').style.display = 'none';
                return;
            }

            // Update current scenario with client count and persona
            currentScenario = {
                groupType: personaType,
                people: clientCount,
                items: []
            };

            // Show the menu selection area
            document.getElementById('menu-selection').style.display = 'block';
            renderScenario();
            calculateScenario();
        }

        // Render the current scenario
        function renderScenario() {
            const container = document.getElementById('selected-items');
            container.innerHTML = '';

            // Categories that should be grouped
            const drinkCategories = ['vinosblancos', 'vinosrosados', 'vinostintos', 'espumosos', 'aperitivos_bebidas', 'cervezas', 'refrescos', 'zumos', 'aguas'];
            const entrantesCategories = ['aperitivos', 'entrantes'];
            const carnesCategories = ['carnes', 'guarniciones'];
            const postresCategories = ['postres', 'cafes'];

            // Define category order
            const categoryOrder = {
                'bebidas': 1,
                'entrantes_aperitivos': 2,
                'ensaladas': 3,
                'carnes_guarniciones': 4,
                'postres_cafes': 5
            };

            // Category display names
            const categoryNames = {
                'bebidas': 'üçπ Bebidas',
                'entrantes_aperitivos': 'üçΩÔ∏è Entrantes y Aperitivos',
                'ensaladas': 'ü•ó Ensaladas',
                'carnes_guarniciones': 'ü•© Carnes y Guarniciones',
                'postres_cafes': 'üç∞ Postres y Caf√©s'
            };

            // Group items by display category
            const itemsWithDisplayCategory = currentScenario.items.map(item => {
                let displayCategory = item.category;
                if (drinkCategories.includes(item.category)) {
                    displayCategory = 'bebidas';
                } else if (entrantesCategories.includes(item.category)) {
                    displayCategory = 'entrantes_aperitivos';
                } else if (carnesCategories.includes(item.category)) {
                    displayCategory = 'carnes_guarniciones';
                } else if (postresCategories.includes(item.category)) {
                    displayCategory = 'postres_cafes';
                }
                return { ...item, displayCategory };
            });

            // Sort items by category order
            const sortedItems = [...itemsWithDisplayCategory].sort((a, b) => {
                const orderA = categoryOrder[a.displayCategory] || 999;
                const orderB = categoryOrder[b.displayCategory] || 999;
                return orderA - orderB;
            });

            // Group items by display category
            let currentCategory = null;

            sortedItems.forEach((item, displayIndex) => {
                // Find the original index in currentScenario.items for button actions
                const originalIndex = currentScenario.items.findIndex((original, idx) =>
                    original.category === item.category &&
                    original.item === item.item &&
                    currentScenario.items.slice(0, idx).filter(i => i.category === item.category && i.item === item.item).length ===
                    sortedItems.slice(0, displayIndex).filter(i => i.category === item.category && i.item === item.item).length
                );

                const menuItem = menuItems[item.category].find(mi => mi.name === item.item);
                if (!menuItem) return;

                // Add category header if this is a new display category
                if (currentCategory !== item.displayCategory) {
                    currentCategory = item.displayCategory;
                    const header = document.createElement('div');
                    header.style.cssText = 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 15px; font-weight: bold; font-size: 16px; margin-top: 10px; border-radius: 6px 6px 0 0;';
                    header.textContent = categoryNames[item.displayCategory] || item.displayCategory;
                    container.appendChild(header);
                }

                // Add bottle tag for wine bottles
                const wineCategories = ['vinosblancos', 'vinostintos', 'vinosrosados'];
                const isBottle = menuItem.desc && menuItem.desc.includes('Botella');
                const isWine = wineCategories.includes(item.category);
                const bottleTag = (isWine && isBottle) ? ' üç∑' : '';
                const displayName = menuItem.name + bottleTag;

                const div = document.createElement('div');
                div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #ddd; background: white;';
                div.innerHTML = `
                    <div style="flex: 1;">
                        <strong>${displayName}</strong>
                        <div style="font-size: 14px; margin-top: 5px; color: #555;">
                            Precio: ${menuItem.price.toFixed(2)}‚Ç¨ | Coste: ${menuItem.cost.toFixed(2)}‚Ç¨ | Margen: ${((menuItem.price - menuItem.cost) / menuItem.price * 100).toFixed(1)}%
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button onclick="changeQty(${originalIndex}, -1)" style="width: 30px; height: 30px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">-</button>
                        <span style="min-width: 30px; text-align: center; font-weight: bold;">${item.qty}</span>
                        <button onclick="changeQty(${originalIndex}, 1)" style="width: 30px; height: 30px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">+</button>
                        <button onclick="removeItem(${originalIndex})" style="padding: 8px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">Quitar</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Change quantity
        function changeQty(index, delta) {
            currentScenario.items[index].qty += delta;
            if (currentScenario.items[index].qty < 1) {
                currentScenario.items[index].qty = 1;
            }
            renderScenario();
            calculateScenario();
        }

        // Remove item
        function removeItem(index) {
            currentScenario.items.splice(index, 1);
            renderScenario();
            calculateScenario();
        }

        // Update item select based on category
        function updateItemSelect() {
            const category = document.getElementById('add-category').value;
            const itemSelect = document.getElementById('add-item');
            itemSelect.innerHTML = '<option value="">-- Selecciona plato --</option>';

            if (category && menuItems[category]) {
                menuItems[category].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.name;
                    option.textContent = `${item.name} - ${item.price.toFixed(2)}‚Ç¨`;
                    itemSelect.appendChild(option);
                });
            }
        }

        // Add new item
        function addItem() {
            const category = document.getElementById('add-category').value;
            const itemName = document.getElementById('add-item').value;

            if (!category || !itemName) {
                alert('Por favor selecciona categor√≠a y plato');
                return;
            }

            // Validate against rules
            const validation = validateAgainstRules(category, itemName);
            if (!validation.valid) {
                alert(validation.message);
                return;
            }

            // Check if item already exists
            const existingIndex = currentScenario.items.findIndex(
                item => item.category === category && item.item === itemName
            );

            if (existingIndex >= 0) {
                currentScenario.items[existingIndex].qty++;
            } else {
                currentScenario.items.push({
                    category: category,
                    item: itemName,
                    qty: 1
                });
            }

            renderScenario();
            calculateScenario();

            // Reset selects
            document.getElementById('add-category').value = '';
            document.getElementById('add-item').innerHTML = '<option value="">-- Selecciona plato --</option>';
        }

        // Calculate scenario totals
        function calculateScenario() {
            if (!currentScenario.groupType) return;

            let totalPrice = 0;
            let totalCost = 0;

            // Calculate food and drinks
            currentScenario.items.forEach(item => {
                const menuItem = menuItems[item.category].find(mi => mi.name === item.item);
                if (menuItem) {
                    totalPrice += menuItem.price * item.qty;
                    totalCost += menuItem.cost * item.qty;
                }
            });

            const margin = totalPrice - totalCost;
            const marginPct = (margin / totalPrice) * 100;
            const avgPerPerson = totalPrice / currentScenario.people;

            // Update display
            document.getElementById('summary-people').textContent = currentScenario.people;
            document.getElementById('summary-total').textContent = totalPrice.toFixed(2) + '‚Ç¨';
            document.getElementById('summary-avg').textContent = avgPerPerson.toFixed(2) + '‚Ç¨';
            document.getElementById('summary-cost').textContent = totalCost.toFixed(2) + '‚Ç¨';
            document.getElementById('summary-margin').textContent = margin.toFixed(2) + '‚Ç¨';
            document.getElementById('summary-margin-pct').textContent = marginPct.toFixed(1) + '%';

            // Show save scenario section if there are items
            if (currentScenario.items.length > 0) {
                document.getElementById('save-scenario-section').style.display = 'block';
            }
        }

        // Switch between single and compare mode
        function switchMode(mode) {
            const singleContainer = document.getElementById('single-mode-container');
            const compareContainer = document.getElementById('compare-mode-container');
            const singleBtn = document.getElementById('mode-single');
            const compareBtn = document.getElementById('mode-compare');

            if (mode === 'single') {
                singleContainer.style.display = 'block';
                compareContainer.style.display = 'none';
                singleBtn.style.background = '#667eea';
                singleBtn.style.color = 'white';
                compareBtn.style.background = 'white';
                compareBtn.style.color = '#667eea';
            } else if (mode === 'saved') {
                singleContainer.style.display = 'none';
                compareContainer.style.display = 'block';
                singleBtn.style.background = 'white';
                singleBtn.style.color = '#667eea';
                compareBtn.style.background = '#667eea';
                compareBtn.style.color = 'white';
                renderSavedScenarios();
            }
        }

        // Adjust quantities to respect rules before generating random menu
        function adjustQuantitiesForRules(quantities, people) {
            const activeRules = menuRules.filter(r => r.is_active && r.rule_type === 'max');

            // Create a copy to modify
            const adjusted = { ...quantities };

            // Check each rule
            for (const rule of activeRules) {
                // Calculate total for this rule's categories
                let total = 0;
                const relevantCategories = [];

                for (const category of rule.categories) {
                    if (adjusted[category] !== undefined) {
                        total += adjusted[category];
                        relevantCategories.push(category);
                    }
                }

                if (relevantCategories.length === 0) continue;

                // Calculate limit for this rule
                let limit;
                if (rule.per_people) {
                    limit = Math.floor(people / rule.per_people) * rule.quantity;
                } else {
                    limit = rule.quantity;
                }

                // If total exceeds limit, proportionally reduce
                if (total > limit) {
                    console.log(`Rule violation detected: ${total} > ${limit} for categories: ${relevantCategories.join(', ')}`);
                    console.log(`Adjusting quantities to respect rule...`);

                    const ratio = limit / total;

                    // Apply reduction proportionally to all categories in the rule
                    for (const category of relevantCategories) {
                        const originalQty = adjusted[category];
                        adjusted[category] = Math.floor(originalQty * ratio);
                        console.log(`  ${category}: ${originalQty} ‚Üí ${adjusted[category]}`);
                    }
                }
            }

            return adjusted;
        }

        // Generate random menu based on persona patterns
        function generateRandomMenu() {
            const clientCount = parseInt(document.getElementById('client-count').value);
            const personaType = document.getElementById('persona-type').value;

            if (!clientCount || !personaType) {
                alert('Por favor introduce el n√∫mero de clientes y selecciona el tipo de persona primero');
                return;
            }

            const persona = personaPatterns[personaType];
            const people = clientCount;

            // Update current scenario
            currentScenario = {
                groupType: personaType,
                people: people,
                items: []
            };

            // Calculate number of items based on persona patterns
            let numAperitivos = Math.max(0, Math.round(people * persona.aperitivos));
            let numEntrantes = Math.max(0, Math.round(people * persona.entrantes));
            let numCarnes = Math.max(1, Math.round(people * persona.carnes)); // At least 1 main course
            let numGuarniciones = Math.max(0, Math.round(people * persona.guarniciones));
            let numPostres = Math.max(0, Math.round(people * persona.postres));

            // Adjust quantities to respect rules BEFORE generating
            const adjustedQuantities = adjustQuantitiesForRules({
                aperitivos: numAperitivos,
                entrantes: numEntrantes,
                ensaladas: 0,
                carnes: numCarnes,
                guarniciones: numGuarniciones,
                postres: numPostres
            }, people);

            numAperitivos = adjustedQuantities.aperitivos;
            numEntrantes = adjustedQuantities.entrantes;
            numCarnes = adjustedQuantities.carnes;
            numGuarniciones = adjustedQuantities.guarniciones;
            numPostres = adjustedQuantities.postres;

            // Calculate drinks - 30% coffees from total bebidas, rest are alcoholic/soft drinks
            const totalBebidas = Math.round(people * persona.bebidas);
            const numCoffees = Math.round(totalBebidas * 0.2);
            const numDrinks = totalBebidas - numCoffees;

            // Generate random selection
            const randomItems = [];

            // Premium items limits (1 per 4 people)
            const premiumItemLimits = {
                'Plato de jam√≥n': Math.ceil(people / 4),
                'Plato de queso': Math.ceil(people / 4)
            };

            // Wine bottle limit (1 per 3 people)
            const wineBottleLimit = Math.floor(people / 3);

            // Helper function to check if item is a wine bottle
            function isWineBottle(itemName, category) {
                const wineCategories = ['vinosblancos', 'vinostintos', 'vinosrosados'];
                return wineCategories.includes(category) && itemName.includes('Botella');
            }

            // Helper function to count current wine bottles
            function countWineBottles() {
                return randomItems.reduce((count, item) => {
                    if (isWineBottle(item.item, item.category)) {
                        return count + item.qty;
                    }
                    return count;
                }, 0);
            }

            // Helper function to check if item can be added
            function canAddPremiumItem(itemName, currentQty, category) {
                // Check specific premium items
                if (premiumItemLimits[itemName] !== undefined) {
                    return currentQty < premiumItemLimits[itemName];
                }

                // Check wine bottles limit
                if (isWineBottle(itemName, category)) {
                    return countWineBottles() < wineBottleLimit;
                }

                return true;
            }

            // Add random aperitivos
            for (let i = 0; i < numAperitivos; i++) {
                const items = menuItems.aperitivos;
                let attempts = 0;
                let item;

                // Try to find a valid item (max 10 attempts to avoid infinite loop)
                do {
                    item = items[Math.floor(Math.random() * items.length)];
                    const existing = randomItems.find(ri => ri.category === 'aperitivos' && ri.item === item.name);
                    const currentQty = existing ? existing.qty : 0;

                    if (canAddPremiumItem(item.name, currentQty, 'aperitivos')) {
                        if (existing) {
                            existing.qty++;
                        } else {
                            randomItems.push({ category: 'aperitivos', item: item.name, qty: 1 });
                        }
                        break;
                    }
                    attempts++;
                } while (attempts < 10);
            }

            // Add random entrantes
            for (let i = 0; i < numEntrantes; i++) {
                const items = menuItems.entrantes;
                let attempts = 0;
                let item;

                // Try to find a valid item (max 10 attempts to avoid infinite loop)
                do {
                    item = items[Math.floor(Math.random() * items.length)];
                    const existing = randomItems.find(ri => ri.category === 'entrantes' && ri.item === item.name);
                    const currentQty = existing ? existing.qty : 0;

                    if (canAddPremiumItem(item.name, currentQty, 'entrantes')) {
                        if (existing) {
                            existing.qty++;
                        } else {
                            randomItems.push({ category: 'entrantes', item: item.name, qty: 1 });
                        }
                        break;
                    }
                    attempts++;
                } while (attempts < 10);
            }

            // Add random carnes
            for (let i = 0; i < numCarnes; i++) {
                const items = menuItems.carnes;
                let item;

                // For Steak Lovers, 70% chance to select premium cuts (Chulet√≥n or Entrecot)
                if (personaType === 'steaklovers' && Math.random() < 0.7) {
                    const premiumCuts = items.filter(meat =>
                        meat.name === 'Chulet√≥n Premium' ||
                        meat.name === 'Entrecot' ||
                        meat.name === 'Lomo Bajo Premium'
                    );
                    item = premiumCuts[Math.floor(Math.random() * premiumCuts.length)];
                } else {
                    item = items[Math.floor(Math.random() * items.length)];
                }

                const existing = randomItems.find(ri => ri.category === 'carnes' && ri.item === item.name);
                if (existing) {
                    existing.qty++;
                } else {
                    randomItems.push({ category: 'carnes', item: item.name, qty: 1 });
                }
            }

            // Add random guarniciones
            for (let i = 0; i < numGuarniciones; i++) {
                const items = menuItems.guarniciones;
                const item = items[Math.floor(Math.random() * items.length)];
                const existing = randomItems.find(ri => ri.category === 'guarniciones' && ri.item === item.name);
                if (existing) {
                    existing.qty++;
                } else {
                    randomItems.push({ category: 'guarniciones', item: item.name, qty: 1 });
                }
            }

            // Add random postres
            for (let i = 0; i < numPostres; i++) {
                const items = menuItems.postres;
                const item = items[Math.floor(Math.random() * items.length)];
                const existing = randomItems.find(ri => ri.category === 'postres' && ri.item === item.name);
                if (existing) {
                    existing.qty++;
                } else {
                    randomItems.push({ category: 'postres', item: item.name, qty: 1 });
                }
            }

            // Add random coffees
            for (let i = 0; i < numCoffees; i++) {
                const items = menuItems.cafes;
                const item = items[Math.floor(Math.random() * items.length)];
                const existing = randomItems.find(ri => ri.category === 'cafes' && ri.item === item.name);
                if (existing) {
                    existing.qty++;
                } else {
                    randomItems.push({ category: 'cafes', item: item.name, qty: 1 });
                }
            }

            // Add random drinks (beers, wines, soft drinks) based on persona
            const drinkCategories = ['cervezas', 'vinostintos', 'vinosblancos', 'refrescos'];

            for (let i = 0; i < numDrinks; i++) {
                // Random category weighted towards beers and wines
                const rand = Math.random();
                let category;
                if (rand < 0.35) category = 'cervezas';
                else if (rand < 0.60) category = 'vinostintos';
                else if (rand < 0.80) category = 'vinosblancos';
                else category = 'refrescos';

                const items = menuItems[category];
                if (items && items.length > 0) {
                    let attempts = 0;
                    let item;

                    // Try to find a valid item (max 10 attempts to avoid infinite loop)
                    do {
                        item = items[Math.floor(Math.random() * items.length)];
                        const existing = randomItems.find(ri => ri.category === category && ri.item === item.name);
                        const currentQty = existing ? existing.qty : 0;

                        // Check if we can add this item (respects wine bottle limits)
                        if (canAddPremiumItem(item.name, currentQty, category)) {
                            if (existing) {
                                existing.qty++;
                            } else {
                                randomItems.push({ category: category, item: item.name, qty: 1 });
                            }
                            break;
                        }
                        attempts++;
                    } while (attempts < 10);
                }
            }

            // Update current scenario with random items
            currentScenario.items = randomItems;
            document.getElementById('menu-selection').style.display = 'block';
            renderScenario();
            calculateScenario();
        }

        // Update comparison table
        function updateComparison() {
            const checkboxes = document.querySelectorAll('#compare-mode-container input[type="checkbox"]');
            const selectedScenarios = [];

            checkboxes.forEach(cb => {
                if (cb.checked) {
                    selectedScenarios.push(cb.value);
                }
            });

            if (selectedScenarios.length === 0) {
                document.getElementById('comparison-results').innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Selecciona al menos un escenario para ver la comparaci√≥n</p>';
                return;
            }

            // Calculate metrics for each scenario
            const comparisons = selectedScenarios.map(scenarioType => {
                const scenario = scenarios[scenarioType];
                let totalPrice = 0;
                let totalCost = 0;

                scenario.items.forEach(item => {
                    const menuItem = menuItems[item.category].find(mi => mi.name === item.item);
                    if (menuItem) {
                        totalPrice += menuItem.price * item.qty;
                        totalCost += menuItem.cost * item.qty;
                    }
                });

                const margin = totalPrice - totalCost;
                const marginPct = (margin / totalPrice) * 100;
                const avgPerPerson = totalPrice / scenario.people;

                return {
                    type: scenarioType,
                    name: getScenarioName(scenarioType),
                    people: scenario.people,
                    totalPrice,
                    totalCost,
                    margin,
                    marginPct,
                    avgPerPerson,
                    items: scenario.items
                };
            });

            // Sort by total price descending
            comparisons.sort((a, b) => b.totalPrice - a.totalPrice);

            // Helper function to group items by category
            function getItemsSummary(items) {
                const drinkCategories = ['cervezas', 'vinosblancos', 'vinosrosados', 'vinostintos', 'espumosos', 'aperitivos_bebidas', 'refrescos', 'zumos', 'aguas'];
                const entrantesCategories = ['aperitivos', 'entrantes'];
                const carnesCategories = ['carnes', 'guarniciones'];
                const postresCategories = ['postres', 'cafes'];

                const categoryNames = {
                    'bebidas': 'üçπ Bebidas',
                    'entrantes_aperitivos': 'üçΩÔ∏è Entrantes y Aperitivos',
                    'ensaladas': 'ü•ó Ensaladas',
                    'carnes_guarniciones': 'ü•© Carnes y Guarniciones',
                    'postres_cafes': 'üç∞ Postres y Caf√©s'
                };

                const grouped = {};
                items.forEach(item => {
                    // Group categories
                    let category = item.category;
                    if (drinkCategories.includes(item.category)) {
                        category = 'bebidas';
                    } else if (entrantesCategories.includes(item.category)) {
                        category = 'entrantes_aperitivos';
                    } else if (carnesCategories.includes(item.category)) {
                        category = 'carnes_guarniciones';
                    } else if (postresCategories.includes(item.category)) {
                        category = 'postres_cafes';
                    }

                    if (!grouped[category]) {
                        grouped[category] = [];
                    }
                    grouped[category].push(item);
                });

                let summary = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; padding: 15px;">';

                Object.keys(grouped).forEach(category => {
                    const categoryItems = grouped[category];
                    summary += `
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 3px solid #667eea;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: #667eea;">
                                ${categoryNames[category] || category}
                            </div>
                            <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: #555;">
                    `;
                    categoryItems.forEach(item => {
                        const menuItem = menuItems[item.category].find(mi => mi.name === item.item);
                        const price = menuItem ? menuItem.price.toFixed(2) : '?.??';

                        // Add (Botella) tag for wine bottles
                        const wineCategories = ['vinosblancos', 'vinostintos', 'vinosrosados'];
                        const isBottle = menuItem && menuItem.desc && menuItem.desc.includes('Botella');
                        const isWine = wineCategories.includes(item.category);
                        const bottleTag = (isWine && isBottle) ? ' üç∑' : '';

                        summary += `<li>${item.item}${bottleTag} <span style="color: #888;">(√ó${item.qty}) - ${price}‚Ç¨</span></li>`;
                    });
                    summary += `
                            </ul>
                        </div>
                    `;
                });

                summary += '</div>';
                return summary;
            }

            // Render comparison table
            let html = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <th style="padding: 15px; text-align: left;">Escenario</th>
                                <th style="padding: 15px; text-align: center;">Personas</th>
                                <th style="padding: 15px; text-align: right;">Ticket Total</th>
                                <th style="padding: 15px; text-align: right;">Ticket/Persona</th>
                                <th style="padding: 15px; text-align: right;">Coste Total</th>
                                <th style="padding: 15px; text-align: right;">Margen ‚Ç¨</th>
                                <th style="padding: 15px; text-align: right;">Margen %</th>
                                <th style="padding: 15px; text-align: center;">Detalle</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            comparisons.forEach((comp, index) => {
                const bgColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                const rowId = `row-${comp.type}`;
                const detailId = `detail-${comp.type}`;

                html += `
                    <tr style="background: ${bgColor};">
                        <td style="padding: 12px; font-weight: 600; color: #333;">${comp.name}</td>
                        <td style="padding: 12px; text-align: center;">${comp.people}</td>
                        <td style="padding: 12px; text-align: right; font-weight: 600; color: #667eea;">${comp.totalPrice.toFixed(2)}‚Ç¨</td>
                        <td style="padding: 12px; text-align: right;">${comp.avgPerPerson.toFixed(2)}‚Ç¨</td>
                        <td style="padding: 12px; text-align: right; color: #f44336;">${comp.totalCost.toFixed(2)}‚Ç¨</td>
                        <td style="padding: 12px; text-align: right; color: #4caf50; font-weight: 600;">${comp.margin.toFixed(2)}‚Ç¨</td>
                        <td style="padding: 12px; text-align: right;">
                            <span style="background: #4caf50; color: white; padding: 4px 12px; border-radius: 12px; font-weight: 600;">
                                ${comp.marginPct.toFixed(1)}%
                            </span>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <button onclick="toggleDetail('${detailId}')" style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;">
                                Ver Items
                            </button>
                        </td>
                    </tr>
                    <tr id="${detailId}" style="display: none; background: ${bgColor};">
                        <td colspan="8" style="padding: 0; border-top: 1px solid #e0e0e0;">
                            ${getItemsSummary(comp.items)}
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>

                <div style="margin-top: 30px; padding: 20px; background: #f0f7ff; border-left: 4px solid #667eea; border-radius: 6px;">
                    <h4 style="margin-top: 0; color: #667eea;">üí° Insights</h4>
                    <ul style="margin: 10px 0; padding-left: 20px; color: #555;">
                        <li><strong>Mejor ticket medio:</strong> ${comparisons.reduce((max, c) => c.avgPerPerson > max.avgPerPerson ? c : max).name} con ${comparisons.reduce((max, c) => c.avgPerPerson > max.avgPerPerson ? c : max).avgPerPerson.toFixed(2)}‚Ç¨/persona</li>
                        <li><strong>Mejor margen %:</strong> ${comparisons.reduce((max, c) => c.marginPct > max.marginPct ? c : max).name} con ${comparisons.reduce((max, c) => c.marginPct > max.marginPct ? c : max).marginPct.toFixed(1)}%</li>
                        <li><strong>Mayor ingreso total:</strong> ${comparisons[0].name} con ${comparisons[0].totalPrice.toFixed(2)}‚Ç¨</li>
                    </ul>
                </div>
            `;

            document.getElementById('comparison-results').innerHTML = html;
        }

        // Toggle detail row in comparison table
        function toggleDetail(detailId) {
            const detailRow = document.getElementById(detailId);
            if (detailRow.style.display === 'none') {
                detailRow.style.display = 'table-row';
            } else {
                detailRow.style.display = 'none';
            }
        }

        // Helper function to get scenario display name
        function getScenarioName(type) {
            const names = {
                'pareja': 'Pareja (2 personas)',
                'familia4': 'Familia (4 personas)',
                'familia6': 'Familia (6 personas)',
                'dos-parejas': '2 Parejas (4 personas)',
                'amigos4': 'Grupo amigos (4 personas)',
                'amigos6': 'Grupo amigos (6 personas)',
                'amigos8': 'Grupo amigos (8 personas)',
                'amigos10': 'Grupo amigos (10 personas)'
            };
            return names[type] || type;
        }

        // Save/Load Scenario Functions
        function saveCurrentScenario() {
            const nameInput = document.getElementById('scenario-name');
            const name = nameInput.value.trim();

            if (!name) {
                alert('Por favor introduce un nombre para el escenario');
                return;
            }

            const clientCount = parseInt(document.getElementById('client-count').value);
            const personaType = document.getElementById('persona-type').value;

            if (!clientCount || !personaType) {
                alert('Introduce el n√∫mero de clientes y selecciona el tipo de persona primero');
                return;
            }

            if (currentScenario.items.length === 0) {
                alert('A√±ade al menos un plato al escenario');
                return;
            }

            // Get saved scenarios from localStorage
            let savedScenarios = JSON.parse(localStorage.getItem('savedMenuScenarios') || '[]');

            // Create new scenario object
            const newScenario = {
                id: Date.now().toString(),
                name: name,
                groupType: personaType,
                people: clientCount,
                items: [...currentScenario.items],
                createdAt: new Date().toISOString()
            };

            // Add to saved scenarios
            savedScenarios.push(newScenario);
            localStorage.setItem('savedMenuScenarios', JSON.stringify(savedScenarios));

            // Clear input and show success
            nameInput.value = '';
            alert('Escenario guardado correctamente!');
        }

        function loadSavedScenarios() {
            return JSON.parse(localStorage.getItem('savedMenuScenarios') || '[]');
        }

        function renderSavedScenarios() {
            const savedScenarios = loadSavedScenarios();
            const container = document.getElementById('saved-scenarios-list');

            if (savedScenarios.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; background: #f8f9fa; border-radius: 8px; border: 2px dashed #ddd;">
                        <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;">üìã</div>
                        <p style="color: #666; font-size: 16px; margin: 0;">No hay escenarios guardados todav√≠a</p>
                        <p style="color: #999; font-size: 14px; margin: 10px 0 0 0;">Crea un escenario en "Crear Escenario" y gu√°rdalo para comparar</p>
                    </div>
                `;
                document.getElementById('comparison-results').innerHTML = '';
                return;
            }

            let html = '<div style="margin-bottom: 20px;"><label style="font-weight: bold; margin-bottom: 10px; display: block;">Selecciona escenarios para comparar:</label></div>';
            html += '<div style="display: grid; gap: 15px;">';

            savedScenarios.forEach(scenario => {
                html += `
                    <div style="display: flex; align-items: center; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; transition: all 0.2s;">
                        <input type="checkbox" id="scenario-${scenario.id}" value="${scenario.id}" onchange="updateSavedComparison()" style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;">
                        <label for="scenario-${scenario.id}" style="flex: 1; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${scenario.name}</div>
                                <div style="font-size: 13px; color: #666;">${scenario.people} personas ‚Ä¢ ${scenario.items.length} items ‚Ä¢ ${new Date(scenario.createdAt).toLocaleDateString()}</div>
                            </div>
                        </label>
                        <button onclick="deleteScenario('${scenario.id}')" style="padding: 8px 12px; background: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; margin-left: 10px;">
                            Eliminar
                        </button>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;

            // Clear comparison results initially
            document.getElementById('comparison-results').innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Selecciona al menos un escenario para ver la comparaci√≥n</p>';
        }

        function deleteScenario(id) {
            if (!confirm('¬øSeguro que quieres eliminar este escenario?')) {
                return;
            }

            let savedScenarios = loadSavedScenarios();
            savedScenarios = savedScenarios.filter(s => s.id !== id);
            localStorage.setItem('savedMenuScenarios', JSON.stringify(savedScenarios));
            renderSavedScenarios();
        }

        function updateSavedComparison() {
            const savedScenarios = loadSavedScenarios();
            const checkboxes = document.querySelectorAll('#saved-scenarios-list input[type="checkbox"]');
            const selectedIds = [];

            checkboxes.forEach(cb => {
                if (cb.checked) {
                    selectedIds.push(cb.value);
                }
            });

            if (selectedIds.length === 0) {
                document.getElementById('comparison-results').innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Selecciona al menos un escenario para ver la comparaci√≥n</p>';
                return;
            }

            // Calculate metrics for each selected scenario
            const comparisons = selectedIds.map(id => {
                const scenario = savedScenarios.find(s => s.id === id);
                if (!scenario) return null;

                let totalPrice = 0;
                let totalCost = 0;

                scenario.items.forEach(item => {
                    const menuItem = menuItems[item.category].find(mi => mi.name === item.item);
                    if (menuItem) {
                        totalPrice += menuItem.price * item.qty;
                        totalCost += menuItem.cost * item.qty;
                    }
                });

                const margin = totalPrice - totalCost;
                const marginPct = (margin / totalPrice) * 100;
                const avgPerPerson = totalPrice / scenario.people;

                return {
                    id: scenario.id,
                    name: scenario.name,
                    people: scenario.people,
                    totalPrice,
                    totalCost,
                    margin,
                    marginPct,
                    avgPerPerson,
                    items: scenario.items
                };
            }).filter(c => c !== null);

            // Sort by total price descending
            comparisons.sort((a, b) => b.totalPrice - a.totalPrice);

            // Helper function to group items by category
            function getItemsSummary(items) {
                const drinkCategories = ['cervezas', 'vinosblancos', 'vinosrosados', 'vinostintos', 'espumosos', 'aperitivos_bebidas', 'refrescos', 'zumos', 'aguas'];
                const entrantesCategories = ['aperitivos', 'entrantes'];
                const carnesCategories = ['carnes', 'guarniciones'];
                const postresCategories = ['postres', 'cafes'];

                const categoryNames = {
                    'bebidas': 'üçπ Bebidas',
                    'entrantes_aperitivos': 'üçΩÔ∏è Entrantes y Aperitivos',
                    'ensaladas': 'ü•ó Ensaladas',
                    'carnes_guarniciones': 'ü•© Carnes y Guarniciones',
                    'postres_cafes': 'üç∞ Postres y Caf√©s'
                };

                const grouped = {};
                items.forEach(item => {
                    // Group categories
                    let category = item.category;
                    if (drinkCategories.includes(item.category)) {
                        category = 'bebidas';
                    } else if (entrantesCategories.includes(item.category)) {
                        category = 'entrantes_aperitivos';
                    } else if (carnesCategories.includes(item.category)) {
                        category = 'carnes_guarniciones';
                    } else if (postresCategories.includes(item.category)) {
                        category = 'postres_cafes';
                    }

                    if (!grouped[category]) {
                        grouped[category] = [];
                    }
                    grouped[category].push(item);
                });

                let summary = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; padding: 15px;">';

                Object.keys(grouped).forEach(category => {
                    const categoryItems = grouped[category];
                    summary += `
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 3px solid #667eea;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: #667eea;">
                                ${categoryNames[category] || category}
                            </div>
                            <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: #555;">
                    `;
                    categoryItems.forEach(item => {
                        const menuItem = menuItems[item.category].find(mi => mi.name === item.item);
                        const price = menuItem ? menuItem.price.toFixed(2) : '?.??';

                        // Add (Botella) tag for wine bottles
                        const wineCategories = ['vinosblancos', 'vinostintos', 'vinosrosados'];
                        const isBottle = menuItem && menuItem.desc && menuItem.desc.includes('Botella');
                        const isWine = wineCategories.includes(item.category);
                        const bottleTag = (isWine && isBottle) ? ' üç∑' : '';

                        summary += `<li>${item.item}${bottleTag} <span style="color: #888;">(√ó${item.qty}) - ${price}‚Ç¨</span></li>`;
                    });
                    summary += `
                            </ul>
                        </div>
                    `;
                });

                summary += '</div>';
                return summary;
            }

            // Render comparison table
            let html = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <th style="padding: 15px; text-align: left;">Escenario</th>
                                <th style="padding: 15px; text-align: center;">Personas</th>
                                <th style="padding: 15px; text-align: right;">Ticket Total</th>
                                <th style="padding: 15px; text-align: right;">Ticket/Persona</th>
                                <th style="padding: 15px; text-align: right;">Coste Total</th>
                                <th style="padding: 15px; text-align: right;">Margen ‚Ç¨</th>
                                <th style="padding: 15px; text-align: right;">Margen %</th>
                                <th style="padding: 15px; text-align: center;">Detalle</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            comparisons.forEach((comp, index) => {
                const bgColor = index % 2 === 0 ? '#f8f9fa' : 'white';
                const detailId = `detail-saved-${comp.id}`;

                html += `
                    <tr style="background: ${bgColor};">
                        <td style="padding: 12px; font-weight: 600; color: #333;">${comp.name}</td>
                        <td style="padding: 12px; text-align: center;">${comp.people}</td>
                        <td style="padding: 12px; text-align: right; font-weight: 600; color: #667eea;">${comp.totalPrice.toFixed(2)}‚Ç¨</td>
                        <td style="padding: 12px; text-align: right;">${comp.avgPerPerson.toFixed(2)}‚Ç¨</td>
                        <td style="padding: 12px; text-align: right; color: #f44336;">${comp.totalCost.toFixed(2)}‚Ç¨</td>
                        <td style="padding: 12px; text-align: right; color: #4caf50; font-weight: 600;">${comp.margin.toFixed(2)}‚Ç¨</td>
                        <td style="padding: 12px; text-align: right;">
                            <span style="background: #4caf50; color: white; padding: 4px 12px; border-radius: 12px; font-weight: 600;">
                                ${comp.marginPct.toFixed(1)}%
                            </span>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <button onclick="toggleDetail('${detailId}')" style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;">
                                Ver Items
                            </button>
                        </td>
                    </tr>
                    <tr id="${detailId}" style="display: none; background: ${bgColor};">
                        <td colspan="8" style="padding: 0; border-top: 1px solid #e0e0e0;">
                            ${getItemsSummary(comp.items)}
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>

                <div style="margin-top: 30px; padding: 20px; background: #f0f7ff; border-left: 4px solid #667eea; border-radius: 6px;">
                    <h4 style="margin-top: 0; color: #667eea;">üí° Insights</h4>
                    <ul style="margin: 10px 0; padding-left: 20px; color: #555;">
                        <li><strong>Mejor ticket medio:</strong> ${comparisons.reduce((max, c) => c.avgPerPerson > max.avgPerPerson ? c : max).name} con ${comparisons.reduce((max, c) => c.avgPerPerson > max.avgPerPerson ? c : max).avgPerPerson.toFixed(2)}‚Ç¨/persona</li>
                        <li><strong>Mejor margen %:</strong> ${comparisons.reduce((max, c) => c.marginPct > max.marginPct ? c : max).name} con ${comparisons.reduce((max, c) => c.marginPct > max.marginPct ? c : max).marginPct.toFixed(1)}%</li>
                        <li><strong>Mayor ingreso total:</strong> ${comparisons[0].name} con ${comparisons[0].totalPrice.toFixed(2)}‚Ç¨</li>
                    </ul>
                </div>
            `;

            document.getElementById('comparison-results').innerHTML = html;
        }

        // ==================== END MENU SIMULATOR ====================

        // Calcular IRPF progresivo seg√∫n tramos de Andaluc√≠a 2025
        function calculateProgressiveIRPF(grossAnnual) {
            // Tramos IRPF Andaluc√≠a 2025 (base liquidable)
            const brackets = [
                { limit: 12450, rate: 0.19 },
                { limit: 13000, rate: 0.215 },
                { limit: 20200, rate: 0.24 },
                { limit: 21000, rate: 0.27 },
                { limit: 35200, rate: 0.30 },
                { limit: 50000, rate: 0.37 },
                { limit: 60000, rate: 0.41 },
                { limit: Infinity, rate: 0.45 }
            ];

            let totalTax = 0;
            let previousLimit = 0;

            for (let bracket of brackets) {
                if (grossAnnual > previousLimit) {
                    const taxableInBracket = Math.min(grossAnnual, bracket.limit) - previousLimit;
                    totalTax += taxableInBracket * bracket.rate;
                    previousLimit = bracket.limit;
                } else {
                    break;
                }
            }

            return totalTax;
        }

        // Calcular tasa efectiva de IRPF (para estimaci√≥n)
        function calculateIRPFRate(grossMonthly) {
            const grossAnnual = grossMonthly * 12;
            const totalIRPF = calculateProgressiveIRPF(grossAnnual);
            return totalIRPF / grossAnnual;
        }
        
        // Calcular IRPF recomendado seg√∫n total devengado (independiente del IRPF manual)
        // La base para estimaci√≥n del IRPF = total_devengado - ss_trabajador
        // NO depende del neto ni del IRPF manual introducido
        function calculateRecommendedIRPF(totalDevengadoMensual) {
            if (!totalDevengadoMensual || totalDevengadoMensual <= 0) return 0;
            
            // Total devengado anual
            const totalDevengadoAnual = totalDevengadoMensual * 12;
            
            // Calcular SS empleado anual
            const ssEmpleadoAnual = totalDevengadoAnual * CONSTANTES.ss_trabajador;
            
            // Base imponible para IRPF = total_devengado - ss_trabajador
            const baseImponibleAnual = totalDevengadoAnual - ssEmpleadoAnual;
            
            // Si la base imponible es muy baja, el IRPF ser√° muy bajo o cero
            if (baseImponibleAnual <= 0) return 0;
            
            // Calcular IRPF progresivo seg√∫n tramos de Andaluc√≠a sobre la base imponible
            const irpfAnual = calculateProgressiveIRPF(baseImponibleAnual);
            
            // El IRPF en el sistema se aplica como porcentaje sobre la base de cotizaci√≥n (total devengado)
            // retencion_irpf = base_cotizacion * (irpf / 100)
            // Pero el IRPF real se calcula sobre la base imponible
            // 
            // Para encontrar el porcentaje que debemos aplicar sobre total_devengado:
            // Si IRPF_real = base_imponible * tasa_progresiva
            // Y queremos: IRPF_aplicado = total_devengado * porcentaje / 100
            // Y estos deben ser iguales: IRPF_real = IRPF_aplicado
            // Entonces: total_devengado * porcentaje / 100 = base_imponible * tasa_progresiva
            // porcentaje = (base_imponible * tasa_progresiva / total_devengado) * 100
            // porcentaje = (irpf_anual / total_devengado_anual) * 100
            
            const irpfPorcentaje = (irpfAnual / totalDevengadoAnual) * 100;
            
            return Math.max(0, Math.min(45, irpfPorcentaje));
        }

        // Calcular salario bruto desde salario neto (iterativo)
        function calculateGrossFromNet(netMonthly) {
            const SS_EMPLOYEE_RATE = 0.0648; // 6.48% Seguridad Social empleado
            const netAnnual = netMonthly * 12;

            // Estimaci√≥n inicial: el neto suele ser ~75-80% del bruto
            let grossAnnual = netAnnual / 0.77;
            let iterations = 0;
            const maxIterations = 100;

            while (iterations < maxIterations) {
                // Calcular SS empleado
                const ssEmployee = grossAnnual * SS_EMPLOYEE_RATE;

                // Base imponible para IRPF (despu√©s de SS empleado)
                const taxableBase = grossAnnual - ssEmployee;

                // Calcular IRPF progresivo
                const irpf = calculateProgressiveIRPF(taxableBase);

                // Neto = Bruto - SS Empleado - IRPF
                const calculatedNet = grossAnnual - ssEmployee - irpf;
                const difference = netAnnual - calculatedNet;

                // Convergencia
                if (Math.abs(difference) < 1) {
                    break;
                }

                // Ajustar bruto
                const effectiveRate = (ssEmployee + irpf) / grossAnnual;
                grossAnnual += difference / (1 - effectiveRate);
                iterations++;
            }

            return grossAnnual / 12; // Retornar mensual
        }

        // Calcular coste total anual para la empresa (nueva funci√≥n basada en puesto, horas, irpf)
        function calculateTotalCompanyCost(employee) {
            // Si employee es un objeto con puesto, horas_semanales, irpf, otros_pluses
            if (employee && typeof employee === 'object' && employee.puesto) {
                const result = calculateSalary(
                    employee.puesto,
                    employee.horas_semanales || 40,
                    employee.irpf || 0,
                    employee.otros_pluses || 0
                );
                return {
                    netMonthly: result.neto,
                    netAnnual: result.netAnnual,
                    grossMonthly: result.total_devengado,
                    grossAnnual: result.grossAnnual,
                    ssEmployee: result.ss_trabajador * 12,
                    irpf: result.irpf * 12,
                    companySS: result.companySS,
                    totalCost: result.totalCost,
                    // Datos adicionales del nuevo sistema
                    salario_base_completo: result.salario_base_completo,
                    salario_base_real: result.salario_base_real,
                    prorrata_pagas: result.prorrata_pagas,
                    plus_manutencion: result.plus_manutencion,
                    plus_transporte: result.plus_transporte,
                    otros_pluses: result.otros_pluses,
                    total_devengado: result.total_devengado,
                    base_cotizacion: result.base_cotizacion,
                    ss_trabajador: result.ss_trabajador,
                    ss_empresa: result.ss_empresa,
                    coste_empresa: result.coste_empresa
                };
            }
            // Compatibilidad hacia atr√°s: si se pasa un n√∫mero (netMonthly), usar c√°lculo antiguo
            const netMonthly = typeof employee === 'number' ? employee : (employee?.netMonthly || 0);
            const SS_EMPLOYEE_RATE = 0.0648;
            const SS_COMPANY_RATE = 0.3207;
            const grossMonthly = calculateGrossFromNet(netMonthly);
            const grossAnnual = grossMonthly * 12;
            const ssEmployee = grossAnnual * SS_EMPLOYEE_RATE;
            const taxableBase = grossAnnual - ssEmployee;
            const irpfAnnual = calculateProgressiveIRPF(taxableBase);
            const companySS = grossAnnual * SS_COMPANY_RATE;
            const totalCost = grossAnnual + companySS;
            return {
                netMonthly: netMonthly,
                netAnnual: netMonthly * 12,
                grossMonthly: grossMonthly,
                grossAnnual: grossAnnual,
                ssEmployee: ssEmployee,
                irpf: irpfAnnual,
                companySS: companySS,
                totalCost: totalCost
            };
        }

        let waterfallChart = null;
        let treasuryChart = null;
        let customEmployees = [];
        let customExpenses = [];
        let calendarData = [];
        let dailyPlanning = {}; // Store daily open/closed status and occupancy

        // ==================== MOBILE-FRIENDLY MODAL FUNCTIONS ====================
        let modalCallback = null;

        function openModal(title, bodyHTML, confirmText = 'Confirmar', onConfirm = null) {
            const modal = document.getElementById('mobile-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const confirmBtn = document.getElementById('modal-confirm-btn');

            modalTitle.textContent = title;
            modalBody.innerHTML = bodyHTML;
            confirmBtn.textContent = confirmText;
            modalCallback = onConfirm;

            modal.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scroll

            // Haptic feedback on supported devices
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
        }

        function closeModal() {
            const modal = document.getElementById('mobile-modal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
            modalCallback = null;
        }

        function confirmModal() {
            if (modalCallback) {
                modalCallback();
            }
            closeModal();
        }

        // ==================== TOUCH-FRIENDLY TOOLTIPS ====================
        let activeTooltip = null;

        function showTooltip(text, trigger) {
            hideTooltip(); // Close any existing tooltip

            const tooltipContent = document.getElementById('tooltip-content');
            const tooltipOverlay = document.getElementById('tooltip-overlay');

            tooltipContent.textContent = text;
            tooltipContent.classList.add('active');
            tooltipOverlay.classList.add('active');

            activeTooltip = tooltipContent;

            // Haptic feedback
            if (navigator.vibrate) {
                navigator.vibrate(5);
            }
        }

        function hideTooltip() {
            const tooltipContent = document.getElementById('tooltip-content');
            const tooltipOverlay = document.getElementById('tooltip-overlay');

            tooltipContent.classList.remove('active');
            tooltipOverlay.classList.remove('active');
            activeTooltip = null;
        }

        // ==================== SWIPE GESTURE SUPPORT ====================
        let touchStartX = 0;
        let touchEndX = 0;
        let currentMonthElement = null;

        function initSwipeGestures() {
            document.querySelectorAll('.month-section').forEach(monthSection => {
                monthSection.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                    currentMonthElement = monthSection;
                }, { passive: true });

                monthSection.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].screenX;
                    handleSwipe(currentMonthElement);
                }, { passive: true });
            });
        }

        function handleSwipe(element) {
            const swipeThreshold = 50;
            const swipeDistance = touchEndX - touchStartX;

            if (Math.abs(swipeDistance) < swipeThreshold) {
                return; // Not a swipe, just a tap
            }

            // Get all month sections
            const allMonths = Array.from(document.querySelectorAll('.month-section'));
            const currentIndex = allMonths.indexOf(element);

            if (swipeDistance > 0 && currentIndex > 0) {
                // Swipe right - go to previous month
                allMonths[currentIndex - 1].scrollIntoView({ behavior: 'smooth', block: 'start' });
                if (navigator.vibrate) navigator.vibrate(10);
            } else if (swipeDistance < 0 && currentIndex < allMonths.length - 1) {
                // Swipe left - go to next month
                allMonths[currentIndex + 1].scrollIntoView({ behavior: 'smooth', block: 'start' });
                if (navigator.vibrate) navigator.vibrate(10);
            }
        }

        // ==================== HAPTIC FEEDBACK ====================
        function vibrateLight() {
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
        }

        function vibrateMedium() {
            if (navigator.vibrate) {
                navigator.vibrate(20);
            }
        }


        // Mostrar/ocultar detalle de empleado
        function toggleEmployeeDetail(index) {
            const detail = document.getElementById(`emp-detail-${index}`);
            if (detail) {
                detail.classList.toggle('show');
            }
        }
        
        function toggleCustomEmployeeDetail(index) {
            const detail = document.getElementById(`custom-emp-detail-${index}`);
            if (detail) {
                detail.classList.toggle('show');
            }
        }
        
        // Actualizar desglose de empleado personalizado
        function updateEmployeeBreakdownForCustom(index, cost) {
            const breakdown = document.getElementById(`custom-emp-breakdown-${index}`);
            if (!breakdown) return;
            
            // Si tiene los nuevos campos, mostrar desglose completo
            if (cost.salario_base_completo !== undefined) {
                const totalDeducciones = cost.ss_trabajador + (cost.irpf / 12);
                breakdown.innerHTML = `
                    <div style="background: #f0f7ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #667eea;">
                        <h5 style="margin: 0 0 10px 0; color: #667eea; font-size: 1em;">üìä INGRESOS BRUTOS (Mensual)</h5>
                        <div class="detail-item" style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                            <label style="font-size: 0.9em;">Salario Base Completo (40h/sem)</label>
                            <div class="value" style="font-size: 0.95em;">${formatCurrency(cost.salario_base_completo)}</div>
                        </div>
                        <div class="detail-item" style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                            <label style="font-size: 0.9em;">‚Üí Salario Base Real (proporcional)</label>
                            <div class="value" style="font-size: 0.95em;">${formatCurrency(cost.salario_base_real)}</div>
                        </div>
                        <div class="detail-item" style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                            <label style="font-size: 0.9em;">+ Prorrata Pagas Extra (3 pagas/12 meses)</label>
                            <div class="value" style="font-size: 0.95em;">${formatCurrency(cost.prorrata_pagas)}</div>
                        </div>
                        <div class="detail-item" style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                            <label style="font-size: 0.9em;">+ Plus Manutenci√≥n</label>
                            <div class="value" style="font-size: 0.95em;">${formatCurrency(cost.plus_manutencion)}</div>
                        </div>
                        <div class="detail-item" style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                            <label style="font-size: 0.9em;">+ Plus Transporte</label>
                            <div class="value" style="font-size: 0.95em;">${formatCurrency(cost.plus_transporte)}</div>
                        </div>
                        ${cost.otros_pluses > 0 ? `
                        <div class="detail-item" style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                            <label style="font-size: 0.9em;">+ Otros Pluses</label>
                            <div class="value" style="font-size: 0.95em;">${formatCurrency(cost.otros_pluses)}</div>
                        </div>
                        ` : ''}
                        <div class="detail-item" style="background: #667eea; color: white; padding: 12px; border-radius: 4px; margin-top: 10px; border: none;">
                            <label style="font-weight: bold; font-size: 1em; color: white; margin: 0;">= TOTAL DEVENGADO</label>
                            <div class="value" style="font-weight: bold; font-size: 1.2em; color: white; margin: 0;">${formatCurrency(cost.total_devengado)}</div>
                        </div>
                    </div>

                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                        <h5 style="margin: 0 0 10px 0; color: #856404; font-size: 1em;">üí∞ DEDUCCIONES (Mensual)</h5>
                        <div class="detail-item" style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                            <label style="font-size: 0.9em;">Base Cotizaci√≥n (igual a Total Devengado)</label>
                            <div class="value" style="font-size: 0.95em;">${formatCurrency(cost.base_cotizacion)}</div>
                        </div>
                        <div class="detail-item" style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                            <label style="font-size: 0.9em;">- SS Trabajador (6.48%)</label>
                            <div class="value" style="font-size: 0.95em; color: #dc3545;">-${formatCurrency(cost.ss_trabajador)}</div>
                        </div>
                        <div class="detail-item" style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                            <label style="font-size: 0.9em;">- Retenci√≥n IRPF</label>
                            <div class="value" style="font-size: 0.95em; color: #dc3545;">-${formatCurrency(cost.irpf / 12)}</div>
                        </div>
                        <div class="detail-item" style="background: #ffc107; color: #856404; padding: 12px; border-radius: 4px; margin-top: 10px; border: none;">
                            <label style="font-weight: bold; font-size: 1em; color: #856404; margin: 0;">= TOTAL DEDUCCIONES</label>
                            <div class="value" style="font-weight: bold; font-size: 1.1em; color: #856404; margin: 0;">-${formatCurrency(totalDeducciones)}</div>
                        </div>
                        <div class="detail-item" style="background: #28a745; color: white; padding: 12px; border-radius: 4px; margin-top: 10px; border: none;">
                            <label style="font-weight: bold; font-size: 1em; color: white; margin: 0;">= SALARIO NETO MENSUAL</label>
                            <div class="value" style="font-weight: bold; font-size: 1.3em; color: white; margin: 0;">${formatCurrency(cost.netMonthly)}</div>
                        </div>
                    </div>

                    <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545;">
                        <h5 style="margin: 0 0 10px 0; color: #721c24; font-size: 1em;">üè¢ COSTE PARA LA EMPRESA</h5>
                        <div class="detail-item" style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                            <label style="font-size: 0.9em;">Total Devengado</label>
                            <div class="value" style="font-size: 0.95em;">${formatCurrency(cost.total_devengado)}</div>
                        </div>
                        <div class="detail-item" style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                            <label style="font-size: 0.9em;">+ SS Empresa (32.1%)</label>
                            <div class="value" style="font-size: 0.95em; color: #dc3545;">+${formatCurrency(cost.ss_empresa)}</div>
                        </div>
                        <div class="detail-item" style="background: #dc3545; color: white; padding: 12px; border-radius: 4px; margin-top: 10px; border: none;">
                            <label style="font-weight: bold; font-size: 1em; color: white; margin: 0;">= COSTE TOTAL EMPRESA (Mensual)</label>
                            <div class="value" style="font-weight: bold; font-size: 1.3em; color: white; margin: 0;">${formatCurrency(cost.coste_empresa)}</div>
                        </div>
                        <div class="detail-item" style="background: #721c24; color: white; padding: 12px; border-radius: 4px; margin-top: 10px; border: none;">
                            <label style="font-weight: bold; font-size: 1em; color: white; margin: 0;">= COSTE TOTAL EMPRESA (Anual)</label>
                            <div class="value" style="font-weight: bold; font-size: 1.4em; color: white; margin: 0;">${formatCurrency(cost.totalCost)}</div>
                        </div>
                    </div>
                `;
            } else {
                // Desglose antiguo (compatibilidad)
                breakdown.innerHTML = `
                    <div class="detail-item">
                        <label>Salario Neto Mensual</label>
                        <div class="value">${formatCurrency(cost.netMonthly)}</div>
                    </div>
                    <div class="detail-item">
                        <label>Salario Neto Anual</label>
                        <div class="value">${formatCurrency(cost.netAnnual)}</div>
                    </div>
                    <div class="detail-item">
                        <label>Salario Bruto Mensual</label>
                        <div class="value">${formatCurrency(cost.grossMonthly)}</div>
                    </div>
                    <div class="detail-item">
                        <label>Salario Bruto Anual</label>
                        <div class="value">${formatCurrency(cost.grossAnnual)}</div>
                    </div>
                    <div class="detail-item">
                        <label>SS Empleado (6.48%)</label>
                        <div class="value">${formatCurrency(cost.ssEmployee)}</div>
                    </div>
                    <div class="detail-item">
                        <label>IRPF Anual</label>
                        <div class="value">${formatCurrency(cost.irpf)}</div>
                    </div>
                    <div class="detail-item" style="border-left-color: #dc3545;">
                        <label>SS Empresa (32.07%)</label>
                        <div class="value">${formatCurrency(cost.companySS)}</div>
                    </div>
                    <div class="detail-item" style="border-left-color: #dc3545;">
                        <label><strong>COSTE TOTAL EMPRESA</strong></label>
                        <div class="value" style="color: #dc3545; font-size: 1.3em;">${formatCurrency(cost.totalCost)}</div>
                    </div>
                `;
            }
        }

        // A√±adir nuevo empleado
        function addNewEmployee() {
            // Generar opciones de puestos para el dropdown (ordenado alfab√©ticamente)
            let puestoOptions = '<option value="">Seleccionar puesto</option>';
            const puestosOrdenados = Object.keys(TABLA_SALARIAL).sort((a, b) => a.localeCompare(b, 'es'));
            puestosOrdenados.forEach(puesto => {
                puestoOptions += `<option value="${puesto}">${puesto}</option>`;
            });
            
            const modalBody = `
                <div class="modal-input-group">
                    <label>Nombre del empleado:</label>
                    <input type="text" id="new-employee-name" placeholder="Ej: Juan P√©rez" autocomplete="off">
                </div>
                <div class="modal-input-group">
                    <label>Puesto:</label>
                    <select id="new-employee-puesto" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
                        ${puestoOptions}
                    </select>
                </div>
                <div class="modal-input-group">
                    <label>Horas semanales:</label>
                    <input type="number" id="new-employee-horas" placeholder="40" min="1" max="80" step="1" value="40">
                </div>
                <div class="modal-input-group">
                    <label>IRPF (%):</label>
                    <input type="number" id="new-employee-irpf" placeholder="0" min="0" max="45" step="0.1" value="0">
                </div>
                <div class="modal-input-group">
                    <label>Otros pluses (‚Ç¨/mes):</label>
                    <input type="number" id="new-employee-pluses" placeholder="0" min="0" step="10" value="0">
                </div>
            `;

            openModal('A√±adir Nuevo Empleado', modalBody, 'A√±adir', () => {
                const name = document.getElementById('new-employee-name').value.trim();
                const puesto = document.getElementById('new-employee-puesto').value;
                const horas = parseFloat(document.getElementById('new-employee-horas').value);
                const irpf = parseFloat(document.getElementById('new-employee-irpf').value);
                const pluses = parseFloat(document.getElementById('new-employee-pluses').value) || 0;

                if (!name) {
                    alert('Por favor, introduce un nombre');
                    return;
                }

                if (!puesto) {
                    alert('Por favor, selecciona un puesto');
                    return;
                }

                if (!horas || horas <= 0) {
                    alert('Por favor, introduce horas semanales v√°lidas');
                    return;
                }

                if (irpf === undefined || irpf < 0) {
                    alert('Por favor, introduce un IRPF v√°lido');
                    return;
                }

                const newEmployee = {
                    name: name,
                    puesto: puesto,
                    horas_semanales: horas,
                    irpf: irpf,
                    otros_pluses: pluses
                };

                customEmployees.push(newEmployee);
                saveCustomEmployeesToStorage();
                renderEmployees();
                updateAllCalculations();
                vibrateMedium(); // Success feedback
            });
        }

        // Eliminar empleado base
        function removeEmployee(index) {
            if (confirm('¬øEliminar este empleado?')) {
                employees.splice(index, 1);
                saveEmployeesToStorage();
                renderEmployees();
                updateAllCalculations();
            }
        }
        
        // Eliminar empleado personalizado
        function removeCustomEmployee(index) {
            if (confirm('¬øEliminar este empleado?')) {
                customEmployees.splice(index, 1);
                saveCustomEmployeesToStorage();
                renderEmployees();
                updateAllCalculations();
            }
        }
        
        // Actualizar nombre de empleado base
        function updateEmployeeName(index, newName) {
            if (employees && employees[index] !== undefined) {
                employees[index].name = newName;
                saveEmployeesToStorage();
            }
        }
        
        // Actualizar nombre de empleado personalizado
        function updateCustomEmployeeName(index, newName) {
            if (customEmployees && customEmployees[index] !== undefined) {
                customEmployees[index].name = newName;
                saveCustomEmployeesToStorage();
            }
        }
        
        // Actualizar puesto de empleado base
        function updateEmployeePuesto(index, puesto) {
            if (employees && employees[index] !== undefined) {
                employees[index].puesto = puesto;
                saveEmployeesToStorage();
                updateEmployeeDisplays();
                updateAllCalculations();
            }
        }
        
        // Actualizar horas semanales de empleado base
        function updateEmployeeHoras(index, horas) {
            if (employees && employees[index] !== undefined) {
                employees[index].horas_semanales = horas;
                saveEmployeesToStorage();
                updateEmployeeDisplays();
                updateAllCalculations();
            }
        }
        
        // Actualizar IRPF de empleado base
        function updateEmployeeIRPF(index, irpf) {
            if (employees && employees[index] !== undefined) {
                employees[index].irpf = irpf;
                saveEmployeesToStorage();
                updateEmployeeDisplays();
                updateAllCalculations();
            }
        }
        
        // Actualizar otros pluses de empleado base
        function updateEmployeePluses(index, pluses) {
            if (employees && employees[index] !== undefined) {
                employees[index].otros_pluses = pluses;
                saveEmployeesToStorage();
                updateEmployeeDisplays();
                updateAllCalculations();
            }
        }
        
        // Actualizar puesto de empleado personalizado
        function updateCustomEmployeePuesto(index, puesto) {
            if (customEmployees && customEmployees[index] !== undefined) {
                customEmployees[index].puesto = puesto;
                saveCustomEmployeesToStorage();
                updateEmployeeDisplays();
                updateAllCalculations();
            }
        }
        
        // Actualizar horas semanales de empleado personalizado
        function updateCustomEmployeeHoras(index, horas) {
            if (customEmployees && customEmployees[index] !== undefined) {
                customEmployees[index].horas_semanales = horas;
                saveCustomEmployeesToStorage();
                updateEmployeeDisplays();
                updateAllCalculations();
            }
        }
        
        // Actualizar IRPF de empleado personalizado
        function updateCustomEmployeeIRPF(index, irpf) {
            if (customEmployees && customEmployees[index] !== undefined) {
                customEmployees[index].irpf = irpf;
                saveCustomEmployeesToStorage();
                updateEmployeeDisplays();
                updateAllCalculations();
            }
        }
        
        // Actualizar otros pluses de empleado personalizado
        function updateCustomEmployeePluses(index, pluses) {
            if (customEmployees && customEmployees[index] !== undefined) {
                customEmployees[index].otros_pluses = pluses;
                saveCustomEmployeesToStorage();
                updateEmployeeDisplays();
                updateAllCalculations();
            }
        }

        // Renderizar todos los empleados
        // Funci√≥n helper para generar dropdown de puestos (ordenado alfab√©ticamente)
        function generatePuestoDropdown(selectedPuesto, inputId, index, isCustom = false) {
            let options = '<option value="">Seleccionar puesto</option>';
            // Ordenar puestos alfab√©ticamente
            const puestosOrdenados = Object.keys(TABLA_SALARIAL).sort((a, b) => a.localeCompare(b, 'es'));
            puestosOrdenados.forEach(puesto => {
                const selected = puesto === selectedPuesto ? 'selected' : '';
                options += `<option value="${puesto}" ${selected}>${puesto}</option>`;
            });
            const updateFunc = isCustom ? `updateCustomEmployeePuesto(${index}, this.value)` : `updateEmployeePuesto(${index}, this.value)`;
            return `<select id="${inputId}" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-weight: 600;" onchange="${updateFunc}">${options}</select>`;
        }

        function renderEmployees() {
            const list = document.getElementById('employee-list');
            list.innerHTML = '';

            // Empleados base
            employees.forEach((emp, index) => {
                const container = document.createElement('div');
                // Asegurar que el empleado tenga los campos necesarios
                if (!emp.puesto) emp.puesto = 'Ayudante de Cocina';
                if (!emp.horas_semanales) emp.horas_semanales = 40;
                if (emp.irpf === undefined) emp.irpf = 0;
                if (emp.otros_pluses === undefined) emp.otros_pluses = 0;
                
                let cost = calculateTotalCompanyCost(emp);
                const totalDevengado = cost.total_devengado || cost.base_cotizacion || 0;
                const irpfRecommended = calculateRecommendedIRPF(totalDevengado);
                emp.irpf = Math.round(irpfRecommended * 10) / 10; // actualizar al recomendado autom√°ticamente
                cost = calculateTotalCompanyCost(emp); // recalcular con el IRPF actualizado
                const irpfRecommendedText = irpfRecommended > 0 ? `(recomendado: ${irpfRecommended.toFixed(1)}%)` : '';

                container.innerHTML = `
                    <div class="employee-item" style="display: grid; grid-template-columns: 1.5fr 2fr 0.8fr 0.8fr 0.8fr 1fr 1fr 60px; gap: 10px; padding: 12px 15px; align-items: center; border-bottom: 1px solid #e0e0e0;">
                        <div data-label="Nombre">
                            <input type="text" id="emp-name-${index}" value="${emp.name || ''}"
                                   placeholder="Nombre" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-weight: 600;" 
                                   oninput="updateEmployeeName(${index}, this.value)">
                        </div>
                        <div data-label="Puesto">
                            ${generatePuestoDropdown(emp.puesto, `emp-puesto-${index}`, index, false)}
                        </div>
                        <div data-label="Horas/sem" style="text-align: center;">
                            <input type="number" id="emp-horas-${index}" value="${emp.horas_semanales}"
                                   placeholder="40" step="1" min="1" max="80" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; text-align: center;"
                                   oninput="updateEmployeeHoras(${index}, parseFloat(this.value) || 0)">
                        </div>
                        <div data-label="IRPF (%)" style="text-align: center;">
                            <input type="number" id="emp-irpf-${index}" value="${emp.irpf}"
                                   placeholder="0" step="0.1" min="0" max="45" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; text-align: center;"
                                   oninput="updateEmployeeIRPF(${index}, parseFloat(this.value) || 0)">
                            <div style="font-size: 0.75em; color: #666; margin-top: 2px;" id="emp-irpf-recommended-${index}">
                                ${irpfRecommendedText}
                            </div>
                        </div>
                        <div data-label="Pluses (‚Ç¨)" style="text-align: center;">
                            <input type="number" id="emp-pluses-${index}" value="${emp.otros_pluses || 0}"
                                   placeholder="0" step="10" min="0" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; text-align: center;"
                                   oninput="updateEmployeePluses(${index}, parseFloat(this.value) || 0)">
                        </div>
                        <div data-label="Neto (‚Ç¨/mes)" style="text-align: center; font-weight: bold; color: #28a745;" id="emp-net-${index}">
                            ${formatCurrency(cost.netMonthly)}
                        </div>
                        <div data-label="Coste Anual (‚Ç¨)" style="text-align: center; font-weight: bold; color: #dc3545;" id="emp-cost-${index}">
                            ${formatCurrency(cost.totalCost)}
                        </div>
                        <div data-label="Acciones" style="display: flex; gap: 5px; justify-content: center;">
                            <button class="expand-btn" onclick="toggleEmployeeDetail(${index})" title="Ver desglose" style="width: 30px; height: 30px; padding: 0; font-size: 1.2em;">+</button>
                            <button onclick="removeEmployee(${index})" style="background: #dc3545; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; font-size: 1.2em; padding: 0;" title="Eliminar empleado">√ó</button>
                        </div>
                        <div class="employee-detail" id="emp-detail-${index}" style="grid-column: 1 / -1; margin-top: 15px; padding-top: 15px; border-top: 2px solid #667eea;">
                            <h4 style="margin-bottom: 10px; color: #667eea;">Desglose del Coste Anual</h4>
                            <div class="detail-grid" id="emp-breakdown-${index}">
                                <!-- Se llenar√° din√°micamente -->
                            </div>
                        </div>
                    </div>
                `;
                list.appendChild(container);
                updateEmployeeBreakdown(index, cost);
            });

            // Empleados personalizados
            customEmployees.forEach((emp, index) => {
                const customIndex = employees.length + index;
                const container = document.createElement('div');
                // Asegurar que el empleado tenga los campos necesarios
                if (!emp.puesto) emp.puesto = 'Ayudante de Cocina';
                if (!emp.horas_semanales) emp.horas_semanales = 40;
                if (emp.irpf === undefined) emp.irpf = 0;
                if (emp.otros_pluses === undefined) emp.otros_pluses = 0;
                
                let cost = calculateTotalCompanyCost(emp);
                const totalDevengado = cost.total_devengado || cost.base_cotizacion || 0;
                const irpfRecommended = calculateRecommendedIRPF(totalDevengado);
                emp.irpf = Math.round(irpfRecommended * 10) / 10; // actualizar al recomendado autom√°ticamente
                cost = calculateTotalCompanyCost(emp); // recalcular con el IRPF actualizado
                const irpfRecommendedText = irpfRecommended > 0 ? `(recomendado: ${irpfRecommended.toFixed(1)}%)` : '';

                container.innerHTML = `
                    <div class="employee-item" style="display: grid; grid-template-columns: 1.5fr 2fr 0.8fr 0.8fr 0.8fr 1fr 1fr 60px; gap: 10px; padding: 12px 15px; align-items: center; border-bottom: 1px solid #e0e0e0; border-left: 3px solid #ffc107; background: #fffbf0;">
                        <div data-label="Nombre">
                            <input type="text" id="custom-emp-name-${index}" value="${emp.name || ''}"
                                   placeholder="Nombre" style="width: 100%; padding: 8px; border: 2px solid #ffc107; border-radius: 6px; font-weight: 600;" 
                                   oninput="updateCustomEmployeeName(${index}, this.value)">
                        </div>
                        <div data-label="Puesto">
                            ${generatePuestoDropdown(emp.puesto, `custom-emp-puesto-${index}`, index, true)}
                        </div>
                        <div data-label="Horas/sem" style="text-align: center;">
                            <input type="number" id="custom-emp-horas-${index}" value="${emp.horas_semanales}"
                                   placeholder="40" step="1" min="1" max="80" style="width: 100%; padding: 8px; border: 2px solid #ffc107; border-radius: 6px; text-align: center;"
                                   oninput="updateCustomEmployeeHoras(${index}, parseFloat(this.value) || 0)">
                        </div>
                        <div data-label="IRPF (%)" style="text-align: center;">
                            <input type="number" id="custom-emp-irpf-${index}" value="${emp.irpf}"
                                   placeholder="0" step="0.1" min="0" max="45" style="width: 100%; padding: 8px; border: 2px solid #ffc107; border-radius: 6px; text-align: center;"
                                   oninput="updateCustomEmployeeIRPF(${index}, parseFloat(this.value) || 0)">
                            <div style="font-size: 0.75em; color: #666; margin-top: 2px;" id="custom-emp-irpf-recommended-${index}">
                                ${irpfRecommendedText}
                            </div>
                        </div>
                        <div data-label="Pluses (‚Ç¨)" style="text-align: center;">
                            <input type="number" id="custom-emp-pluses-${index}" value="${emp.otros_pluses || 0}"
                                   placeholder="0" step="10" min="0" style="width: 100%; padding: 8px; border: 2px solid #ffc107; border-radius: 6px; text-align: center;"
                                   oninput="updateCustomEmployeePluses(${index}, parseFloat(this.value) || 0)">
                        </div>
                        <div data-label="Neto (‚Ç¨/mes)" style="text-align: center; font-weight: bold; color: #28a745;" id="custom-emp-net-${index}">
                            ${formatCurrency(cost.netMonthly)}
                        </div>
                        <div data-label="Coste Anual (‚Ç¨)" style="text-align: center; font-weight: bold; color: #dc3545;" id="custom-emp-cost-${index}">
                            ${formatCurrency(cost.totalCost)}
                        </div>
                        <div data-label="Acciones" style="display: flex; gap: 5px; justify-content: center;">
                            <button class="expand-btn" onclick="toggleCustomEmployeeDetail(${index})" title="Ver desglose" style="width: 30px; height: 30px; padding: 0; font-size: 1.2em;">+</button>
                            <button onclick="removeCustomEmployee(${index})" style="background: #dc3545; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; font-size: 1.2em; padding: 0;" title="Eliminar empleado">√ó</button>
                        </div>
                        <div class="employee-detail" id="custom-emp-detail-${index}" style="grid-column: 1 / -1; margin-top: 15px; padding-top: 15px; border-top: 2px solid #ffc107;">
                            <h4 style="margin-bottom: 10px; color: #ffc107;">Desglose del Coste Anual</h4>
                            <div class="detail-grid" id="custom-emp-breakdown-${index}">
                                <!-- Se llenar√° din√°micamente -->
                            </div>
                        </div>
                    </div>
                `;
                list.appendChild(container);
                // Actualizar desglose del empleado personalizado
                const customBreakdown = document.getElementById(`custom-emp-breakdown-${index}`);
                if (customBreakdown) {
                    updateEmployeeBreakdownForCustom(index, cost);
                }
            });
            // Persistir IRPF actualizado al recomendado
            saveEmployeesToStorage();
            saveCustomEmployeesToStorage();
        }

        // Inicializar empleados
        function initEmployees() {
            // Cargar empleados desde localStorage
            loadEmployeesFromStorage();
            loadCustomEmployeesFromStorage();
            renderEmployees();
        }

        // A√±adir nuevo gasto
        function addNewExpense() {
            const modalBody = `
                <div class="modal-input-group">
                    <label>Nombre del gasto:</label>
                    <input type="text" id="new-expense-name" placeholder="Ej: Limpieza, Seguros..." autocomplete="off">
                </div>
                <div class="modal-input-group">
                    <label>Frecuencia:</label>
                    <select id="new-expense-frequency">
                        <option value="monthly">Mensual</option>
                        <option value="annual">Anual</option>
                    </select>
                </div>
                <div class="modal-input-group">
                    <label>Importe (‚Ç¨):</label>
                    <input type="number" id="new-expense-amount" placeholder="500" min="0" step="10" inputmode="decimal">
                </div>
            `;

            openModal('A√±adir Nuevo Gasto', modalBody, 'A√±adir', () => {
                const name = document.getElementById('new-expense-name').value.trim();
                const frequency = document.getElementById('new-expense-frequency').value;
                const amount = parseFloat(document.getElementById('new-expense-amount').value);

                if (!name) {
                    alert('Por favor, introduce un nombre para el gasto');
                    return;
                }

                if (!amount || amount < 0) {
                    alert('Por favor, introduce un importe v√°lido');
                    return;
                }

                const newExpense = {
                    name: name,
                    amount: amount,
                    frequency: frequency
                };

                customExpenses.push(newExpense);
                renderCustomExpenses();
                updateAllCalculations();
                vibrateMedium(); // Success feedback
            });
        }

        // Eliminar gasto personalizado
        function removeCustomExpense(index) {
            if (confirm('¬øEliminar este gasto?')) {
                customExpenses.splice(index, 1);
                renderCustomExpenses();
                updateAllCalculations();
            }
        }

        // Renderizar gastos personalizados
        function renderCustomExpenses() {
            const list = document.getElementById('custom-expenses-list');
            list.innerHTML = '';

            customExpenses.forEach((expense, index) => {
                const frequency = expense.frequency || 'annual'; // Default to annual for backwards compatibility
                const frequencyLabel = frequency === 'monthly' ? '‚Ç¨/mes' : '‚Ç¨/a√±o';

                const div = document.createElement('div');
                div.className = 'input-group';
                div.style.position = 'relative';
                div.innerHTML = `
                    <label>
                        <input type="text" id="custom-expense-name-${index}" value="${expense.name}"
                               placeholder="Nombre del gasto"
                               style="width: calc(100% - 50px); padding: 10px; border: 2px solid #ffc107; border-radius: 6px; font-weight: 600; margin-bottom: 5px;"
                               oninput="customExpenses[${index}].name = this.value">
                        <button onclick="removeCustomExpense(${index})"
                                style="position: absolute; right: 0; top: 0; background: #dc3545; color: white; border: none; width: 40px; height: 40px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1.2em;">√ó</button>
                    </label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" id="custom-expense-${index}" value="${expense.amount}"
                               placeholder="Importe (${frequencyLabel})" min="0"
                               style="flex: 1;"
                               oninput="customExpenses[${index}].amount = parseFloat(this.value) || 0; updateAllCalculations()">
                        <select id="custom-expense-freq-${index}"
                                style="padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-weight: 600;"
                                onchange="customExpenses[${index}].frequency = this.value; updateAllCalculations()">
                            <option value="monthly" ${frequency === 'monthly' ? 'selected' : ''}>Mensual</option>
                            <option value="annual" ${frequency === 'annual' ? 'selected' : ''}>Anual</option>
                        </select>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // Actualizar desglose de empleado
        function updateEmployeeBreakdown(index, cost) {
            const breakdown = document.getElementById(`emp-breakdown-${index}`);
            if (!breakdown) return;
            
            // Si tiene los nuevos campos, mostrar desglose completo
            if (cost.salario_base_completo !== undefined) {
                const totalDeducciones = cost.ss_trabajador + (cost.irpf / 12);
                breakdown.innerHTML = `
                    <div style="background: #f0f7ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #667eea;">
                        <h5 style="margin: 0 0 10px 0; color: #667eea; font-size: 1em;">üìä INGRESOS BRUTOS (Mensual)</h5>
                        <div class="detail-item" style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                            <label style="font-size: 0.9em;">Salario Base Completo (40h/sem)</label>
                            <div class="value" style="font-size: 0.95em;">${formatCurrency(cost.salario_base_completo)}</div>
                        </div>
                        <div class="detail-item" style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                            <label style="font-size: 0.9em;">‚Üí Salario Base Real (proporcional)</label>
                            <div class="value" style="font-size: 0.95em;">${formatCurrency(cost.salario_base_real)}</div>
                        </div>
                        <div class="detail-item" style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                            <label style="font-size: 0.9em;">+ Prorrata Pagas Extra (3 pagas/12 meses)</label>
                            <div class="value" style="font-size: 0.95em;">${formatCurrency(cost.prorrata_pagas)}</div>
                        </div>
                        <div class="detail-item" style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                            <label style="font-size: 0.9em;">+ Plus Manutenci√≥n</label>
                            <div class="value" style="font-size: 0.95em;">${formatCurrency(cost.plus_manutencion)}</div>
                        </div>
                        <div class="detail-item" style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                            <label style="font-size: 0.9em;">+ Plus Transporte</label>
                            <div class="value" style="font-size: 0.95em;">${formatCurrency(cost.plus_transporte)}</div>
                        </div>
                        ${cost.otros_pluses > 0 ? `
                        <div class="detail-item" style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                            <label style="font-size: 0.9em;">+ Otros Pluses</label>
                            <div class="value" style="font-size: 0.95em;">${formatCurrency(cost.otros_pluses)}</div>
                        </div>
                        ` : ''}
                        <div class="detail-item" style="background: #667eea; color: white; padding: 12px; border-radius: 4px; margin-top: 10px; border: none;">
                            <label style="font-weight: bold; font-size: 1em; color: white; margin: 0;">= TOTAL DEVENGADO</label>
                            <div class="value" style="font-weight: bold; font-size: 1.2em; color: white; margin: 0;">${formatCurrency(cost.total_devengado)}</div>
                        </div>
                    </div>

                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                        <h5 style="margin: 0 0 10px 0; color: #856404; font-size: 1em;">üí∞ DEDUCCIONES (Mensual)</h5>
                        <div class="detail-item" style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                            <label style="font-size: 0.9em;">Base Cotizaci√≥n (igual a Total Devengado)</label>
                            <div class="value" style="font-size: 0.95em;">${formatCurrency(cost.base_cotizacion)}</div>
                        </div>
                        <div class="detail-item" style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                            <label style="font-size: 0.9em;">- SS Trabajador (6.48%)</label>
                            <div class="value" style="font-size: 0.95em; color: #dc3545;">-${formatCurrency(cost.ss_trabajador)}</div>
                        </div>
                        <div class="detail-item" style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                            <label style="font-size: 0.9em;">- Retenci√≥n IRPF</label>
                            <div class="value" style="font-size: 0.95em; color: #dc3545;">-${formatCurrency(cost.irpf / 12)}</div>
                        </div>
                        <div class="detail-item" style="background: #ffc107; color: #856404; padding: 12px; border-radius: 4px; margin-top: 10px; border: none;">
                            <label style="font-weight: bold; font-size: 1em; color: #856404; margin: 0;">= TOTAL DEDUCCIONES</label>
                            <div class="value" style="font-weight: bold; font-size: 1.1em; color: #856404; margin: 0;">-${formatCurrency(totalDeducciones)}</div>
                        </div>
                        <div class="detail-item" style="background: #28a745; color: white; padding: 12px; border-radius: 4px; margin-top: 10px; border: none;">
                            <label style="font-weight: bold; font-size: 1em; color: white; margin: 0;">= SALARIO NETO MENSUAL</label>
                            <div class="value" style="font-weight: bold; font-size: 1.3em; color: white; margin: 0;">${formatCurrency(cost.netMonthly)}</div>
                        </div>
                    </div>

                    <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545;">
                        <h5 style="margin: 0 0 10px 0; color: #721c24; font-size: 1em;">üè¢ COSTE PARA LA EMPRESA</h5>
                        <div class="detail-item" style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                            <label style="font-size: 0.9em;">Total Devengado</label>
                            <div class="value" style="font-size: 0.95em;">${formatCurrency(cost.total_devengado)}</div>
                        </div>
                        <div class="detail-item" style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                            <label style="font-size: 0.9em;">+ SS Empresa (32.1%)</label>
                            <div class="value" style="font-size: 0.95em; color: #dc3545;">+${formatCurrency(cost.ss_empresa)}</div>
                        </div>
                        <div class="detail-item" style="background: #dc3545; color: white; padding: 12px; border-radius: 4px; margin-top: 10px; border: none;">
                            <label style="font-weight: bold; font-size: 1em; color: white; margin: 0;">= COSTE TOTAL EMPRESA (Mensual)</label>
                            <div class="value" style="font-weight: bold; font-size: 1.3em; color: white; margin: 0;">${formatCurrency(cost.coste_empresa)}</div>
                        </div>
                        <div class="detail-item" style="background: #721c24; color: white; padding: 12px; border-radius: 4px; margin-top: 10px; border: none;">
                            <label style="font-weight: bold; font-size: 1em; color: white; margin: 0;">= COSTE TOTAL EMPRESA (Anual)</label>
                            <div class="value" style="font-weight: bold; font-size: 1.4em; color: white; margin: 0;">${formatCurrency(cost.totalCost)}</div>
                        </div>
                    </div>
                `;
            } else {
                // Desglose antiguo (compatibilidad)
                breakdown.innerHTML = `
                    <div class="detail-item">
                        <label>Salario Neto Mensual</label>
                        <div class="value">${formatCurrency(cost.netMonthly)}</div>
                    </div>
                    <div class="detail-item">
                        <label>Salario Neto Anual</label>
                        <div class="value">${formatCurrency(cost.netAnnual)}</div>
                    </div>
                    <div class="detail-item">
                        <label>Salario Bruto Mensual</label>
                        <div class="value">${formatCurrency(cost.grossMonthly)}</div>
                    </div>
                    <div class="detail-item">
                        <label>Salario Bruto Anual</label>
                        <div class="value">${formatCurrency(cost.grossAnnual)}</div>
                    </div>
                    <div class="detail-item">
                        <label>SS Empleado (6.48%)</label>
                        <div class="value">${formatCurrency(cost.ssEmployee)}</div>
                    </div>
                    <div class="detail-item">
                        <label>IRPF Anual</label>
                        <div class="value">${formatCurrency(cost.irpf)}</div>
                    </div>
                    <div class="detail-item" style="border-left-color: #dc3545;">
                        <label>SS Empresa (32.07%)</label>
                        <div class="value">${formatCurrency(cost.companySS)}</div>
                    </div>
                    <div class="detail-item" style="border-left-color: #dc3545;">
                        <label><strong>COSTE TOTAL EMPRESA</strong></label>
                        <div class="value" style="color: #dc3545; font-size: 1.3em;">${formatCurrency(cost.totalCost)}</div>
                    </div>
                `;
            }
        }

        // Actualizar valores y c√°lculos
        // Actualizar displays de empleados sin re-renderizar
        function updateEmployeeDisplays() {
            // Actualizar empleados base
            employees.forEach((emp, index) => {
                const cost = calculateTotalCompanyCost(emp);
                const costDisplay = document.getElementById(`emp-cost-${index}`);
                const netDisplay = document.getElementById(`emp-net-${index}`);
                const irpfRecommended = document.getElementById(`emp-irpf-recommended-${index}`);
                if (costDisplay) {
                    costDisplay.textContent = formatCurrency(cost.totalCost);
                }
                if (netDisplay) {
                    netDisplay.textContent = formatCurrency(cost.netMonthly);
                }
                if (irpfRecommended) {
                    const totalDevengado = cost.total_devengado || cost.base_cotizacion || 0;
                    const recommended = calculateRecommendedIRPF(totalDevengado);
                    irpfRecommended.textContent = recommended > 0 ? `(recomendado: ${recommended.toFixed(1)}%)` : '';
                }
                // Actualizar desglose siempre (incluso si no est√° visible)
                updateEmployeeBreakdown(index, cost);
            });
            
            // Actualizar empleados personalizados
            customEmployees.forEach((emp, index) => {
                const cost = calculateTotalCompanyCost(emp);
                const costDisplay = document.getElementById(`custom-emp-cost-${index}`);
                const netDisplay = document.getElementById(`custom-emp-net-${index}`);
                const irpfRecommended = document.getElementById(`custom-emp-irpf-recommended-${index}`);
                if (costDisplay) {
                    costDisplay.textContent = formatCurrency(cost.totalCost);
                }
                if (netDisplay) {
                    netDisplay.textContent = formatCurrency(cost.netMonthly);
                }
                if (irpfRecommended) {
                    const totalDevengado = cost.total_devengado || cost.base_cotizacion || 0;
                    const recommended = calculateRecommendedIRPF(totalDevengado);
                    irpfRecommended.textContent = recommended > 0 ? `(recomendado: ${recommended.toFixed(1)}%)` : '';
                }
                // Actualizar desglose siempre (incluso si no est√° visible)
                const breakdown = document.getElementById(`custom-emp-breakdown-${index}`);
                if (breakdown) {
                    updateEmployeeBreakdownForCustom(index, cost);
                }
            });
        }

        function updateAllCalculations() {
            // Actualizar displays de rangos
            document.getElementById('capacidad-value').textContent = document.getElementById('capacidad').value;
            document.getElementById('ticket-value').textContent = document.getElementById('ticket').value + '‚Ç¨';
            document.getElementById('aprovisionamiento-value').textContent = document.getElementById('aprovisionamiento').value + '%';

            // Actualizar displays de empleados
            updateEmployeeDisplays();

            // Actualizar totales en las pesta√±as
            const totalPersonal = calculateMonthlyPersonalCost();
            const totalOperativos = calculateMonthlyOperativeCost();
            const totalOperativosMensual = calculateMonthlyOperativeCostMonthly();
            document.getElementById('total-personal').textContent = formatCurrency(totalPersonal);
            document.getElementById('total-operativos').textContent = formatCurrency(totalOperativos);
            document.getElementById('total-operativos-mensual').textContent = formatCurrency(totalOperativosMensual);
            
            // Actualizar totales mensuales de personal
            const monthlyBreakdown = calculateMonthlyPersonalBreakdown();
            document.getElementById('total-net-monthly').textContent = formatCurrency(monthlyBreakdown.netMonthly);
            document.getElementById('total-ss-employee-monthly').textContent = formatCurrency(monthlyBreakdown.ssEmployeeMonthly);
            document.getElementById('total-irpf-monthly').textContent = formatCurrency(monthlyBreakdown.irpfMonthly);
            document.getElementById('total-ss-company-monthly').textContent = formatCurrency(monthlyBreakdown.ssCompanyMonthly);
            document.getElementById('total-cost-monthly').textContent = formatCurrency(monthlyBreakdown.costMonthly);

            // Recalcular todo
            updateAllMonthStats();
            updateTreasuryChart();
            calculateYearlyResults();
        }

        // Update all month statistics
        function updateAllMonthStats() {
            const allMonths = Object.keys(groupByMonth()).sort();
            allMonths.forEach(yearMonth => {
                updateMonthSummary(yearMonth);
                updateMonthStats(yearMonth);
            });
        }

        // Calculate yearly results based on actual planning data
        function calculateYearlyResults() {
            const capacidad = parseFloat(document.getElementById('capacidad').value);
            const ticket = parseFloat(document.getElementById('ticket').value);
            const aprovisionamientoPct = parseFloat(document.getElementById('aprovisionamiento').value) / 100;

            // Calculate totals for 2025 (Nov-Dec only)
            let results2025 = { shifts: 0, revenue: 0, aprovisionamiento: 0, margen: 0 };
            let results2026 = { shifts: 0, revenue: 0, aprovisionamiento: 0, margen: 0 };
            let monthlyResults = [];

            const allMonths = Object.keys(groupByMonth()).sort();

            allMonths.forEach(yearMonth => {
                const [year, month] = yearMonth.split('-');
                const monthDays = calendarData.filter(day => {
                    const key = `${day.a√±o}-${String(day.mes).padStart(2, '0')}`;
                    return key === yearMonth;
                });

                let monthShifts = 0;
                let monthRevenue = 0;

                monthDays.forEach(day => {
                    const planning = dailyPlanning[day.fecha];
                    if (planning && planning.open) {
                        const shifts = planning.shifts || 2;
                        const occupancy = (planning.occupancy || 40) / 100;
                        const comensales = Math.round(capacidad * occupancy);
                        const revenue = comensales * ticket * shifts;

                        monthShifts += shifts;
                        monthRevenue += revenue;
                    }
                });

                const monthAprov = monthRevenue * aprovisionamientoPct;
                const monthMargen = monthRevenue - monthAprov;

                // Annual personnel cost (monthly basis)
                const monthPersonal = calculateMonthlyPersonalCost() / 12;
                const monthOperativos = calculateMonthlyOperativeCost() / 12;
                const monthResult = monthMargen - monthPersonal - monthOperativos;

                // Add to appropriate year
                if (year === '2025') {
                    results2025.shifts += monthShifts;
                    results2025.revenue += monthRevenue;
                    results2025.aprovisionamiento += monthAprov;
                    results2025.margen += monthMargen;
                } else if (year === '2026') {
                    results2026.shifts += monthShifts;
                    results2026.revenue += monthRevenue;
                    results2026.aprovisionamiento += monthAprov;
                    results2026.margen += monthMargen;
                }

                // Store monthly result
                monthlyResults.push({
                    yearMonth,
                    monthName: monthNames[parseInt(month)] + ' ' + year,
                    shifts: monthShifts,
                    revenue: monthRevenue,
                    aprovisionamiento: monthAprov,
                    margen: monthMargen,
                    personal: monthPersonal,
                    operativos: monthOperativos,
                    resultado: monthResult
                });
            });

            // Calculate final results for each year
            const totalPersonal2025 = calculateMonthlyPersonalCost() / 12 * 2; // 2 months
            const totalOperativos2025 = calculateMonthlyOperativeCost() / 12 * 2;
            const resultado2025 = results2025.margen - totalPersonal2025 - totalOperativos2025;

            const totalPersonal2026 = calculateMonthlyPersonalCost(); // 12 months
            const totalOperativos2026 = calculateMonthlyOperativeCost();
            const resultado2026 = results2026.margen - totalPersonal2026 - totalOperativos2026;

            // Render 2025 results
            renderYearResults('results-2025', {
                facturacion: results2025.revenue,
                aprovisionamiento: results2025.aprovisionamiento,
                margen: results2025.margen,
                personal: totalPersonal2025,
                operativos: totalOperativos2025,
                resultado: resultado2025
            });

            // Render 2026 results
            renderYearResults('results-2026', {
                facturacion: results2026.revenue,
                aprovisionamiento: results2026.aprovisionamiento,
                margen: results2026.margen,
                personal: totalPersonal2026,
                operativos: totalOperativos2026,
                resultado: resultado2026
            });

            // Render monthly table
            renderMonthlyResultsTable(monthlyResults);

            // Update chart with combined data
            updateResultsChart(results2025, results2026);
        }

        // Render year results
        function renderYearResults(containerId, results) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="flow-item revenue">
                    <div class="flow-label">Facturaci√≥n Bruta</div>
                    <div class="flow-operator"></div>
                    <div class="flow-value">${formatCurrency(results.facturacion)}</div>
                </div>
                <div class="flow-item expense">
                    <div class="flow-label">- Gastos de Aprovisionamiento</div>
                    <div class="flow-operator">‚àí</div>
                    <div class="flow-value">${formatCurrency(results.aprovisionamiento)}</div>
                </div>
                <div class="flow-item margin">
                    <div class="flow-label">= Margen Bruto</div>
                    <div class="flow-operator">=</div>
                    <div class="flow-value">${formatCurrency(results.margen)}</div>
                </div>
                <div class="flow-item expense">
                    <div class="flow-label">- Gastos de Personal</div>
                    <div class="flow-operator">‚àí</div>
                    <div class="flow-value">${formatCurrency(results.personal)}</div>
                </div>
                <div class="flow-item expense">
                    <div class="flow-label">- Gastos Operativos</div>
                    <div class="flow-operator">‚àí</div>
                    <div class="flow-value">${formatCurrency(results.operativos)}</div>
                </div>
                <div class="flow-item result ${results.resultado > 0 ? 'positive' : 'negative'}">
                    <div class="flow-label">= Resultado de Explotaci√≥n</div>
                    <div class="flow-operator">=</div>
                    <div class="flow-value">${formatCurrency(results.resultado)}</div>
                </div>
            `;
        }

        // Render monthly results table
        function renderMonthlyResultsTable(monthlyResults) {
            const tbody = document.getElementById('monthly-results-body');
            tbody.innerHTML = '';

            monthlyResults.forEach(month => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #ddd';

                const resultClass = month.resultado > 0 ? 'color: #28a745' : 'color: #dc3545';

                row.innerHTML = `
                    <td style="padding: 10px; border: 1px solid #ddd;">${month.monthName}</td>
                    <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${month.shifts}</td>
                    <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${formatCurrency(month.revenue)}</td>
                    <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${formatCurrency(month.aprovisionamiento)}</td>
                    <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${formatCurrency(month.margen)}</td>
                    <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${formatCurrency(month.personal)}</td>
                    <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">${formatCurrency(month.operativos)}</td>
                    <td style="padding: 10px; text-align: right; border: 1px solid #ddd; font-weight: bold; ${resultClass}">${formatCurrency(month.resultado)}</td>
                `;

                tbody.appendChild(row);
            });
        }

        // Update results chart
        function updateResultsChart(results2025, results2026) {
            const ctx = document.getElementById('waterfallChart');
            if (!ctx) return;

            if (waterfallChart) {
                waterfallChart.destroy();
            }

            // Combined totals
            const totalPersonal = calculateMonthlyPersonalCost() / 12 * 2 + calculateMonthlyPersonalCost();
            const totalOperativos = calculateMonthlyOperativeCost() / 12 * 2 + calculateMonthlyOperativeCost();
            const totalFacturacion = results2025.revenue + results2026.revenue;
            const totalAprov = results2025.aprovisionamiento + results2026.aprovisionamiento;
            const totalMargen = results2025.margen + results2026.margen;
            const totalResultado = totalMargen - totalPersonal - totalOperativos;

            waterfallChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [
                        'Facturaci√≥n\nBruta',
                        'Aprovisionamiento',
                        'Margen\nBruto',
                        'Gastos\nPersonal',
                        'Gastos\nOperativos',
                        'Resultado\nExplotaci√≥n'
                    ],
                    datasets: [{
                        label: 'Importe Total',
                        data: [
                            totalFacturacion,
                            totalAprov,
                            totalMargen,
                            totalPersonal,
                            totalOperativos,
                            totalResultado
                        ],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(220, 53, 69, 0.8)',
                            'rgba(23, 162, 184, 0.8)',
                            'rgba(220, 53, 69, 0.8)',
                            'rgba(220, 53, 69, 0.8)',
                            totalResultado > 0 ? 'rgba(40, 167, 69, 0.8)' : 'rgba(220, 53, 69, 0.8)'
                        ],
                        borderColor: [
                            'rgba(40, 167, 69, 1)',
                            'rgba(220, 53, 69, 1)',
                            'rgba(23, 162, 184, 1)',
                            'rgba(220, 53, 69, 1)',
                            'rgba(220, 53, 69, 1)',
                            totalResultado > 0 ? 'rgba(40, 167, 69, 1)' : 'rgba(220, 53, 69, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                },
                                font: {
                                    size: 13
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.parsed.y);
                                },
                                title: function(context) {
                                    return context[0].label.replace('\n', ' ');
                                }
                            },
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 16
                            },
                            padding: 12
                        },
                        title: {
                            display: true,
                            text: 'Flujo Financiero Total (2025-2026)',
                            font: {
                                size: 18,
                                weight: 'bold'
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        }
                    }
                }
            });
        }

        // Formatear moneda
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        // Calendar CSV data (embedded)
        const calendarCSV = `fecha,dia_semana,dia,mes,a√±o,semana_iso
2025-11-01,s√°bado,1,11,2025,44
2025-11-02,domingo,2,11,2025,44
2025-11-03,lunes,3,11,2025,45
2025-11-04,martes,4,11,2025,45
2025-11-05,mi√©rcoles,5,11,2025,45
2025-11-06,jueves,6,11,2025,45
2025-11-07,viernes,7,11,2025,45
2025-11-08,s√°bado,8,11,2025,45
2025-11-09,domingo,9,11,2025,45
2025-11-10,lunes,10,11,2025,46
2025-11-11,martes,11,11,2025,46
2025-11-12,mi√©rcoles,12,11,2025,46
2025-11-13,jueves,13,11,2025,46
2025-11-14,viernes,14,11,2025,46
2025-11-15,s√°bado,15,11,2025,46
2025-11-16,domingo,16,11,2025,46
2025-11-17,lunes,17,11,2025,47
2025-11-18,martes,18,11,2025,47
2025-11-19,mi√©rcoles,19,11,2025,47
2025-11-20,jueves,20,11,2025,47
2025-11-21,viernes,21,11,2025,47
2025-11-22,s√°bado,22,11,2025,47
2025-11-23,domingo,23,11,2025,47
2025-11-24,lunes,24,11,2025,48
2025-11-25,martes,25,11,2025,48
2025-11-26,mi√©rcoles,26,11,2025,48
2025-11-27,jueves,27,11,2025,48
2025-11-28,viernes,28,11,2025,48
2025-11-29,s√°bado,29,11,2025,48
2025-11-30,domingo,30,11,2025,48
2025-12-01,lunes,1,12,2025,49
2025-12-02,martes,2,12,2025,49
2025-12-03,mi√©rcoles,3,12,2025,49
2025-12-04,jueves,4,12,2025,49
2025-12-05,viernes,5,12,2025,49
2025-12-06,s√°bado,6,12,2025,49
2025-12-07,domingo,7,12,2025,49
2025-12-08,lunes,8,12,2025,50
2025-12-09,martes,9,12,2025,50
2025-12-10,mi√©rcoles,10,12,2025,50
2025-12-11,jueves,11,12,2025,50
2025-12-12,viernes,12,12,2025,50
2025-12-13,s√°bado,13,12,2025,50
2025-12-14,domingo,14,12,2025,50
2025-12-15,lunes,15,12,2025,51
2025-12-16,martes,16,12,2025,51
2025-12-17,mi√©rcoles,17,12,2025,51
2025-12-18,jueves,18,12,2025,51
2025-12-19,viernes,19,12,2025,51
2025-12-20,s√°bado,20,12,2025,51
2025-12-21,domingo,21,12,2025,51
2025-12-22,lunes,22,12,2025,52
2025-12-23,martes,23,12,2025,52
2025-12-24,mi√©rcoles,24,12,2025,52
2025-12-25,jueves,25,12,2025,52
2025-12-26,viernes,26,12,2025,52
2025-12-27,s√°bado,27,12,2025,52
2025-12-28,domingo,28,12,2025,52
2025-12-29,lunes,29,12,2025,1
2025-12-30,martes,30,12,2025,1
2025-12-31,mi√©rcoles,31,12,2025,1
2026-01-01,jueves,1,1,2026,1
2026-01-02,viernes,2,1,2026,1
2026-01-03,s√°bado,3,1,2026,1
2026-01-04,domingo,4,1,2026,1
2026-01-05,lunes,5,1,2026,2
2026-01-06,martes,6,1,2026,2
2026-01-07,mi√©rcoles,7,1,2026,2
2026-01-08,jueves,8,1,2026,2
2026-01-09,viernes,9,1,2026,2
2026-01-10,s√°bado,10,1,2026,2
2026-01-11,domingo,11,1,2026,2
2026-01-12,lunes,12,1,2026,3
2026-01-13,martes,13,1,2026,3
2026-01-14,mi√©rcoles,14,1,2026,3
2026-01-15,jueves,15,1,2026,3
2026-01-16,viernes,16,1,2026,3
2026-01-17,s√°bado,17,1,2026,3
2026-01-18,domingo,18,1,2026,3
2026-01-19,lunes,19,1,2026,4
2026-01-20,martes,20,1,2026,4
2026-01-21,mi√©rcoles,21,1,2026,4
2026-01-22,jueves,22,1,2026,4
2026-01-23,viernes,23,1,2026,4
2026-01-24,s√°bado,24,1,2026,4
2026-01-25,domingo,25,1,2026,4
2026-01-26,lunes,26,1,2026,5
2026-01-27,martes,27,1,2026,5
2026-01-28,mi√©rcoles,28,1,2026,5
2026-01-29,jueves,29,1,2026,5
2026-01-30,viernes,30,1,2026,5
2026-01-31,s√°bado,31,1,2026,5
2026-02-01,domingo,1,2,2026,5
2026-02-02,lunes,2,2,2026,6
2026-02-03,martes,3,2,2026,6
2026-02-04,mi√©rcoles,4,2,2026,6
2026-02-05,jueves,5,2,2026,6
2026-02-06,viernes,6,2,2026,6
2026-02-07,s√°bado,7,2,2026,6
2026-02-08,domingo,8,2,2026,6
2026-02-09,lunes,9,2,2026,7
2026-02-10,martes,10,2,2026,7
2026-02-11,mi√©rcoles,11,2,2026,7
2026-02-12,jueves,12,2,2026,7
2026-02-13,viernes,13,2,2026,7
2026-02-14,s√°bado,14,2,2026,7
2026-02-15,domingo,15,2,2026,7
2026-02-16,lunes,16,2,2026,8
2026-02-17,martes,17,2,2026,8
2026-02-18,mi√©rcoles,18,2,2026,8
2026-02-19,jueves,19,2,2026,8
2026-02-20,viernes,20,2,2026,8
2026-02-21,s√°bado,21,2,2026,8
2026-02-22,domingo,22,2,2026,8
2026-02-23,lunes,23,2,2026,9
2026-02-24,martes,24,2,2026,9
2026-02-25,mi√©rcoles,25,2,2026,9
2026-02-26,jueves,26,2,2026,9
2026-02-27,viernes,27,2,2026,9
2026-02-28,s√°bado,28,2,2026,9
2026-03-01,domingo,1,3,2026,9
2026-03-02,lunes,2,3,2026,10
2026-03-03,martes,3,3,2026,10
2026-03-04,mi√©rcoles,4,3,2026,10
2026-03-05,jueves,5,3,2026,10
2026-03-06,viernes,6,3,2026,10
2026-03-07,s√°bado,7,3,2026,10
2026-03-08,domingo,8,3,2026,10
2026-03-09,lunes,9,3,2026,11
2026-03-10,martes,10,3,2026,11
2026-03-11,mi√©rcoles,11,3,2026,11
2026-03-12,jueves,12,3,2026,11
2026-03-13,viernes,13,3,2026,11
2026-03-14,s√°bado,14,3,2026,11
2026-03-15,domingo,15,3,2026,11
2026-03-16,lunes,16,3,2026,12
2026-03-17,martes,17,3,2026,12
2026-03-18,mi√©rcoles,18,3,2026,12
2026-03-19,jueves,19,3,2026,12
2026-03-20,viernes,20,3,2026,12
2026-03-21,s√°bado,21,3,2026,12
2026-03-22,domingo,22,3,2026,12
2026-03-23,lunes,23,3,2026,13
2026-03-24,martes,24,3,2026,13
2026-03-25,mi√©rcoles,25,3,2026,13
2026-03-26,jueves,26,3,2026,13
2026-03-27,viernes,27,3,2026,13
2026-03-28,s√°bado,28,3,2026,13
2026-03-29,domingo,29,3,2026,13
2026-03-30,lunes,30,3,2026,14
2026-03-31,martes,31,3,2026,14
2026-04-01,mi√©rcoles,1,4,2026,14
2026-04-02,jueves,2,4,2026,14
2026-04-03,viernes,3,4,2026,14
2026-04-04,s√°bado,4,4,2026,14
2026-04-05,domingo,5,4,2026,14
2026-04-06,lunes,6,4,2026,15
2026-04-07,martes,7,4,2026,15
2026-04-08,mi√©rcoles,8,4,2026,15
2026-04-09,jueves,9,4,2026,15
2026-04-10,viernes,10,4,2026,15
2026-04-11,s√°bado,11,4,2026,15
2026-04-12,domingo,12,4,2026,15
2026-04-13,lunes,13,4,2026,16
2026-04-14,martes,14,4,2026,16
2026-04-15,mi√©rcoles,15,4,2026,16
2026-04-16,jueves,16,4,2026,16
2026-04-17,viernes,17,4,2026,16
2026-04-18,s√°bado,18,4,2026,16
2026-04-19,domingo,19,4,2026,16
2026-04-20,lunes,20,4,2026,17
2026-04-21,martes,21,4,2026,17
2026-04-22,mi√©rcoles,22,4,2026,17
2026-04-23,jueves,23,4,2026,17
2026-04-24,viernes,24,4,2026,17
2026-04-25,s√°bado,25,4,2026,17
2026-04-26,domingo,26,4,2026,17
2026-04-27,lunes,27,4,2026,18
2026-04-28,martes,28,4,2026,18
2026-04-29,mi√©rcoles,29,4,2026,18
2026-04-30,jueves,30,4,2026,18
2026-05-01,viernes,1,5,2026,18
2026-05-02,s√°bado,2,5,2026,18
2026-05-03,domingo,3,5,2026,18
2026-05-04,lunes,4,5,2026,19
2026-05-05,martes,5,5,2026,19
2026-05-06,mi√©rcoles,6,5,2026,19
2026-05-07,jueves,7,5,2026,19
2026-05-08,viernes,8,5,2026,19
2026-05-09,s√°bado,9,5,2026,19
2026-05-10,domingo,10,5,2026,19
2026-05-11,lunes,11,5,2026,20
2026-05-12,martes,12,5,2026,20
2026-05-13,mi√©rcoles,13,5,2026,20
2026-05-14,jueves,14,5,2026,20
2026-05-15,viernes,15,5,2026,20
2026-05-16,s√°bado,16,5,2026,20
2026-05-17,domingo,17,5,2026,20
2026-05-18,lunes,18,5,2026,21
2026-05-19,martes,19,5,2026,21
2026-05-20,mi√©rcoles,20,5,2026,21
2026-05-21,jueves,21,5,2026,21
2026-05-22,viernes,22,5,2026,21
2026-05-23,s√°bado,23,5,2026,21
2026-05-24,domingo,24,5,2026,21
2026-05-25,lunes,25,5,2026,22
2026-05-26,martes,26,5,2026,22
2026-05-27,mi√©rcoles,27,5,2026,22
2026-05-28,jueves,28,5,2026,22
2026-05-29,viernes,29,5,2026,22
2026-05-30,s√°bado,30,5,2026,22
2026-05-31,domingo,31,5,2026,22
2026-06-01,lunes,1,6,2026,23
2026-06-02,martes,2,6,2026,23
2026-06-03,mi√©rcoles,3,6,2026,23
2026-06-04,jueves,4,6,2026,23
2026-06-05,viernes,5,6,2026,23
2026-06-06,s√°bado,6,6,2026,23
2026-06-07,domingo,7,6,2026,23
2026-06-08,lunes,8,6,2026,24
2026-06-09,martes,9,6,2026,24
2026-06-10,mi√©rcoles,10,6,2026,24
2026-06-11,jueves,11,6,2026,24
2026-06-12,viernes,12,6,2026,24
2026-06-13,s√°bado,13,6,2026,24
2026-06-14,domingo,14,6,2026,24
2026-06-15,lunes,15,6,2026,25
2026-06-16,martes,16,6,2026,25
2026-06-17,mi√©rcoles,17,6,2026,25
2026-06-18,jueves,18,6,2026,25
2026-06-19,viernes,19,6,2026,25
2026-06-20,s√°bado,20,6,2026,25
2026-06-21,domingo,21,6,2026,25
2026-06-22,lunes,22,6,2026,26
2026-06-23,martes,23,6,2026,26
2026-06-24,mi√©rcoles,24,6,2026,26
2026-06-25,jueves,25,6,2026,26
2026-06-26,viernes,26,6,2026,26
2026-06-27,s√°bado,27,6,2026,26
2026-06-28,domingo,28,6,2026,26
2026-06-29,lunes,29,6,2026,27
2026-06-30,martes,30,6,2026,27
2026-07-01,mi√©rcoles,1,7,2026,27
2026-07-02,jueves,2,7,2026,27
2026-07-03,viernes,3,7,2026,27
2026-07-04,s√°bado,4,7,2026,27
2026-07-05,domingo,5,7,2026,27
2026-07-06,lunes,6,7,2026,28
2026-07-07,martes,7,7,2026,28
2026-07-08,mi√©rcoles,8,7,2026,28
2026-07-09,jueves,9,7,2026,28
2026-07-10,viernes,10,7,2026,28
2026-07-11,s√°bado,11,7,2026,28
2026-07-12,domingo,12,7,2026,28
2026-07-13,lunes,13,7,2026,29
2026-07-14,martes,14,7,2026,29
2026-07-15,mi√©rcoles,15,7,2026,29
2026-07-16,jueves,16,7,2026,29
2026-07-17,viernes,17,7,2026,29
2026-07-18,s√°bado,18,7,2026,29
2026-07-19,domingo,19,7,2026,29
2026-07-20,lunes,20,7,2026,30
2026-07-21,martes,21,7,2026,30
2026-07-22,mi√©rcoles,22,7,2026,30
2026-07-23,jueves,23,7,2026,30
2026-07-24,viernes,24,7,2026,30
2026-07-25,s√°bado,25,7,2026,30
2026-07-26,domingo,26,7,2026,30
2026-07-27,lunes,27,7,2026,31
2026-07-28,martes,28,7,2026,31
2026-07-29,mi√©rcoles,29,7,2026,31
2026-07-30,jueves,30,7,2026,31
2026-07-31,viernes,31,7,2026,31
2026-08-01,s√°bado,1,8,2026,31
2026-08-02,domingo,2,8,2026,31
2026-08-03,lunes,3,8,2026,32
2026-08-04,martes,4,8,2026,32
2026-08-05,mi√©rcoles,5,8,2026,32
2026-08-06,jueves,6,8,2026,32
2026-08-07,viernes,7,8,2026,32
2026-08-08,s√°bado,8,8,2026,32
2026-08-09,domingo,9,8,2026,32
2026-08-10,lunes,10,8,2026,33
2026-08-11,martes,11,8,2026,33
2026-08-12,mi√©rcoles,12,8,2026,33
2026-08-13,jueves,13,8,2026,33
2026-08-14,viernes,14,8,2026,33
2026-08-15,s√°bado,15,8,2026,33
2026-08-16,domingo,16,8,2026,33
2026-08-17,lunes,17,8,2026,34
2026-08-18,martes,18,8,2026,34
2026-08-19,mi√©rcoles,19,8,2026,34
2026-08-20,jueves,20,8,2026,34
2026-08-21,viernes,21,8,2026,34
2026-08-22,s√°bado,22,8,2026,34
2026-08-23,domingo,23,8,2026,34
2026-08-24,lunes,24,8,2026,35
2026-08-25,martes,25,8,2026,35
2026-08-26,mi√©rcoles,26,8,2026,35
2026-08-27,jueves,27,8,2026,35
2026-08-28,viernes,28,8,2026,35
2026-08-29,s√°bado,29,8,2026,35
2026-08-30,domingo,30,8,2026,35
2026-08-31,lunes,31,8,2026,36
2026-09-01,martes,1,9,2026,36
2026-09-02,mi√©rcoles,2,9,2026,36
2026-09-03,jueves,3,9,2026,36
2026-09-04,viernes,4,9,2026,36
2026-09-05,s√°bado,5,9,2026,36
2026-09-06,domingo,6,9,2026,36
2026-09-07,lunes,7,9,2026,37
2026-09-08,martes,8,9,2026,37
2026-09-09,mi√©rcoles,9,9,2026,37
2026-09-10,jueves,10,9,2026,37
2026-09-11,viernes,11,9,2026,37
2026-09-12,s√°bado,12,9,2026,37
2026-09-13,domingo,13,9,2026,37
2026-09-14,lunes,14,9,2026,38
2026-09-15,martes,15,9,2026,38
2026-09-16,mi√©rcoles,16,9,2026,38
2026-09-17,jueves,17,9,2026,38
2026-09-18,viernes,18,9,2026,38
2026-09-19,s√°bado,19,9,2026,38
2026-09-20,domingo,20,9,2026,38
2026-09-21,lunes,21,9,2026,39
2026-09-22,martes,22,9,2026,39
2026-09-23,mi√©rcoles,23,9,2026,39
2026-09-24,jueves,24,9,2026,39
2026-09-25,viernes,25,9,2026,39
2026-09-26,s√°bado,26,9,2026,39
2026-09-27,domingo,27,9,2026,39
2026-09-28,lunes,28,9,2026,40
2026-09-29,martes,29,9,2026,40
2026-09-30,mi√©rcoles,30,9,2026,40
2026-10-01,jueves,1,10,2026,40
2026-10-02,viernes,2,10,2026,40
2026-10-03,s√°bado,3,10,2026,40
2026-10-04,domingo,4,10,2026,40
2026-10-05,lunes,5,10,2026,41
2026-10-06,martes,6,10,2026,41
2026-10-07,mi√©rcoles,7,10,2026,41
2026-10-08,jueves,8,10,2026,41
2026-10-09,viernes,9,10,2026,41
2026-10-10,s√°bado,10,10,2026,41
2026-10-11,domingo,11,10,2026,41
2026-10-12,lunes,12,10,2026,42
2026-10-13,martes,13,10,2026,42
2026-10-14,mi√©rcoles,14,10,2026,42
2026-10-15,jueves,15,10,2026,42
2026-10-16,viernes,16,10,2026,42
2026-10-17,s√°bado,17,10,2026,42
2026-10-18,domingo,18,10,2026,42
2026-10-19,lunes,19,10,2026,43
2026-10-20,martes,20,10,2026,43
2026-10-21,mi√©rcoles,21,10,2026,43
2026-10-22,jueves,22,10,2026,43
2026-10-23,viernes,23,10,2026,43
2026-10-24,s√°bado,24,10,2026,43
2026-10-25,domingo,25,10,2026,43
2026-10-26,lunes,26,10,2026,44
2026-10-27,martes,27,10,2026,44
2026-10-28,mi√©rcoles,28,10,2026,44
2026-10-29,jueves,29,10,2026,44
2026-10-30,viernes,30,10,2026,44
2026-10-31,s√°bado,31,10,2026,44
2026-11-01,domingo,1,11,2026,44
2026-11-02,lunes,2,11,2026,45
2026-11-03,martes,3,11,2026,45
2026-11-04,mi√©rcoles,4,11,2026,45
2026-11-05,jueves,5,11,2026,45
2026-11-06,viernes,6,11,2026,45
2026-11-07,s√°bado,7,11,2026,45
2026-11-08,domingo,8,11,2026,45
2026-11-09,lunes,9,11,2026,46
2026-11-10,martes,10,11,2026,46
2026-11-11,mi√©rcoles,11,11,2026,46
2026-11-12,jueves,12,11,2026,46
2026-11-13,viernes,13,11,2026,46
2026-11-14,s√°bado,14,11,2026,46
2026-11-15,domingo,15,11,2026,46
2026-11-16,lunes,16,11,2026,47
2026-11-17,martes,17,11,2026,47
2026-11-18,mi√©rcoles,18,11,2026,47
2026-11-19,jueves,19,11,2026,47
2026-11-20,viernes,20,11,2026,47
2026-11-21,s√°bado,21,11,2026,47
2026-11-22,domingo,22,11,2026,47
2026-11-23,lunes,23,11,2026,48
2026-11-24,martes,24,11,2026,48
2026-11-25,mi√©rcoles,25,11,2026,48
2026-11-26,jueves,26,11,2026,48
2026-11-27,viernes,27,11,2026,48
2026-11-28,s√°bado,28,11,2026,48
2026-11-29,domingo,29,11,2026,48
2026-11-30,lunes,30,11,2026,49
2026-12-01,martes,1,12,2026,49
2026-12-02,mi√©rcoles,2,12,2026,49
2026-12-03,jueves,3,12,2026,49
2026-12-04,viernes,4,12,2026,49
2026-12-05,s√°bado,5,12,2026,49
2026-12-06,domingo,6,12,2026,49
2026-12-07,lunes,7,12,2026,50
2026-12-08,martes,8,12,2026,50
2026-12-09,mi√©rcoles,9,12,2026,50
2026-12-10,jueves,10,12,2026,50
2026-12-11,viernes,11,12,2026,50
2026-12-12,s√°bado,12,12,2026,50
2026-12-13,domingo,13,12,2026,50
2026-12-14,lunes,14,12,2026,51
2026-12-15,martes,15,12,2026,51
2026-12-16,mi√©rcoles,16,12,2026,51
2026-12-17,jueves,17,12,2026,51
2026-12-18,viernes,18,12,2026,51
2026-12-19,s√°bado,19,12,2026,51
2026-12-20,domingo,20,12,2026,51
2026-12-21,lunes,21,12,2026,52
2026-12-22,martes,22,12,2026,52
2026-12-23,mi√©rcoles,23,12,2026,52
2026-12-24,jueves,24,12,2026,52
2026-12-25,viernes,25,12,2026,52
2026-12-26,s√°bado,26,12,2026,52
2026-12-27,domingo,27,12,2026,52
2026-12-28,lunes,28,12,2026,53
2026-12-29,martes,29,12,2026,53
2026-12-30,mi√©rcoles,30,12,2026,53
2026-12-31,jueves,31,12,2026,53`;

        // Parse CSV data
        function parseCalendarData() {
            try {
                if (!calendarCSV) {
                    console.error('calendarCSV is not defined!');
                    return;
                }
                
                // Clear previous data
                calendarData = [];
                
                const lines = calendarCSV.trim().split('\n');
                if (lines.length < 2) {
                    console.error('Calendar CSV has no data rows!');
                    return;
                }
                
                const headers = lines[0].split(',');

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index];
                });
                calendarData.push(row);

                // Initialize daily planning with default values
                // Restaurant is open Tue-Sat (lunch+dinner) and Sunday (lunch only)
                // Wednesday has only 1 shift
                const dayName = row.dia_semana.toLowerCase();
                const isTuesday = dayName === 'martes';
                const isWednesday = dayName === 'mi√©rcoles';
                const isThursday = dayName === 'jueves';
                const isFriday = dayName === 'viernes';
                const isSaturday = dayName === 's√°bado';
                const isSunday = dayName === 'domingo';

                // Restaurant opens on November 8, 2025 (close Nov 1-7 for soft opening)
                const isBeforeOpening = row.fecha === '2025-11-01' || row.fecha === '2025-11-02' ||
                                       row.fecha === '2025-11-03' || row.fecha === '2025-11-04' ||
                                       row.fecha === '2025-11-05' || row.fecha === '2025-11-06' ||
                                       row.fecha === '2025-11-07';

                // August is closed (all of August 2026)
                const isAugust = parseInt(row.mes) === 8 && parseInt(row.a√±o) === 2026;

                // Festivos nacionales (se se√±alan en calendario, no cierran autom√°ticamente)
                const holidays = [
                    '2025-12-08', // Inmaculada Concepci√≥n
                    '2025-12-25', // Navidad
                    '2026-04-02', // Jueves Santo
                    '2026-04-03', // Viernes Santo
                    '2026-05-01', // D√≠a del Trabajo
                    '2026-10-12', // Fiesta Nacional de Espa√±a
                    '2026-11-02', // Todos los Santos (trasladado del 1)
                    '2026-12-07', // D√≠a de la Constituci√≥n (trasladado del 6)
                    '2026-12-08', // Inmaculada Concepci√≥n
                    '2026-12-25'  // Navidad
                ];
                const isHoliday = holidays.includes(row.fecha);

                // Special closures in November 2025 (first operational weekend)
                const isNovemberClosure = row.fecha === '2025-11-08' || row.fecha === '2025-11-09' || row.fecha === '2025-11-11';

                const isNormallyOpen = isTuesday || isWednesday || isThursday || isFriday || isSaturday || isSunday;
                const isOpen = isNormallyOpen && !isBeforeOpening && !isAugust && !isNovemberClosure;

                // Occupancy matrix by day of week and month
                // Rows: day of week (0=Sunday, 1=Monday, 2=Tuesday, 3=Wednesday, 4=Thursday, 5=Friday, 6=Saturday)
                // Columns: month (1-12 for Jan-Dec)
                // Note: Tuesday and Wednesday values increased by +10 percentage points
                const occupancyMatrix = {
                    1: [48.75, 25.09, 26.64, 23.47, 14.18, 27.72, 57.79], // Enero
                    2: [38.63, 11.02, 26.10, 34.06, 11.41, 17.43, 49.83], // Febrero
                    3: [37.55, 14.57, 31.31, 20.95, 26.73, 26.81, 46.19], // Marzo
                    4: [35.54, 11.60, 21.57, 18.83, 9.36, 24.01, 44.02],   // Abril
                    5: [29.36, 12.59, 23.21, 26.59, 11.35, 21.33, 47.45], // Mayo
                    6: [24.53, 19.43, 24.80, 17.36, 15.38, 18.40, 33.35],  // Junio
                    7: [18.59, 15.32, 25.83, 23.22, 13.11, 29.33, 25.94], // Julio
                    8: [18.18, 18.70, 25.36, 23.63, 12.81, 23.88, 28.43], // Agosto
                    9: [24.30, 14.36, 23.54, 15.26, 10.09, 14.16, 32.01],  // Septiembre
                    10: [28.97, 9.33, 22.48, 26.06, 14.66, 15.45, 45.38], // Octubre
                    11: [32.03, 5.66, 21.25, 21.25, 15.84, 23.65, 48.95], // Noviembre
                    12: [53.88, 35.21, 44.81, 35.61, 36.27, 57.35, 63.84] // Diciembre
                };

                // Get day of week for this date (0=Sunday, 1=Monday, ..., 6=Saturday)
                const dateParts = row.fecha.split('-');
                const dateObj = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                const dayOfWeek = dateObj.getDay();

                // Get default occupancy from matrix
                const month = parseInt(row.mes);
                let defaultOccupancy = occupancyMatrix[month] ? occupancyMatrix[month][dayOfWeek] : 40;
                
                // Increase Sunday occupancy by 10%
                if (isSunday) {
                    defaultOccupancy = Math.round((defaultOccupancy * 1.1) * 100) / 100;
                }

                // Shifts: 1 shift on Tuesday, Wednesday and Sunday; 2 shifts on Thu-Sat
                let defaultShifts = 2;
                if (isTuesday || isWednesday || isSunday) {
                    defaultShifts = 1;
                }

                dailyPlanning[row.fecha] = {
                    open: isOpen,
                    occupancy: defaultOccupancy,
                    shifts: isOpen ? defaultShifts : 0,
                    isHoliday: isHoliday
                };
            }
            
            console.log('Calendar data parsed successfully:', calendarData.length, 'days');
            } catch (error) {
                console.error('Error parsing calendar data:', error);
                calendarData = [];
            }
        }

        // Group calendar data by month
        function groupByMonth() {
            const months = {};
            calendarData.forEach(day => {
                const key = `${day.a√±o}-${String(day.mes).padStart(2, '0')}`;
                if (!months[key]) {
                    months[key] = [];
                }
                months[key].push(day);
            });
            return months;
        }

        // Month names in Spanish
        const monthNames = ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                           'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

        // Toggle month expansion
        function toggleMonth(yearMonth) {
            const content = document.getElementById(`month-content-${yearMonth}`);
            const icon = document.getElementById(`expand-icon-${yearMonth}`);
            content.classList.toggle('expanded');
            icon.classList.toggle('rotated');
        }

        // Update day planning
        function updateDayPlanning(date, field, value) {
            if (!dailyPlanning[date]) {
                dailyPlanning[date] = { open: false, occupancy: 25, shifts: 0 };
            }
            dailyPlanning[date][field] = value;

            // Update summary for this month
            const [year, month] = date.split('-');
            const yearMonth = `${year}-${month}`;
            updateMonthSummary(yearMonth);
            updateMonthStats(yearMonth);
            updateTreasuryChart();
            calculateYearlyResults();
        }

        // Calculate month totals
        function calculateMonthTotals(yearMonth) {
            const monthDays = calendarData.filter(day => {
                const key = `${day.a√±o}-${String(day.mes).padStart(2, '0')}`;
                return key === yearMonth;
            });

            const capacidad = parseFloat(document.getElementById('capacidad').value);
            const ticket = parseFloat(document.getElementById('ticket').value);

            let totalShifts = 0;
            let totalRevenue = 0;
            let totalDiners = 0;

            monthDays.forEach(day => {
                const planning = dailyPlanning[day.fecha];
                if (planning && planning.open) {
                    const shifts = planning.shifts || 0;
                    const occupancy = (planning.occupancy || 40) / 100;
                    const comensales = Math.round(capacidad * occupancy);
                    const revenue = comensales * ticket * shifts;

                    totalShifts += shifts;
                    totalRevenue += revenue;
                    totalDiners += comensales * shifts; // Total diners = diners per shift √ó number of shifts
                }
            });

            return { totalShifts, totalRevenue, totalDiners };
        }

        // Update month summary
        function updateMonthSummary(yearMonth) {
            const totals = calculateMonthTotals(yearMonth);

            document.getElementById(`month-shifts-${yearMonth}`).textContent = totals.totalShifts;
            document.getElementById(`month-diners-${yearMonth}`).textContent = totals.totalDiners;

            // Update d√≠as abiertos
            const monthDays = calendarData.filter(day => {
                const key = `${day.a√±o}-${String(day.mes).padStart(2, '0')}`;
                return key === yearMonth;
            });
            document.getElementById(`month-open-days-${yearMonth}`).textContent =
                monthDays.filter(d => dailyPlanning[d.fecha]?.open).length;
        }

        // Render calendar for all months
        function renderCalendar() {
            try {
                const container = document.getElementById('planning-months-container');
                if (!container) {
                    console.error('Container planning-months-container not found!');
                    return;
                }
                
                if (!calendarData || calendarData.length === 0) {
                    console.error('Calendar data is empty! Call parseCalendarData() first.');
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Cargando calendario...</div>';
                    return;
                }
                
                container.innerHTML = '';

                if (typeof groupByMonth !== 'function') {
                    console.error('groupByMonth function not found!');
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc3545;">Error: funci√≥n groupByMonth no encontrada</div>';
                    return;
                }
                
                const monthsGrouped = groupByMonth();
                const sortedMonths = Object.keys(monthsGrouped).sort();

                if (sortedMonths.length === 0) {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No hay datos de calendario disponibles</div>';
                    return;
                }
                
                sortedMonths.forEach(yearMonth => {
                    const days = monthsGrouped[yearMonth];
                    const [year, month] = yearMonth.split('-');
                    const monthName = monthNames[parseInt(month)] || `Mes ${month}`;

                    const totals = calculateMonthTotals(yearMonth);

                const monthSection = document.createElement('div');
                monthSection.className = 'month-section';
                monthSection.innerHTML = `
                    <div class="month-header" onclick="toggleMonth('${yearMonth}')">
                        <div class="month-header-top">
                            <h3>${monthName} ${year}</h3>
                            <div class="expand-icon" id="expand-icon-${yearMonth}">‚ñº</div>
                        </div>
                        <div class="month-summary">
                            <div class="month-summary-item">
                                <label>Turnos</label>
                                <div class="value" id="month-shifts-${yearMonth}">${totals.totalShifts}</div>
                            </div>
                            <div class="month-summary-item">
                                <label>D√≠as Abiertos</label>
                                <div class="value" id="month-open-days-${yearMonth}">${days.filter(d => dailyPlanning[d.fecha]?.open).length}</div>
                            </div>
                            <div class="month-summary-item">
                                <label>Comensales Totales</label>
                                <div class="value" id="month-diners-${yearMonth}">${totals.totalDiners}</div>
                            </div>
                        </div>
                    </div>
                    <div class="month-content" id="month-content-${yearMonth}">
                        <div class="bulk-controls">
                            <button class="bulk-btn" onclick="bulkSetDays('${yearMonth}', true)">Abrir todos los d√≠as</button>
                            <button class="bulk-btn" onclick="bulkSetDays('${yearMonth}', false)">Cerrar todos los d√≠as</button>
                            <button class="bulk-btn" onclick="bulkSetOccupancy('${yearMonth}')">Cambiar ocupaci√≥n del mes</button>
                        </div>
                        <div class="calendar-grid">
                            <div class="calendar-header">L</div>
                            <div class="calendar-header">M</div>
                            <div class="calendar-header">X</div>
                            <div class="calendar-header">J</div>
                            <div class="calendar-header">V</div>
                            <div class="calendar-header">S</div>
                            <div class="calendar-header">D</div>
                        </div>
                        <div class="calendar-grid" id="calendar-${yearMonth}">
                            <!-- Days will be rendered here -->
                        </div>
                        <div class="monthly-stats">
                            <div class="stat-box revenue">
                                <label>Ingresos</label>
                                <div class="value" id="stats-revenue-${yearMonth}">${formatCurrency(0)}</div>
                            </div>
                            <div class="stat-box expense">
                                <label>Aprovisionamiento</label>
                                <div class="value" id="stats-aprovisionamiento-${yearMonth}">${formatCurrency(0)}</div>
                            </div>
                            <div class="stat-box expense">
                                <label>Gastos Personal</label>
                                <div class="value" id="stats-personal-${yearMonth}">${formatCurrency(0)}</div>
                            </div>
                            <div class="stat-box expense">
                                <label>Gastos Operativos</label>
                                <div class="value" id="stats-operativos-${yearMonth}">${formatCurrency(0)}</div>
                            </div>
                            <div class="stat-box result">
                                <label>Resultado Mes</label>
                                <div class="value" id="stats-result-${yearMonth}">${formatCurrency(0)}</div>
                            </div>
                        </div>
                    </div>
                `;

                container.appendChild(monthSection);

                // Render days
                if (typeof renderMonthDays === 'function') {
                    renderMonthDays(yearMonth, days);
                }
                if (typeof updateMonthStats === 'function') {
                    updateMonthStats(yearMonth);
                }
            });
            } catch (error) {
                console.error('Error rendering calendar:', error);
                const container = document.getElementById('planning-months-container');
                if (container) {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc3545;">Error al cargar el calendario. Por favor, recarga la p√°gina.</div>';
                }
            }
        }

        // Render days for a specific month
        function renderMonthDays(yearMonth, days) {
            const calendarGrid = document.getElementById(`calendar-${yearMonth}`);

            // Find first day of month to determine offset
            const firstDay = days[0];
            const dayOfWeekMap = {
                'lunes': 0, 'martes': 1, 'mi√©rcoles': 2, 'jueves': 3,
                'viernes': 4, 's√°bado': 5, 'domingo': 6
            };
            const offset = dayOfWeekMap[firstDay.dia_semana.toLowerCase()];

            // Add empty cells for offset
            for (let i = 0; i < offset; i++) {
                const emptyCell = document.createElement('div');
                calendarGrid.appendChild(emptyCell);
            }

            // Render each day
            days.forEach(day => {
                const planning = dailyPlanning[day.fecha];
                const isOpen = planning?.open || false;
                const occupancy = planning?.occupancy || 40;
                const shifts = planning?.shifts || 0;
                const isHoliday = planning?.isHoliday || false;

                // Calcular comensales
                const capacidad = parseFloat(document.getElementById('capacidad').value);
                const comensalesPorTurno = Math.round(capacidad * (occupancy / 100));
                const comensalesTotales = comensalesPorTurno * shifts;

                const dayCell = document.createElement('div');
                dayCell.className = `day-cell ${isOpen ? 'open' : 'closed'}`;
                dayCell.id = `day-${day.fecha}`;

                dayCell.innerHTML = `
                    <div class="day-date">
                        <span>${day.dia}</span>
                        <span class="day-name">${day.dia_semana.substring(0, 3)}</span>
                    </div>
                    ${isHoliday ? '<div style="background: #ff9800; color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 10px; text-align: center; margin: 4px 0; font-weight: 600;">üéâ Festivo</div>' : ''}
                    <div class="toggle-switch">
                        <label class="switch">
                            <input type="checkbox" id="open-${day.fecha}" ${isOpen ? 'checked' : ''}
                                   onchange="updateDayPlanning('${day.fecha}', 'open', this.checked); renderDayCell('${day.fecha}')">
                            <span class="slider"></span>
                        </label>
                        <span style="font-size: 0.8em;">${isOpen ? 'Abierto' : 'Cerrado'}</span>
                    </div>
                    ${isOpen ? `
                        <div class="day-controls">
                            <label>Turnos:</label>
                            <input type="number" min="0" max="4" step="1" value="${shifts}"
                                   oninput="updateDayPlanning('${day.fecha}', 'shifts', parseInt(this.value)); renderDayCell('${day.fecha}')">
                        </div>
                        <div class="day-controls">
                            <label>Ocupaci√≥n:</label>
                            <input type="range" min="10" max="100" step="1" value="${occupancy}"
                                   oninput="updateDayPlanning('${day.fecha}', 'occupancy', parseInt(this.value)); renderDayCell('${day.fecha}')">
                            <div class="occupancy-display" id="occ-display-${day.fecha}">${occupancy}%</div>
                        </div>
                        <div class="day-info" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(102, 126, 234, 0.2); text-align: center;">
                            <span style="font-size: 0.85em; color: #667eea; font-weight: 600;">${comensalesTotales} comensales</span>
                            <span style="font-size: 0.75em; color: #999; display: block;">(${comensalesPorTurno} √ó ${shifts})</span>
                        </div>
                    ` : ''}
                `;

                calendarGrid.appendChild(dayCell);
            });
        }

        // Re-render single day cell
        function renderDayCell(date) {
            const dayData = calendarData.find(d => d.fecha === date);
            if (!dayData) return;

            const planning = dailyPlanning[date];
            const isOpen = planning?.open || false;
            const occupancy = planning?.occupancy || 40;
            const shifts = planning?.shifts || 0;
            const isHoliday = planning?.isHoliday || false;

            // Calcular comensales
            const capacidad = parseFloat(document.getElementById('capacidad').value);
            const comensalesPorTurno = Math.round(capacidad * (occupancy / 100));
            const comensalesTotales = comensalesPorTurno * shifts;

            const dayCell = document.getElementById(`day-${date}`);
            dayCell.className = `day-cell ${isOpen ? 'open' : 'closed'}`;

            dayCell.innerHTML = `
                <div class="day-date">
                    <span>${dayData.dia}</span>
                    <span class="day-name">${dayData.dia_semana.substring(0, 3)}</span>
                </div>
                ${isHoliday ? '<div style="background: #ff9800; color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 10px; text-align: center; margin: 4px 0; font-weight: 600;">üéâ Festivo</div>' : ''}
                <div class="toggle-switch">
                    <label class="switch">
                        <input type="checkbox" id="open-${date}" ${isOpen ? 'checked' : ''}
                               onchange="updateDayPlanning('${date}', 'open', this.checked); renderDayCell('${date}')">
                        <span class="slider"></span>
                    </label>
                    <span style="font-size: 0.8em;">${isOpen ? 'Abierto' : 'Cerrado'}</span>
                </div>
                ${isOpen ? `
                    <div class="day-controls">
                        <label>Turnos:</label>
                        <input type="number" min="0" max="4" step="1" value="${shifts}"
                               oninput="updateDayPlanning('${date}', 'shifts', parseInt(this.value)); renderDayCell('${date}')">
                    </div>
                    <div class="day-controls">
                        <label>Ocupaci√≥n:</label>
                        <input type="range" min="10" max="100" step="1" value="${occupancy}"
                               oninput="updateDayPlanning('${date}', 'occupancy', parseInt(this.value)); renderDayCell('${date}')">
                        <div class="occupancy-display" id="occ-display-${date}">${occupancy}%</div>
                    </div>
                    <div class="day-info" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(102, 126, 234, 0.2); text-align: center;">
                        <span style="font-size: 0.85em; color: #667eea; font-weight: 600;">${comensalesTotales} comensales</span>
                        <span style="font-size: 0.75em; color: #999; display: block;">(${comensalesPorTurno} √ó ${shifts})</span>
                    </div>
                ` : ''}
            `;

            // Update month summary and all results
            const [year, month] = date.split('-');
            const yearMonth = `${year}-${month}`;
            updateMonthSummary(yearMonth);
            updateMonthStats(yearMonth);
            updateTreasuryChart();
            calculateYearlyResults();
        }

        // Bulk set days open/closed for a month
        function bulkSetDays(yearMonth, open) {
            const monthDays = calendarData.filter(day => {
                const key = `${day.a√±o}-${String(day.mes).padStart(2, '0')}`;
                return key === yearMonth;
            });

            monthDays.forEach(day => {
                dailyPlanning[day.fecha].open = open;
            });

            // Re-render month
            const [year, month] = yearMonth.split('-');
            const days = monthDays;
            document.getElementById(`calendar-${yearMonth}`).innerHTML = '';
            renderMonthDays(yearMonth, days);
            updateMonthSummary(yearMonth);
            updateMonthStats(yearMonth);
            updateTreasuryChart();
            calculateYearlyResults();
        }

        // Bulk set shifts for a month
        function bulkSetShifts(yearMonth) {
            const newShifts = prompt('Turnos para todo el mes (0-4):');
            if (!newShifts) return;

            const shiftsValue = parseInt(newShifts);
            if (shiftsValue < 0 || shiftsValue > 4) {
                alert('Los turnos deben estar entre 0 y 4');
                return;
            }

            const monthDays = calendarData.filter(day => {
                const key = `${day.a√±o}-${String(day.mes).padStart(2, '0')}`;
                return key === yearMonth;
            });

            monthDays.forEach(day => {
                if (dailyPlanning[day.fecha].open) {
                    dailyPlanning[day.fecha].shifts = shiftsValue;
                }
            });

            // Re-render month
            const [year, month] = yearMonth.split('-');
            const days = monthDays;
            document.getElementById(`calendar-${yearMonth}`).innerHTML = '';
            renderMonthDays(yearMonth, days);
            updateMonthSummary(yearMonth);
            updateMonthStats(yearMonth);
            updateTreasuryChart();
            calculateYearlyResults();
        }

        // Bulk set occupancy for a month
        function bulkSetOccupancy(yearMonth) {
            const monthDays = calendarData.filter(day => {
                const key = `${day.a√±o}-${String(day.mes).padStart(2, '0')}`;
                return key === yearMonth;
            });

            // Step 1: Choose the method
            const modalBody = `
                <div class="modal-input-group">
                    <label>¬øC√≥mo deseas cambiar la ocupaci√≥n?</label>
                    <select id="occupancy-choice" onchange="updateOccupancyForm()">
                        <option value="all">Todo el mes (mismo % para todos los d√≠as)</option>
                        <option value="by-day">Por d√≠as de la semana</option>
                    </select>
                </div>
                <div id="occupancy-inputs">
                    <div class="modal-input-group">
                        <label>Ocupaci√≥n para todo el mes (%):</label>
                        <input type="number" id="occ-all" value="40" min="10" max="100" step="5" inputmode="decimal">
                    </div>
                </div>
            `;

            openModal('Cambiar Ocupaci√≥n del Mes', modalBody, 'Aplicar', () => {
                const choice = document.getElementById('occupancy-choice').value;

                if (choice === 'all') {
                    const occupancyValue = parseInt(document.getElementById('occ-all').value);
                    if (occupancyValue < 10 || occupancyValue > 100) {
                        alert('La ocupaci√≥n debe estar entre 10% y 100%');
                        return;
                    }

                    monthDays.forEach(day => {
                        if (dailyPlanning[day.fecha].open) {
                            dailyPlanning[day.fecha].occupancy = occupancyValue;
                        }
                    });
                } else if (choice === 'by-day') {
                    const occMar = parseInt(document.getElementById('occ-mar').value);
                    const occMie = parseInt(document.getElementById('occ-mie').value);
                    const occJue = parseInt(document.getElementById('occ-jue').value);
                    const occVie = parseInt(document.getElementById('occ-vie').value);
                    const occSab = parseInt(document.getElementById('occ-sab').value);
                    const occDom = parseInt(document.getElementById('occ-dom').value);

                    // Validar que todos est√©n en rango
                    if ([occMar, occMie, occJue, occVie, occSab, occDom].some(v => v < 10 || v > 100)) {
                        alert('Todas las ocupaciones deben estar entre 10% y 100%');
                        return;
                    }

                    monthDays.forEach(day => {
                        if (dailyPlanning[day.fecha].open) {
                            const dayName = day.dia_semana.toLowerCase();
                            if (dayName === 'martes') {
                                dailyPlanning[day.fecha].occupancy = occMar;
                            } else if (dayName === 'mi√©rcoles') {
                                dailyPlanning[day.fecha].occupancy = occMie;
                            } else if (dayName === 'jueves') {
                                dailyPlanning[day.fecha].occupancy = occJue;
                            } else if (dayName === 'viernes') {
                                dailyPlanning[day.fecha].occupancy = occVie;
                            } else if (dayName === 's√°bado') {
                                dailyPlanning[day.fecha].occupancy = occSab;
                            } else if (dayName === 'domingo') {
                                dailyPlanning[day.fecha].occupancy = occDom;
                            }
                        }
                    });
                }

                // Re-render month
                const [year, month] = yearMonth.split('-');
                const days = monthDays;
                document.getElementById(`calendar-${yearMonth}`).innerHTML = '';
                renderMonthDays(yearMonth, days);
                updateMonthSummary(yearMonth);
                updateMonthStats(yearMonth);
                updateTreasuryChart();
                calculateYearlyResults();
                vibrateMedium(); // Success feedback
            });

            // Initialize the form switcher
            setTimeout(() => {
                window.updateOccupancyForm = function() {
                    const choice = document.getElementById('occupancy-choice').value;
                    const inputsDiv = document.getElementById('occupancy-inputs');

                    if (choice === 'all') {
                        inputsDiv.innerHTML = `
                            <div class="modal-input-group">
                                <label>Ocupaci√≥n para todo el mes (%):</label>
                                <input type="number" id="occ-all" value="40" min="10" max="100" step="5" inputmode="decimal">
                            </div>
                        `;
                    } else {
                        inputsDiv.innerHTML = `
                            <div class="modal-input-group">
                                <label>Ocupaci√≥n Martes (%):</label>
                                <input type="number" id="occ-mar" value="25" min="10" max="100" step="5" inputmode="decimal">
                            </div>
                            <div class="modal-input-group">
                                <label>Ocupaci√≥n Mi√©rcoles (%):</label>
                                <input type="number" id="occ-mie" value="25" min="10" max="100" step="5" inputmode="decimal">
                            </div>
                            <div class="modal-input-group">
                                <label>Ocupaci√≥n Jueves (%):</label>
                                <input type="number" id="occ-jue" value="25" min="10" max="100" step="5" inputmode="decimal">
                            </div>
                            <div class="modal-input-group">
                                <label>Ocupaci√≥n Viernes (%):</label>
                                <input type="number" id="occ-vie" value="45" min="10" max="100" step="5" inputmode="decimal">
                            </div>
                            <div class="modal-input-group">
                                <label>Ocupaci√≥n S√°bado (%):</label>
                                <input type="number" id="occ-sab" value="45" min="10" max="100" step="5" inputmode="decimal">
                            </div>
                            <div class="modal-input-group">
                                <label>Ocupaci√≥n Domingo (%):</label>
                                <input type="number" id="occ-dom" value="45" min="10" max="100" step="5" inputmode="decimal">
                            </div>
                        `;
                    }
                };
            }, 100);
        }

        // Update monthly statistics
        function updateMonthStats(yearMonth) {
            const monthDays = calendarData.filter(day => {
                const key = `${day.a√±o}-${String(day.mes).padStart(2, '0')}`;
                return key === yearMonth;
            });

            const capacidad = parseFloat(document.getElementById('capacidad').value);
            const ticket = parseFloat(document.getElementById('ticket').value);
            const aprovisionamientoPct = parseFloat(document.getElementById('aprovisionamiento').value) / 100;

            let totalRevenue = 0;

            monthDays.forEach(day => {
                const planning = dailyPlanning[day.fecha];
                if (planning && planning.open) {
                    const shifts = planning.shifts || 2; // Default 2 shifts per day
                    const occupancy = (planning.occupancy || 40) / 100;
                    const comensales = Math.round(capacidad * occupancy);
                    const revenue = comensales * ticket * shifts;
                    totalRevenue += revenue;
                }
            });

            const aprovisionamiento = totalRevenue * aprovisionamientoPct;
            const margen = totalRevenue - aprovisionamiento;

            // Calculate monthly fixed costs (proportional)
            const totalPersonal = calculateMonthlyPersonalCost() / 12;
            const totalOperativos = calculateMonthlyOperativeCost() / 12;

            const result = margen - totalPersonal - totalOperativos;

            // Update stats display with full breakdown
            document.getElementById(`stats-revenue-${yearMonth}`).textContent = formatCurrency(totalRevenue);
            document.getElementById(`stats-aprovisionamiento-${yearMonth}`).textContent = formatCurrency(aprovisionamiento);
            document.getElementById(`stats-personal-${yearMonth}`).textContent = formatCurrency(totalPersonal);
            document.getElementById(`stats-operativos-${yearMonth}`).textContent = formatCurrency(totalOperativos);
            document.getElementById(`stats-result-${yearMonth}`).textContent = formatCurrency(result);
        }

        // Calculate monthly personal cost (ANUAL - devuelve el coste anual total)
        function calculateMonthlyPersonalCost() {
            let total = 0;
            // Empleados base - usar la nueva estructura (puesto, horas, irpf, otros_pluses)
            employees.forEach((emp) => {
                // Asegurar que el empleado tenga los campos necesarios
                if (!emp.puesto) emp.puesto = 'Ayudante de Cocina';
                if (!emp.horas_semanales) emp.horas_semanales = 40;
                if (emp.irpf === undefined) emp.irpf = 0;
                if (emp.otros_pluses === undefined) emp.otros_pluses = 0;
                
                const cost = calculateTotalCompanyCost(emp);
                total += cost.totalCost; // totalCost ya es anual
            });
            // Empleados personalizados - usar la nueva estructura
            customEmployees.forEach(emp => {
                // Asegurar que el empleado tenga los campos necesarios
                if (!emp.puesto) emp.puesto = 'Ayudante de Cocina';
                if (!emp.horas_semanales) emp.horas_semanales = 40;
                if (emp.irpf === undefined) emp.irpf = 0;
                if (emp.otros_pluses === undefined) emp.otros_pluses = 0;
                
                const cost = calculateTotalCompanyCost(emp);
                total += cost.totalCost; // totalCost ya es anual
            });
            return total;
        }
        
        // Calculate monthly personal cost breakdown
        function calculateMonthlyPersonalBreakdown() {
            let totalNetMonthly = 0;
            let totalSSEmployeeMonthly = 0;
            let totalIRPFMonthly = 0;
            let totalSSCompanyMonthly = 0;
            let totalCostMonthly = 0;
            
            // Empleados base
            employees.forEach((emp, index) => {
                // Usar valores del objeto empleado directamente
                const cost = calculateTotalCompanyCost(emp);
                totalNetMonthly += cost.netMonthly;
                totalSSEmployeeMonthly += cost.ss_trabajador || (cost.ssEmployee / 12);
                totalIRPFMonthly += (cost.irpf / 12);
                totalSSCompanyMonthly += cost.ss_empresa || (cost.companySS / 12);
                totalCostMonthly += cost.coste_empresa || (cost.totalCost / 12);
            });
            
            // Empleados personalizados
            customEmployees.forEach(emp => {
                const cost = calculateTotalCompanyCost(emp);
                totalNetMonthly += cost.netMonthly;
                totalSSEmployeeMonthly += cost.ss_trabajador || (cost.ssEmployee / 12);
                totalIRPFMonthly += (cost.irpf / 12);
                totalSSCompanyMonthly += cost.ss_empresa || (cost.companySS / 12);
                totalCostMonthly += cost.coste_empresa || (cost.totalCost / 12);
            });
            
            return {
                netMonthly: totalNetMonthly,
                ssEmployeeMonthly: totalSSEmployeeMonthly,
                irpfMonthly: totalIRPFMonthly,
                ssCompanyMonthly: totalSSCompanyMonthly,
                costMonthly: totalCostMonthly
            };
        }

        // Calculate monthly operative cost
        function calculateMonthlyOperativeCost() {
            const alquiler = parseFloat(document.getElementById('alquiler').value) * 12;
            const luz = parseFloat(document.getElementById('luz').value) * 12;
            const agua = parseFloat(document.getElementById('agua').value) * 12;
            const gas = parseFloat(document.getElementById('gas').value) * 12;
            const carbon = parseFloat(document.getElementById('carbon').value || 0) * 12;
            const internet = parseFloat(document.getElementById('internet').value) * 12;
            const alarma = parseFloat(document.getElementById('alarma').value) * 12;
            const redes = parseFloat(document.getElementById('redes').value) * 12;
            const mantenimiento = parseFloat(document.getElementById('mantenimiento').value) * 12;
            const veladores = parseFloat(document.getElementById('veladores').value);
            const qamarero = parseFloat(document.getElementById('qamarero').value);
            const asesoria = parseFloat(document.getElementById('asesoria').value) * 12;
            const seguro = parseFloat(document.getElementById('seguro').value || 0);

            let total = alquiler + luz + agua + gas + carbon + internet + alarma + redes + mantenimiento + veladores + qamarero + asesoria + seguro;

            customExpenses.forEach(expense => {
                const frequency = expense.frequency || 'annual'; // Default to annual for backwards compatibility
                const annualAmount = frequency === 'monthly' ? (expense.amount || 0) * 12 : (expense.amount || 0);
                total += annualAmount;
            });

            return total;
        }
        
        function calculateMonthlyOperativeCostMonthly() {
            // Gastos mensuales (sin multiplicar)
            const alquiler = parseFloat(document.getElementById('alquiler').value);
            const luz = parseFloat(document.getElementById('luz').value);
            const agua = parseFloat(document.getElementById('agua').value);
            const gas = parseFloat(document.getElementById('gas').value);
            const carbon = parseFloat(document.getElementById('carbon').value || 0);
            const internet = parseFloat(document.getElementById('internet').value);
            const alarma = parseFloat(document.getElementById('alarma').value);
            const redes = parseFloat(document.getElementById('redes').value);
            const mantenimiento = parseFloat(document.getElementById('mantenimiento').value);
            const asesoria = parseFloat(document.getElementById('asesoria').value);
            
            // Gastos anuales (divididos por 12)
            const veladores = parseFloat(document.getElementById('veladores').value) / 12;
            const qamarero = parseFloat(document.getElementById('qamarero').value) / 12;
            const seguro = parseFloat(document.getElementById('seguro').value || 0) / 12;

            let total = alquiler + luz + agua + gas + carbon + internet + alarma + redes + mantenimiento + asesoria + veladores + qamarero + seguro;

            // Gastos personalizados
            customExpenses.forEach(expense => {
                const frequency = expense.frequency || 'annual'; // Default to annual for backwards compatibility
                const monthlyAmount = frequency === 'monthly' ? (expense.amount || 0) : ((expense.amount || 0) / 12);
                total += monthlyAmount;
            });

            return total;
        }

        // Update treasury chart
        function updateTreasuryChart() {
            const ctx = document.getElementById('treasuryChart');
            if (!ctx) return;

            if (treasuryChart) {
                treasuryChart.destroy();
            }

            const allMonths = Object.keys(groupByMonth()).sort();
            const monthLabels = [];
            const treasuryData = [];
            const revenueData = [];
            const expensesData = [];

            const capacidad = parseFloat(document.getElementById('capacidad').value);
            const ticket = parseFloat(document.getElementById('ticket').value);
            const aprovisionamientoPct = parseFloat(document.getElementById('aprovisionamiento').value) / 100;
            const monthlyExpenses = (calculateMonthlyPersonalCost() + calculateMonthlyOperativeCost()) / 12;

            let cumulativeTreasury = 0;

            allMonths.forEach(yearMonth => {
                const [year, month] = yearMonth.split('-');
                const monthName = monthNames[parseInt(month)];
                monthLabels.push(`${monthName.substring(0, 3)} ${year}`);

                const mDays = calendarData.filter(day => {
                    const key = `${day.a√±o}-${String(day.mes).padStart(2, '0')}`;
                    return key === yearMonth;
                });

                let mRevenue = 0;
                mDays.forEach(day => {
                    const planning = dailyPlanning[day.fecha];
                    if (planning && planning.open) {
                        const shifts = planning.shifts || 2;
                        const occupancy = (planning.occupancy || 40) / 100;
                        const comensales = Math.round(capacidad * occupancy);
                        mRevenue += comensales * ticket * shifts;
                    }
                });

                const mAprov = mRevenue * aprovisionamientoPct;
                const mMargen = mRevenue - mAprov;
                const mResult = mMargen - monthlyExpenses;
                cumulativeTreasury += mResult;

                revenueData.push(mRevenue);
                expensesData.push(monthlyExpenses);
                treasuryData.push(cumulativeTreasury);
            });

            treasuryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [
                        {
                            label: 'Tesorer√≠a Acumulada',
                            data: treasuryData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Ingresos Mensuales',
                            data: revenueData,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            hidden: true
                        },
                        {
                            label: 'Gastos Mensuales',
                            data: expensesData,
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            hidden: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        // ==================== MENU ADMIN FUNCTIONS ====================

        // Menu rules storage
        let menuRules = [];

        // Selected products for bulk edit
        let selectedProducts = [];

        // Audit log storage
        let auditLog = [];

        // Switch between menu admin tabs
        function switchMenuTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.menu-tab-content').forEach(content => {
                content.style.display = 'none';
            });

            // Remove active class from all buttons
            document.querySelectorAll('.menu-sub-tab').forEach(btn => {
                btn.style.borderBottomColor = 'transparent';
                btn.style.color = '#666';
            });

            // Show selected tab content
            document.getElementById('menu-content-' + tabName).style.display = 'block';

            // Add active class to selected button
            const activeBtn = document.getElementById('menu-tab-' + tabName);
            activeBtn.style.borderBottomColor = '#667eea';
            activeBtn.style.color = '#667eea';
        }

        // Render menu items table
        function renderMenuItems() {
            const container = document.getElementById('menu-items-container');
            if (!container) return;

            const searchTerm = (document.getElementById('menu-search')?.value || '').toLowerCase();
            const categoryFilter = document.getElementById('menu-category-filter')?.value || '';

            // Category display names
            const categoryNames = {
                'aperitivos': 'Aperitivos',
                'entrantes': 'Entrantes',
                'ensaladas': 'Ensaladas',
                'carnes': 'Carnes',
                'guarniciones': 'Guarniciones',
                'postres': 'Postres',
                'vinosblancos': 'Vinos Blancos',
                'vinosrosados': 'Vinos Rosados',
                'vinostintos': 'Vinos Tintos',
                'espumosos': 'Espumosos',
                'aperitivos_bebidas': 'Aperitivos (Bebidas)',
                'cervezas': 'Cervezas',
                'refrescos': 'Refrescos',
                'zumos': 'Zumos',
                'aguas': 'Aguas',
                'cafes': 'Caf√©s'
            };

            let html = '';
            let totalCount = 0;

            // Loop through all categories
            Object.keys(menuItems).forEach(category => {
                // Apply category filter
                if (categoryFilter && category !== categoryFilter) return;

                // Filter items by search term
                const filteredItems = menuItems[category].filter(item =>
                    item.name.toLowerCase().includes(searchTerm) ||
                    item.desc.toLowerCase().includes(searchTerm)
                );

                if (filteredItems.length === 0) return;

                totalCount += filteredItems.length;

                // Category header
                html += `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 15px; font-weight: bold; font-size: 16px; margin-top: 15px; border-radius: 8px 8px 0 0;">
                        ${categoryNames[category]} (${filteredItems.length})
                    </div>
                    <div style="background: white; border: 2px solid #ddd; border-top: none; border-radius: 0 0 8px 8px; overflow: hidden;">
                `;

                // Table header
                html += `
                    <div style="display: grid; grid-template-columns: 40px 2fr 3fr 1fr 1fr 1fr 80px; gap: 10px; padding: 10px 15px; background: #f8f9fa; font-weight: 600; border-bottom: 2px solid #ddd;">
                        <div style="text-align: center;">
                            <input type="checkbox" onchange="toggleCategorySelection('${category}', this.checked)" style="cursor: pointer;" title="Seleccionar todos">
                        </div>
                        <div>Nombre</div>
                        <div>Descripci√≥n</div>
                        <div>Precio (‚Ç¨)</div>
                        <div>Coste (‚Ç¨)</div>
                        <div>Margen %</div>
                        <div style="text-align: center;">Acciones</div>
                    </div>
                `;

                // Table rows
                filteredItems.forEach((item, index) => {
                    const margin = ((item.price - item.cost) / item.price * 100).toFixed(1);
                    const marginColor = margin > 70 ? '#28a745' : margin > 50 ? '#ffc107' : '#dc3545';
                    const productId = `${category}-${item.name}`;
                    const isSelected = selectedProducts.some(p => p.category === category && p.name === item.name);

                    html += `
                        <div style="display: grid; grid-template-columns: 40px 2fr 3fr 1fr 1fr 1fr 80px; gap: 10px; padding: 10px 15px; border-bottom: 1px solid #eee; align-items: center;">
                            <div style="text-align: center;">
                                <input type="checkbox" class="product-checkbox" data-category="${category}" data-name="${item.name.replace(/"/g, '&quot;')}"
                                       ${isSelected ? 'checked' : ''}
                                       onchange="toggleProductSelection('${category}', '${item.name.replace(/'/g, "\\'")}')"
                                       style="cursor: pointer;">
                            </div>
                            <div style="cursor: pointer; padding: 5px; border-radius: 4px; transition: background 0.2s;"
                                 onclick="editMenuField('${category}', ${index}, 'name', this)"
                                 onmouseover="this.style.background='#f0f0f0'"
                                 onmouseout="this.style.background='transparent'">
                                ${item.name}
                            </div>
                            <div style="cursor: pointer; padding: 5px; border-radius: 4px; transition: background 0.2s; font-size: 13px; color: #666;"
                                 onclick="editMenuField('${category}', ${index}, 'desc', this)"
                                 onmouseover="this.style.background='#f0f0f0'"
                                 onmouseout="this.style.background='transparent'">
                                ${item.desc}
                            </div>
                            <div style="cursor: pointer; padding: 5px; border-radius: 4px; transition: background 0.2s; font-weight: 600;"
                                 onclick="editMenuField('${category}', ${index}, 'price', this)"
                                 onmouseover="this.style.background='#f0f0f0'"
                                 onmouseout="this.style.background='transparent'">
                                ${item.price.toFixed(2)}
                            </div>
                            <div style="cursor: pointer; padding: 5px; border-radius: 4px; transition: background 0.2s; font-weight: 600; color: #dc3545;"
                                 onclick="editMenuField('${category}', ${index}, 'cost', this)"
                                 onmouseover="this.style.background='#f0f0f0'"
                                 onmouseout="this.style.background='transparent'">
                                ${item.cost.toFixed(2)}
                            </div>
                            <div style="font-weight: 600; color: ${marginColor};">
                                ${margin}%
                            </div>
                            <div style="text-align: center;">
                                <button onclick="deleteProduct('${category}', '${item.name.replace(/'/g, "\\'")}', ${index})"
                                        style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;"
                                        title="Eliminar producto">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            });

            if (totalCount === 0) {
                html = '<div style="padding: 40px; text-align: center; color: #666; font-size: 16px;">No se encontraron productos</div>';
            }

            container.innerHTML = html;
        }

        // Toggle product selection
        function toggleProductSelection(category, productName) {
            const index = selectedProducts.findIndex(p => p.category === category && p.name === productName);

            if (index >= 0) {
                selectedProducts.splice(index, 1);
            } else {
                // Find product data
                const product = menuItems[category].find(item => item.name === productName);
                if (product) {
                    selectedProducts.push({
                        category,
                        name: productName,
                        price: product.price,
                        cost: product.cost
                    });
                }
            }

            updateBulkEditPanel();
        }

        // Toggle category selection
        function toggleCategorySelection(category, checked) {
            const items = menuItems[category];

            if (checked) {
                // Add all items from this category
                items.forEach(item => {
                    const exists = selectedProducts.some(p => p.category === category && p.name === item.name);
                    if (!exists) {
                        selectedProducts.push({
                            category,
                            name: item.name,
                            price: item.price,
                            cost: item.cost
                        });
                    }
                });
            } else {
                // Remove all items from this category
                selectedProducts = selectedProducts.filter(p => p.category !== category);
            }

            renderMenuItems();
            updateBulkEditPanel();
        }

        // Clear selection
        function clearSelection() {
            selectedProducts = [];
            renderMenuItems();
            updateBulkEditPanel();
        }

        // Update bulk edit panel visibility and count
        function updateBulkEditPanel() {
            const panel = document.getElementById('bulk-edit-panel');
            const countSpan = document.getElementById('selected-count');

            if (selectedProducts.length > 0) {
                panel.style.display = 'block';
                countSpan.textContent = selectedProducts.length;
            } else {
                panel.style.display = 'none';
            }
        }

        // Apply bulk price adjustment
        async function applyBulkPriceAdjustment() {
            const adjustment = parseFloat(document.getElementById('price-adjustment').value);

            if (isNaN(adjustment)) {
                alert('Por favor introduce un porcentaje v√°lido');
                return;
            }

            if (!confirm(`¬øAjustar precio en ${adjustment}% para ${selectedProducts.length} productos?`)) {
                return;
            }

            let successCount = 0;

            for (const product of selectedProducts) {
                const item = menuItems[product.category].find(i => i.name === product.name);
                if (!item) continue;

                const newPrice = item.price * (1 + adjustment / 100);

                try {
                    const { error } = await supabaseClient
                        .from('menu_items')
                        .update({ price: newPrice })
                        .eq('category', product.category)
                        .eq('name', product.name);

                    if (!error) {
                        item.price = newPrice;
                        successCount++;
                    }
                } catch (err) {
                    console.error('Error updating price:', err);
                }
            }

            // Log bulk edit action
            if (successCount > 0) {
                for (const product of selectedProducts.slice(0, successCount)) {
                    await logAction('bulk_edit', product.category, product.name, {
                        oldValue: `Precio ajustado ${adjustment > 0 ? '+' : ''}${adjustment}%`
                    });
                }
            }

            document.getElementById('price-adjustment').value = '';
            clearSelection();
            renderMenuItems();
            alert(`Precios actualizados: ${successCount}/${selectedProducts.length} productos`);
        }

        // Apply bulk cost adjustment
        async function applyBulkCostAdjustment() {
            const adjustment = parseFloat(document.getElementById('cost-adjustment').value);

            if (isNaN(adjustment)) {
                alert('Por favor introduce un porcentaje v√°lido');
                return;
            }

            if (!confirm(`¬øAjustar coste en ${adjustment}% para ${selectedProducts.length} productos?`)) {
                return;
            }

            let successCount = 0;

            for (const product of selectedProducts) {
                const item = menuItems[product.category].find(i => i.name === product.name);
                if (!item) continue;

                const newCost = item.cost * (1 + adjustment / 100);

                try {
                    const { error } = await supabaseClient
                        .from('menu_items')
                        .update({ cost: newCost })
                        .eq('category', product.category)
                        .eq('name', product.name);

                    if (!error) {
                        item.cost = newCost;
                        successCount++;
                    }
                } catch (err) {
                    console.error('Error updating cost:', err);
                }
            }

            // Log bulk edit action
            if (successCount > 0) {
                for (const product of selectedProducts.slice(0, successCount)) {
                    await logAction('bulk_edit', product.category, product.name, {
                        oldValue: `Coste ajustado ${adjustment > 0 ? '+' : ''}${adjustment}%`
                    });
                }
            }

            document.getElementById('cost-adjustment').value = '';
            clearSelection();
            renderMenuItems();
            alert(`Costes actualizados: ${successCount}/${selectedProducts.length} productos`);
        }

        // Apply bulk margin target
        async function applyBulkMarginTarget() {
            const targetMargin = parseFloat(document.getElementById('margin-target').value);

            if (isNaN(targetMargin) || targetMargin < 0 || targetMargin > 100) {
                alert('Por favor introduce un margen v√°lido entre 0 y 100');
                return;
            }

            if (!confirm(`¬øCalcular precio para margen del ${targetMargin}% en ${selectedProducts.length} productos?`)) {
                return;
            }

            let successCount = 0;

            for (const product of selectedProducts) {
                const item = menuItems[product.category].find(i => i.name === product.name);
                if (!item) continue;

                // Calculate: price = cost / (1 - margin/100)
                const newPrice = item.cost / (1 - targetMargin / 100);

                try {
                    const { error } = await supabaseClient
                        .from('menu_items')
                        .update({ price: newPrice })
                        .eq('category', product.category)
                        .eq('name', product.name);

                    if (!error) {
                        item.price = newPrice;
                        successCount++;
                    }
                } catch (err) {
                    console.error('Error updating price:', err);
                }
            }

            // Log bulk edit action
            if (successCount > 0) {
                for (const product of selectedProducts.slice(0, successCount)) {
                    await logAction('bulk_edit', product.category, product.name, {
                        oldValue: `Precio ajustado para margen ${targetMargin}%`
                    });
                }
            }

            document.getElementById('margin-target').value = '';
            clearSelection();
            renderMenuItems();
            alert(`Precios actualizados para margen target: ${successCount}/${selectedProducts.length} productos`);
        }

        // Filter menu items
        function filterMenuItems() {
            renderMenuItems();
        }

        // Edit menu field inline
        function editMenuField(category, index, field, element) {
            const currentValue = menuItems[category][index][field];
            const isNumeric = field === 'price' || field === 'cost';

            // Create input element
            const input = document.createElement('input');
            input.type = isNumeric ? 'number' : 'text';
            input.value = currentValue;
            input.step = isNumeric ? '0.01' : '';
            input.style.cssText = 'width: 100%; padding: 5px; border: 2px solid #667eea; border-radius: 4px; font-size: 14px;';

            // Replace element content with input
            const originalContent = element.innerHTML;
            element.innerHTML = '';
            element.appendChild(input);
            input.focus();
            if (isNumeric) input.select();

            // Save on blur or enter
            let isSaving = false; // Prevent multiple executions
            const save = async () => {
                if (isSaving) return; // Already saving, skip
                isSaving = true;

                let newValue = input.value.trim();

                if (isNumeric) {
                    newValue = parseFloat(newValue);
                    if (isNaN(newValue) || newValue < 0) {
                        alert('Por favor introduce un n√∫mero v√°lido mayor o igual a 0');
                        element.innerHTML = originalContent;
                        isSaving = false;
                        return;
                    }
                } else if (newValue === '') {
                    alert('Este campo no puede estar vac√≠o');
                    element.innerHTML = originalContent;
                    isSaving = false;
                    return;
                }

                // Get the item name for the database query
                const itemName = menuItems[category][index].name;

                // Update the value in menuItems (local state)
                menuItems[category][index][field] = newValue;

                // Map field names to database columns
                const dbFieldMap = {
                    'name': 'name',
                    'desc': 'description',
                    'price': 'price',
                    'cost': 'cost'
                };

                // Save to Supabase
                try {
                    const updateData = {};
                    updateData[dbFieldMap[field]] = newValue;

                    const { data, error } = await supabaseClient
                        .from('menu_items')
                        .update(updateData)
                        .eq('category', category)
                        .eq('name', itemName)
                        .select();

                    if (error) {
                        console.error('Error updating in Supabase:', error);
                        alert('Error al guardar en la base de datos: ' + error.message);
                        // Revert local change on error
                        menuItems[category][index][field] = currentValue;
                    } else {
                        console.log('Successfully updated in Supabase:', data);
                        // Log the action
                        await logAction('edit', category, itemName, {
                            field: dbFieldMap[field],
                            oldValue: currentValue,
                            newValue: newValue
                        });
                    }
                } catch (err) {
                    console.error('Supabase error:', err);
                    alert('Error de conexi√≥n con la base de datos');
                    // Revert local change on error
                    menuItems[category][index][field] = currentValue;
                }

                // Re-render to show updated values
                renderMenuItems();
            };

            input.addEventListener('blur', save);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    input.blur(); // Trigger blur event instead of calling save directly
                } else if (e.key === 'Escape') {
                    element.innerHTML = originalContent;
                }
            });
        }

        // Download menu as CSV
        function downloadMenuCSV() {
            let csv = 'Categor√≠a,Nombre,Descripci√≥n,Precio (‚Ç¨),Coste (‚Ç¨),Margen (%)\n';

            const categoryNames = {
                'aperitivos': 'Aperitivos',
                'entrantes': 'Entrantes',
                'ensaladas': 'Ensaladas',
                'carnes': 'Carnes',
                'guarniciones': 'Guarniciones',
                'postres': 'Postres',
                'vinosblancos': 'Vinos Blancos',
                'vinosrosados': 'Vinos Rosados',
                'vinostintos': 'Vinos Tintos',
                'espumosos': 'Espumosos',
                'aperitivos_bebidas': 'Aperitivos (Bebidas)',
                'cervezas': 'Cervezas',
                'refrescos': 'Refrescos',
                'zumos': 'Zumos',
                'aguas': 'Aguas',
                'cafes': 'Caf√©s'
            };

            Object.keys(menuItems).forEach(category => {
                menuItems[category].forEach(item => {
                    const margin = ((item.price - item.cost) / item.price * 100).toFixed(1);
                    const escapedDesc = item.desc.replace(/"/g, '""');
                    csv += `"${categoryNames[category]}","${item.name}","${escapedDesc}",${item.price.toFixed(2)},${item.cost.toFixed(2)},${margin}\n`;
                });
            });

            // Create download link
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', 'menu_conacento.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Open modal to add new product
        function openAddProductModal() {
            const categoryOptions = `
                <optgroup label="Comida">
                    <option value="aperitivos">Aperitivos</option>
                    <option value="entrantes">Entrantes</option>
                    <option value="ensaladas">Ensaladas</option>
                    <option value="carnes">Carnes</option>
                    <option value="guarniciones">Guarniciones</option>
                    <option value="postres">Postres</option>
                </optgroup>
                <optgroup label="Vinos">
                    <option value="vinosblancos">Vinos Blancos</option>
                    <option value="vinosrosados">Vinos Rosados</option>
                    <option value="vinostintos">Vinos Tintos</option>
                    <option value="espumosos">Espumosos</option>
                </optgroup>
                <optgroup label="Otras Bebidas">
                    <option value="aperitivos_bebidas">Aperitivos (Bebidas)</option>
                    <option value="cervezas">Cervezas</option>
                    <option value="refrescos">Refrescos</option>
                    <option value="zumos">Zumos</option>
                    <option value="aguas">Aguas</option>
                    <option value="cafes">Caf√©s</option>
                </optgroup>
            `;

            const modalBody = `
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Categor√≠a:</label>
                        <select id="new-product-category" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                            <option value="">-- Selecciona categor√≠a --</option>
                            ${categoryOptions}
                        </select>
                    </div>
                    <div>
                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Nombre:</label>
                        <input type="text" id="new-product-name" placeholder="Ej: Solomillo a la brasa" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div>
                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Descripci√≥n:</label>
                        <textarea id="new-product-desc" placeholder="Descripci√≥n del producto..." rows="3" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;"></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Precio (‚Ç¨):</label>
                            <input type="number" id="new-product-price" placeholder="0.00" step="0.01" min="0" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Coste (‚Ç¨):</label>
                            <input type="number" id="new-product-cost" placeholder="0.00" step="0.01" min="0" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>
                    </div>
                </div>
            `;

            openModal('A√±adir Nuevo Producto', modalBody, 'A√±adir', () => {
                addProduct();
            });
        }

        // Add new product
        async function addProduct() {
            const category = document.getElementById('new-product-category').value;
            const name = document.getElementById('new-product-name').value.trim();
            const desc = document.getElementById('new-product-desc').value.trim();
            const price = parseFloat(document.getElementById('new-product-price').value);
            const cost = parseFloat(document.getElementById('new-product-cost').value);

            // Validation
            if (!category) {
                alert('Por favor selecciona una categor√≠a');
                return;
            }
            if (!name) {
                alert('Por favor introduce un nombre para el producto');
                return;
            }
            if (!desc) {
                alert('Por favor introduce una descripci√≥n');
                return;
            }
            if (isNaN(price) || price < 0) {
                alert('Por favor introduce un precio v√°lido');
                return;
            }
            if (isNaN(cost) || cost < 0) {
                alert('Por favor introduce un coste v√°lido');
                return;
            }

            // Check if product already exists
            const existingProduct = menuItems[category]?.find(item => item.name.toLowerCase() === name.toLowerCase());
            if (existingProduct) {
                alert('Ya existe un producto con ese nombre en esta categor√≠a');
                return;
            }

            // Add to Supabase
            try {
                const { data, error } = await supabaseClient
                    .from('menu_items')
                    .insert([
                        {
                            category: category,
                            name: name,
                            description: desc,
                            price: price,
                            cost: cost
                        }
                    ])
                    .select();

                if (error) {
                    console.error('Error adding to Supabase:', error);
                    alert('Error al guardar en la base de datos: ' + error.message);
                    return;
                }

                console.log('Successfully added to Supabase:', data);

                // Log the action
                await logAction('add', category, name, {});

                // Add to local menuItems
                if (!menuItems[category]) {
                    menuItems[category] = [];
                }
                menuItems[category].push({
                    name: name,
                    desc: desc,
                    price: price,
                    cost: cost
                });

                // Close modal and refresh view
                closeModal();
                renderMenuItems();
                alert('Producto a√±adido correctamente');

            } catch (err) {
                console.error('Supabase error:', err);
                alert('Error de conexi√≥n con la base de datos');
            }
        }

        // Delete product
        async function deleteProduct(category, productName, index) {
            if (!confirm(`¬øEst√°s seguro de que quieres eliminar "${productName}"?`)) {
                return;
            }

            try {
                // Delete from Supabase
                const supabaseClient = getSupabase();
                if (!supabaseClient) return;
                const { error } = await supabaseClient
                    .from('menu_items')
                    .delete()
                    .eq('category', category)
                    .eq('name', productName);

                if (error) {
                    console.error('Error deleting from Supabase:', error);
                    alert('Error al eliminar de la base de datos: ' + error.message);
                    return;
                }

                console.log('Successfully deleted from Supabase');

                // Log the action
                await logAction('delete', category, productName, {});

                // Remove from local menuItems
                menuItems[category].splice(index, 1);

                // Refresh view
                renderMenuItems();
                alert('Producto eliminado correctamente');

            } catch (err) {
                console.error('Supabase error:', err);
                alert('Error de conexi√≥n con la base de datos');
            }
        }

        // Load menu items from Supabase
        async function loadMenuItemsFromSupabase() {
            try {
                const supabaseClient = getSupabase();
                if (!supabaseClient) {
                    console.warn('Supabase not initialized, skipping menu load');
                    return false;
                }
                const { data, error } = await supabaseClient
                    .from('menu_items')
                    .select('*')
                    .order('category', { ascending: true })
                    .order('name', { ascending: true });

                if (error) {
                    console.error('Error loading from Supabase:', error);
                    console.log('Using local menu data instead');
                    return false;
                }

                if (data && data.length > 0) {
                    // Clear existing menuItems
                    Object.keys(menuItems).forEach(key => {
                        menuItems[key] = [];
                    });

                    // Populate menuItems from Supabase data
                    data.forEach(item => {
                        const category = item.category;
                        if (!menuItems[category]) {
                            menuItems[category] = [];
                        }
                        menuItems[category].push({
                            name: item.name,
                            desc: item.description,
                            price: item.price,
                            cost: item.cost
                        });
                    });

                    console.log('Successfully loaded menu items from Supabase');
                    return true;
                }
            } catch (err) {
                console.error('Supabase connection error:', err);
                console.log('Using local menu data instead');
                return false;
            }
        }

        // ==================== MENU RULES FUNCTIONS ====================

        // Category display names for rules
        const ruleCategoryNames = {
            'aperitivos': 'Aperitivos',
            'entrantes': 'Entrantes',
            'ensaladas': 'Ensaladas',
            'carnes': 'Carnes',
            'guarniciones': 'Guarniciones',
            'postres': 'Postres',
            'vinosblancos': 'Vinos Blancos',
            'vinosrosados': 'Vinos Rosados',
            'vinostintos': 'Vinos Tintos',
            'espumosos': 'Espumosos',
            'aperitivos_bebidas': 'Aperitivos (Bebidas)',
            'cervezas': 'Cervezas',
            'refrescos': 'Refrescos',
            'zumos': 'Zumos',
            'aguas': 'Aguas',
            'cafes': 'Caf√©s',
            // Special groups
            'vinos_botellas': 'Vinos (solo botellas)',
            'bebidas_alcoholicas': 'Bebidas Alcoh√≥licas'
        };

        // Render rules table
        function renderRules() {
            const container = document.getElementById('rules-container');
            if (!container) return;

            if (menuRules.length === 0) {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #666; font-size: 16px; background: #f9f9f9; border-radius: 8px;">
                        No hay reglas definidas a√∫n. Haz clic en "A√±adir Nueva Regla" para comenzar.
                    </div>
                `;
                return;
            }

            let html = `
                <div style="background: white; border: 2px solid #ddd; border-radius: 8px; overflow: hidden;">
                    <div style="display: grid; grid-template-columns: 100px 2fr 120px 150px 100px 100px; gap: 10px; padding: 10px 15px; background: #f8f9fa; font-weight: 600; border-bottom: 2px solid #ddd;">
                        <div>Tipo</div>
                        <div>Categor√≠as</div>
                        <div>L√≠mite</div>
                        <div>Por Personas</div>
                        <div>Estado</div>
                        <div style="text-align: center;">Acciones</div>
                    </div>
            `;

            menuRules.forEach((rule, index) => {
                const typeText = rule.rule_type === 'max' ? 'M√°ximo' : 'M√≠nimo';
                const typeColor = rule.rule_type === 'max' ? '#dc3545' : '#28a745';

                // Format categories display
                const categoriesText = rule.categories.map(cat => ruleCategoryNames[cat] || cat).join(' + ');

                // Format per_people text
                const perPeopleText = rule.per_people
                    ? `cada ${rule.per_people} ${rule.per_people === 1 ? 'persona' : 'personas'}`
                    : 'en total';

                const statusColor = rule.is_active ? '#28a745' : '#999';
                const statusText = rule.is_active ? '‚úÖ Activa' : '‚è∏Ô∏è Inactiva';

                html += `
                    <div style="display: grid; grid-template-columns: 100px 2fr 120px 150px 100px 100px; gap: 10px; padding: 12px 15px; border-bottom: 1px solid #eee; align-items: center;">
                        <div style="font-weight: 600; color: ${typeColor};">
                            ${typeText}
                        </div>
                        <div style="font-size: 14px;">
                            ${categoriesText}
                        </div>
                        <div style="font-weight: 600;">
                            ${rule.quantity} ${rule.quantity === 1 ? 'producto' : 'productos'}
                        </div>
                        <div style="font-size: 14px; color: #666;">
                            ${perPeopleText}
                        </div>
                        <div style="font-weight: 600; color: ${statusColor}; font-size: 13px;">
                            ${statusText}
                        </div>
                        <div style="text-align: center; display: flex; gap: 8px; justify-content: center;">
                            <button onclick="toggleRuleStatus(${index})"
                                    style="padding: 6px 10px; background: ${rule.is_active ? '#ffc107' : '#28a745'}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;"
                                    title="${rule.is_active ? 'Desactivar' : 'Activar'}">
                                ${rule.is_active ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}
                            </button>
                            <button onclick="deleteRule(${index})"
                                    style="padding: 6px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;"
                                    title="Eliminar regla">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Open modal to add new rule
        function openAddRuleModal() {
            const categoryCheckboxes = Object.keys(ruleCategoryNames).map(key => {
                return `
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">
                        <input type="checkbox" value="${key}" class="rule-category-checkbox" style="cursor: pointer;">
                        <span style="font-size: 14px;">${ruleCategoryNames[key]}</span>
                    </label>
                `;
            }).join('');

            const modalBody = `
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <div>
                        <label style="font-weight: bold; display: block; margin-bottom: 8px;">Tipo de regla:</label>
                        <div style="display: flex; gap: 15px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="rule-type" value="max" checked style="cursor: pointer;">
                                <span>M√°ximo</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="rule-type" value="min" style="cursor: pointer;">
                                <span>M√≠nimo</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label style="font-weight: bold; display: block; margin-bottom: 8px;">Categor√≠as (selecciona una o varias):</label>
                        <div style="max-height: 200px; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; background: #f9f9f9; border-radius: 6px;">
                            ${categoryCheckboxes}
                        </div>
                    </div>

                    <div>
                        <label style="font-weight: bold; display: block; margin-bottom: 8px;">Cantidad l√≠mite:</label>
                        <input type="number" id="new-rule-quantity" placeholder="Ej: 4" min="0" step="0.5" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>

                    <div>
                        <label style="font-weight: bold; display: block; margin-bottom: 8px;">Aplicar:</label>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="rule-apply" value="per-people" checked style="cursor: pointer;">
                                <span>Por cada</span>
                                <input type="number" id="new-rule-per-people" placeholder="2" min="1" value="2" style="width: 60px; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                <span>personas</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="rule-apply" value="total" style="cursor: pointer;">
                                <span>En total (sin importar n√∫mero de personas)</span>
                            </label>
                        </div>
                    </div>
                </div>
            `;

            openModal('A√±adir Nueva Regla', modalBody, 'Crear Regla', () => {
                addRule();
            });
        }

        // Add new rule
        async function addRule() {
            const ruleType = document.querySelector('input[name="rule-type"]:checked').value;
            const selectedCategories = Array.from(document.querySelectorAll('.rule-category-checkbox:checked')).map(cb => cb.value);
            const quantity = parseFloat(document.getElementById('new-rule-quantity').value);
            const applyType = document.querySelector('input[name="rule-apply"]:checked').value;
            const perPeople = applyType === 'per-people' ? parseInt(document.getElementById('new-rule-per-people').value) : null;

            // Validation
            if (selectedCategories.length === 0) {
                alert('Por favor selecciona al menos una categor√≠a');
                return;
            }
            if (isNaN(quantity) || quantity <= 0) {
                alert('Por favor introduce una cantidad v√°lida mayor que 0');
                return;
            }
            if (applyType === 'per-people' && (isNaN(perPeople) || perPeople <= 0)) {
                alert('Por favor introduce un n√∫mero de personas v√°lido');
                return;
            }

            const newRule = {
                rule_type: ruleType,
                categories: selectedCategories,
                quantity: quantity,
                per_people: perPeople,
                is_active: true
            };

            // Add to Supabase
            try {
                const { data, error } = await supabaseClient
                    .from('menu_rules')
                    .insert([newRule])
                    .select();

                if (error) {
                    console.error('Error adding rule to Supabase:', error);
                    alert('Error al guardar la regla en la base de datos: ' + error.message);
                    return;
                }

                console.log('Successfully added rule to Supabase:', data);

                // Add to local menuRules (with id from Supabase)
                menuRules.push(data[0]);

                // Close modal and refresh view
                closeModal();
                renderRules();
                alert('Regla a√±adida correctamente');

            } catch (err) {
                console.error('Supabase error:', err);
                alert('Error de conexi√≥n con la base de datos');
            }
        }

        // Toggle rule active status
        async function toggleRuleStatus(index) {
            const rule = menuRules[index];
            const newStatus = !rule.is_active;

            try {
                const supabaseClient = getSupabase();
                if (!supabaseClient) return;
                const { error } = await supabaseClient
                    .from('menu_rules')
                    .update({ is_active: newStatus })
                    .eq('id', rule.id);

                if (error) {
                    console.error('Error updating rule in Supabase:', error);
                    alert('Error al actualizar la regla: ' + error.message);
                    return;
                }

                // Update local state
                menuRules[index].is_active = newStatus;
                renderRules();

            } catch (err) {
                console.error('Supabase error:', err);
                alert('Error de conexi√≥n con la base de datos');
            }
        }

        // Delete rule
        async function deleteRule(index) {
            const rule = menuRules[index];

            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta regla?')) {
                return;
            }

            try {
                const supabaseClient = getSupabase();
                if (!supabaseClient) return;
                const { error } = await supabaseClient
                    .from('menu_rules')
                    .delete()
                    .eq('id', rule.id);

                if (error) {
                    console.error('Error deleting rule from Supabase:', error);
                    alert('Error al eliminar la regla: ' + error.message);
                    return;
                }

                console.log('Successfully deleted rule from Supabase');

                // Remove from local menuRules
                menuRules.splice(index, 1);

                // Refresh view
                renderRules();
                alert('Regla eliminada correctamente');

            } catch (err) {
                console.error('Supabase error:', err);
                alert('Error de conexi√≥n con la base de datos');
            }
        }

        // Load rules from Supabase
        async function loadRulesFromSupabase() {
            try {
                const supabaseClient = getSupabase();
                if (!supabaseClient) {
                    console.warn('Supabase not initialized, skipping rules load');
                    return false;
                }
                if (!supabaseClient) return false;
                const { data, error } = await supabaseClient
                    .from('menu_rules')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Error loading rules from Supabase:', error);
                    return false;
                }

                if (data) {
                    menuRules = data;
                    console.log('Successfully loaded rules from Supabase:', data.length);
                    return true;
                }
            } catch (err) {
                console.error('Supabase error loading rules:', err);
                return false;
            }
        }

        // Validate scenario against rules
        function validateAgainstRules(category, itemName) {
            const activeRules = menuRules.filter(r => r.is_active);
            const people = currentScenario.people;

            for (const rule of activeRules) {
                // Check if this rule applies to the category
                if (!rule.categories.includes(category)) {
                    // Check for special category groups
                    if (category.includes('vino') && rule.categories.includes('vinos_botellas')) {
                        const item = menuItems[category].find(i => i.name === itemName);
                        if (!item || !item.desc.includes('Botella')) {
                            continue; // Rule doesn't apply to non-bottle wines
                        }
                    } else {
                        continue; // Rule doesn't apply to this category
                    }
                }

                // Count current items in the rule's categories
                let currentCount = 0;
                for (const ruleCategory of rule.categories) {
                    currentCount += currentScenario.items
                        .filter(item => item.category === ruleCategory)
                        .reduce((sum, item) => sum + item.qty, 0);
                }

                // Calculate limit based on rule
                let limit;
                if (rule.per_people) {
                    limit = Math.floor(people / rule.per_people) * rule.quantity;
                } else {
                    limit = rule.quantity;
                }

                // Check if adding would violate the rule
                if (rule.rule_type === 'max') {
                    if (currentCount >= limit) {
                        const categoriesText = rule.categories.map(c => ruleCategoryNames[c] || c).join(' + ');
                        const perPeopleText = rule.per_people
                            ? ` por cada ${rule.per_people} ${rule.per_people === 1 ? 'persona' : 'personas'}`
                            : ' en total';
                        return {
                            valid: false,
                            message: `‚õî No se puede a√±adir este producto.\n\nRegla: M√°ximo ${rule.quantity} de (${categoriesText})${perPeopleText}\n\nL√≠mite actual: ${limit} productos\nYa tienes: ${currentCount} productos`
                        };
                    }
                }
            }

            return { valid: true };
        }

        // ==================== AUDIT LOG FUNCTIONS ====================

        // Log action to audit log
        async function logAction(action, category, productName, details = {}) {
            const logEntry = {
                action,
                category,
                product_name: productName,
                field_changed: details.field || null,
                old_value: details.oldValue !== undefined ? String(details.oldValue) : null,
                new_value: details.newValue !== undefined ? String(details.newValue) : null,
                created_at: new Date().toISOString()
            };

            try {
                const { data, error } = await supabaseClient
                    .from('menu_audit_log')
                    .insert([logEntry])
                    .select();

                if (error) {
                    console.error('Error logging action:', error);
                } else {
                    console.log('Action logged:', logEntry);
                    if (data && data[0]) {
                        auditLog.unshift(data[0]); // Add to start of array
                    }
                }
            } catch (err) {
                console.error('Error logging to audit:', err);
            }
        }

        // Load audit log from Supabase
        async function loadAuditLog() {
            try {
                const supabaseClient = getSupabase();
                if (!supabaseClient) {
                    console.warn('Supabase not initialized, skipping audit log load');
                    return false;
                }
                if (!supabaseClient) return false;
                const { data, error } = await supabaseClient
                    .from('menu_audit_log')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(500); // Last 500 entries

                if (error) {
                    console.error('Error loading audit log:', error);
                    return false;
                }

                if (data) {
                    auditLog = data;
                    console.log('Successfully loaded audit log:', data.length, 'entries');
                    return true;
                }
            } catch (err) {
                console.error('Error loading audit log:', err);
                return false;
            }
        }

        // Render audit log
        function renderAuditLog() {
            const container = document.getElementById('history-container');
            if (!container) return;

            const actionFilter = document.getElementById('history-action-filter')?.value || '';
            const categoryFilter = document.getElementById('history-category-filter')?.value || '';
            const searchTerm = (document.getElementById('history-search')?.value || '').toLowerCase();

            // Filter log entries
            let filteredLog = auditLog.filter(entry => {
                if (actionFilter && entry.action !== actionFilter) return false;
                if (categoryFilter && entry.category !== categoryFilter) return false;
                if (searchTerm && !entry.product_name.toLowerCase().includes(searchTerm)) return false;
                return true;
            });

            if (filteredLog.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #666; font-size: 16px; background: #f9f9f9; border-radius: 8px;">No se encontraron registros</div>';
                return;
            }

            const actionIcons = {
                'edit': '‚úèÔ∏è',
                'add': '‚ûï',
                'delete': 'üóëÔ∏è',
                'bulk_edit': 'üìù'
            };

            const actionLabels = {
                'edit': 'Edici√≥n',
                'add': 'A√±adido',
                'delete': 'Eliminado',
                'bulk_edit': 'Edici√≥n Masiva'
            };

            const actionColors = {
                'edit': '#ffc107',
                'add': '#28a745',
                'delete': '#dc3545',
                'bulk_edit': '#667eea'
            };

            let html = `
                <div style="background: white; border: 2px solid #ddd; border-radius: 8px; overflow: hidden;">
                    <div style="display: grid; grid-template-columns: 180px 120px 200px 200px 1fr; gap: 10px; padding: 10px 15px; background: #f8f9fa; font-weight: 600; border-bottom: 2px solid #ddd;">
                        <div>Fecha/Hora</div>
                        <div>Acci√≥n</div>
                        <div>Categor√≠a</div>
                        <div>Producto</div>
                        <div>Detalles</div>
                    </div>
            `;

            filteredLog.forEach(entry => {
                const date = new Date(entry.created_at);
                const dateStr = date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

                const categoryNames = {
                    'aperitivos': 'Aperitivos',
                    'entrantes': 'Entrantes',
                    'ensaladas': 'Ensaladas',
                    'carnes': 'Carnes',
                    'guarniciones': 'Guarniciones',
                    'postres': 'Postres',
                    'vinosblancos': 'Vinos Blancos',
                    'vinosrosados': 'Vinos Rosados',
                    'vinostintos': 'Vinos Tintos',
                    'espumosos': 'Espumosos',
                    'aperitivos_bebidas': 'Aperitivos (Bebidas)',
                    'cervezas': 'Cervezas',
                    'refrescos': 'Refrescos',
                    'zumos': 'Zumos',
                    'aguas': 'Aguas',
                    'cafes': 'Caf√©s'
                };

                let details = '';
                if (entry.action === 'edit' && entry.field_changed) {
                    const fieldLabels = {
                        'name': 'Nombre',
                        'description': 'Descripci√≥n',
                        'price': 'Precio',
                        'cost': 'Coste'
                    };
                    details = `${fieldLabels[entry.field_changed] || entry.field_changed}: ${entry.old_value} ‚Üí ${entry.new_value}`;
                } else if (entry.action === 'add') {
                    details = 'Producto nuevo a√±adido';
                } else if (entry.action === 'delete') {
                    details = 'Producto eliminado';
                } else if (entry.action === 'bulk_edit') {
                    details = entry.old_value || 'Actualizaci√≥n masiva';
                }

                html += `
                    <div style="display: grid; grid-template-columns: 180px 120px 200px 200px 1fr; gap: 10px; padding: 12px 15px; border-bottom: 1px solid #eee; align-items: center;">
                        <div style="font-size: 13px; color: #666;">
                            ${dateStr}<br>${timeStr}
                        </div>
                        <div style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: ${actionColors[entry.action]}; color: white; border-radius: 4px; font-weight: 600; font-size: 12px; width: fit-content;">
                            ${actionIcons[entry.action]} ${actionLabels[entry.action]}
                        </div>
                        <div style="font-size: 13px;">
                            ${categoryNames[entry.category] || entry.category}
                        </div>
                        <div style="font-weight: 600; font-size: 14px;">
                            ${entry.product_name}
                        </div>
                        <div style="font-size: 13px; color: #666;">
                            ${details}
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Filter history
        function filterHistory() {
            renderAuditLog();
        }

        // ==================== END MENU ADMIN FUNCTIONS ====================


        // Inicializar - Simplified and robust
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure first tab is visible immediately
            try {
                var firstTab = document.getElementById('tab-planificacion');
                if (firstTab) {
                    firstTab.classList.add('active');
                    firstTab.style.display = 'block';
                }
            } catch (e) {
                console.error('Error showing first tab:', e);
            }
            
            // Create mock Supabase client immediately (so content renders even if Supabase fails)
            window.supabaseClient = {
                from: function() {
                    return {
                        select: function() { return Promise.resolve({ data: [], error: null }); },
                        insert: function() { return Promise.resolve({ data: null, error: null }); },
                        update: function() { return Promise.resolve({ data: null, error: null }); },
                        delete: function() { return Promise.resolve({ data: null, error: null }); },
                        order: function() { return this; },
                        limit: function() { return this; }
                    };
                }
            };
            
            // Try to initialize real Supabase (non-blocking)
            setTimeout(function() {
                try {
                    // Supabase CDN exposes 'supabase' as a global variable with createClient method
                    var supabaseLib = window.supabase;
                    if (supabaseLib && supabaseLib.createClient) {
                        window.supabaseClient = supabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                        console.log('Supabase client initialized');
                    } else {
                        console.warn('Supabase library not loaded, using mock client');
                    }
                } catch (e) {
                    console.error('Supabase init error:', e);
                    console.log('Continuing with mock client');
                }
            }, 50);
            
            // Initialize core functionality (with error handling)
            // Use multiple timeouts to ensure everything loads in order
            setTimeout(function() {
                try {
                    console.log('=== Starting initialization ===');
                    
                    // Step 1: Initialize calendar data first (this is critical)
                    console.log('Step 1: Parsing calendar data...');
                    if (typeof parseCalendarData === 'function') {
                        parseCalendarData();
                        console.log('‚úì Calendar data parsed, days:', typeof calendarData !== 'undefined' ? calendarData.length : 0);
                    } else {
                        console.error('‚úó parseCalendarData function not found!');
                    }
                } catch (e) {
                    console.error('Error in step 1:', e);
                }
            }, 100);
            
            setTimeout(function() {
                try {
                    // Step 2: Render calendar
                    console.log('Step 2: Rendering calendar...');
                    if (typeof renderCalendar === 'function') {
                        renderCalendar();
                        console.log('‚úì Calendar rendered');
                    } else {
                        console.error('‚úó renderCalendar function not found!');
                    }
                } catch (e) {
                    console.error('Error in step 2:', e);
                }
            }, 200);
            
            setTimeout(function() {
                try {
                    // Step 3: Initialize employees
                    console.log('Step 3: Initializing employees...');
                    if (typeof initEmployees === 'function') {
                        initEmployees();
                        console.log('‚úì Employees initialized');
                    }
                } catch (e) {
                    console.error('Error in step 3:', e);
                }
            }, 300);
            
            setTimeout(function() {
                try {
                    // Step 4: Update calculations
                    console.log('Step 4: Updating calculations...');
                    if (typeof updateAllCalculations === 'function') {
                        updateAllCalculations();
                        console.log('‚úì Calculations updated');
                    }
                } catch (e) {
                    console.error('Error in step 4:', e);
                }
            }, 400);
            
            setTimeout(function() {
                try {
                    // Step 5: Render menu admin components
                    console.log('Step 5: Rendering menu admin...');
                    if (typeof renderMenuItems === 'function') {
                        renderMenuItems();
                        console.log('‚úì Menu items rendered');
                    }
                    if (typeof renderRules === 'function') {
                        renderRules();
                        console.log('‚úì Rules rendered');
                    }
                    if (typeof renderAuditLog === 'function') {
                        renderAuditLog();
                        console.log('‚úì Audit log rendered');
                    }
                    console.log('=== Initialization complete ===');
                } catch (e) {
                    console.error('Error in step 5:', e);
                }
            }, 500);
            
            // Load from Supabase (non-blocking)
            setTimeout(function() {
                if (window.supabaseClient && typeof loadMenuItemsFromSupabase === 'function') {
                    loadMenuItemsFromSupabase().catch(function(e) { console.error('Load error:', e); });
                    loadRulesFromSupabase().catch(function(e) { console.error('Load error:', e); });
                    loadAuditLog().catch(function(e) { console.error('Load error:', e); });
                }
            }, 500);
            
            // Initialize mobile enhancements (non-blocking)
            setTimeout(function() {
                try {
                    if (typeof initSwipeGestures === 'function') {
                        initSwipeGestures();
                    }
                } catch (e) {
                    console.error('Swipe init error:', e);
                }
            }, 1000);
        });
        
        // Functions to update employee salaries (needed for inline oninput handlers)
        function updateEmployeeSalary(index, value) {
            const val = parseFloat(value) || 0;
            if (employees && employees[index] !== undefined) {
                employees[index].netMonthly = val;
                saveEmployeesToStorage();
                updateAllCalculations();
            }
        }
        
        function updateCustomEmployeeSalary(index, value) {
            const val = parseFloat(value) || 0;
            if (customEmployees && customEmployees[index] !== undefined) {
                customEmployees[index].netMonthly = val;
                saveCustomEmployeesToStorage();
                updateAllCalculations();
            }
        }
        
        // Expose all necessary functions to window before closing IIFE
        exposeGlobal('showTooltip', showTooltip);
        exposeGlobal('updateAllCalculations', updateAllCalculations);
        exposeGlobal('toggleMonth', toggleMonth);
        exposeGlobal('updateDayPlanning', updateDayPlanning);
        exposeGlobal('renderDayCell', renderDayCell);
        exposeGlobal('bulkSetDays', bulkSetDays);
        exposeGlobal('bulkSetOccupancy', bulkSetOccupancy);
        exposeGlobal('switchMode', switchMode);
        exposeGlobal('updateScenarioInputs', updateScenarioInputs);
        exposeGlobal('generateRandomMenu', generateRandomMenu);
        exposeGlobal('updateItemSelect', updateItemSelect);
        exposeGlobal('addItem', addItem);
        exposeGlobal('saveCurrentScenario', saveCurrentScenario);
        exposeGlobal('switchMenuTab', switchMenuTab);
        exposeGlobal('filterMenuItems', filterMenuItems);
        exposeGlobal('openAddProductModal', openAddProductModal);
        exposeGlobal('downloadMenuCSV', downloadMenuCSV);
        exposeGlobal('clearSelection', clearSelection);
        exposeGlobal('applyBulkPriceAdjustment', applyBulkPriceAdjustment);
        exposeGlobal('applyBulkCostAdjustment', applyBulkCostAdjustment);
        exposeGlobal('applyBulkMarginTarget', applyBulkMarginTarget);
        exposeGlobal('toggleEmployeeDetail', toggleEmployeeDetail);
        exposeGlobal('toggleCustomEmployeeDetail', toggleCustomEmployeeDetail);
        exposeGlobal('addNewEmployee', addNewEmployee);
        exposeGlobal('removeEmployee', removeEmployee);
        exposeGlobal('removeCustomEmployee', removeCustomEmployee);
        exposeGlobal('updateEmployeeName', updateEmployeeName);
        exposeGlobal('updateCustomEmployeeName', updateCustomEmployeeName);
        exposeGlobal('updateEmployeePuesto', updateEmployeePuesto);
        exposeGlobal('updateEmployeeHoras', updateEmployeeHoras);
        exposeGlobal('updateEmployeeIRPF', updateEmployeeIRPF);
        exposeGlobal('updateEmployeePluses', updateEmployeePluses);
        exposeGlobal('updateCustomEmployeePuesto', updateCustomEmployeePuesto);
        exposeGlobal('updateCustomEmployeeHoras', updateCustomEmployeeHoras);
        exposeGlobal('updateCustomEmployeeIRPF', updateCustomEmployeeIRPF);
        exposeGlobal('updateCustomEmployeePluses', updateCustomEmployeePluses);
        // Mantener compatibilidad con funciones antiguas (aunque ya no se usen)
        exposeGlobal('updateEmployeeSalary', updateEmployeeSalary);
        exposeGlobal('updateCustomEmployeeSalary', updateCustomEmployeeSalary);
        exposeGlobal('closeModal', closeModal);
        exposeGlobal('confirmModal', confirmModal);
        exposeGlobal('openModal', openModal);
        
        // Expose arrays globally so helper functions can access them
        window.employees = employees;
        window.customEmployees = customEmployees;
        
        })(); // End IIFE
    </script>
    <script>
        // Emergency fallback: Ensure tabs work even if main script fails
        (function() {
            if (typeof window.switchTab !== 'function') {
                window.switchTab = function(tabName, btn) {
                    var tabs = document.querySelectorAll('.tab-content');
                    for (var i = 0; i < tabs.length; i++) {
                        tabs[i].style.display = 'none';
                        tabs[i].classList.remove('active');
                    }
                    var tab = document.getElementById('tab-' + tabName);
                    if (tab) {
                        tab.style.display = 'block';
                        tab.classList.add('active');
                    }
                    var buttons = document.querySelectorAll('.tab-button');
                    for (var i = 0; i < buttons.length; i++) {
                        buttons[i].classList.remove('active');
                    }
                    if (btn) btn.classList.add('active');
                };
            }
            // Ensure first tab is visible
            setTimeout(function() {
                var first = document.getElementById('tab-planificacion');
                if (first && first.style.display === 'none') {
                    first.style.display = 'block';
                    first.classList.add('active');
                }
            }, 50);
            
            // Force render after a delay if nothing has rendered
            setTimeout(function() {
                var container = document.getElementById('planning-months-container');
                if (container && container.innerHTML.trim() === '') {
                    console.warn('Calendar container is empty, attempting to force render...');
                    if (typeof parseCalendarData === 'function') {
                        try {
                            parseCalendarData();
                        } catch(e) {
                            console.error('Error in parseCalendarData:', e);
                        }
                    }
                    if (typeof renderCalendar === 'function') {
                        try {
                            renderCalendar();
                        } catch(e) {
                            console.error('Error in renderCalendar:', e);
                        }
                    }
                }
            }, 2000);
        })();
    </script>
</body>
</html>
